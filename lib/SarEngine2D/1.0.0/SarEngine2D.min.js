window.SarEngine=function(){function Engine(){this.fps=0,this.animationFrameId=null,this.status=EngineStatus.NotRun,this.onStart=null,this.onUpdate=null,this.onPause=null,this.onResume=null,this.onEnd=null,this.onError=null;var engine=this,scene=null;Object.defineProperty(this,"scene",{get:function(){return scene},set:function(value){scene=value,scene.initEvents(scene.eventSource),scene.engine=engine}})}function Scene(){this.engine=null,this.objectList=ArrayList(),this._objList=ArrayList(),this.physics=new Scene.Physics,this.cameraList=ArrayList(),this.layers=new LayerCollection,this.collideGroups=new ArrayList,this.collideGroups.ignoreGroup=new CollideGroup,this.collideGroups.defaultGroup=new CollideGroup,this.collideTable=new Matrix(0,0),this.runtime=0,this.GUI=null,this.background=new BackgroundCollection(this),this.device=new Device,this.doubleClickDelay=200,this.onUpdate=null,this.onRender=null,this.onEndRender=null,this.eventSource=null,this.onMouseMove=null,this.onMouseOver=null,this.onMouseOut=null,this.onMouseDown=null,this.onMouseUp=null,this.onClick=null,this.onDoubleClick=null,this.onMouseWheel=null,this.onKeyDown=null,this.onKeyUp=null,this.onKeyPress=null,this.onTouchStart=null,this.onTouchMove=null,this.onTouchEnd=null,this.layers.scene=this,this.layers.add(new Layer,0)}function LayerCollection(){this.count=0,this.topDepth=NaN,this.bottomDepth=NaN,this.top=null,this.bottom=null,this.scene=null,this.depthList=ArrayList();var layerCollection=this;Object.defineProperty(this,"count",{get:function(){return layerCollection.depthList.length}})}function BackgroundCollection(scene){this.bgList=ArrayList(),this.scene=scene;var bgCollection=this;Object.defineProperty(this,"count",{get:function(){return bgCollection.bgList.length}})}function Coordinate(pTo,pFrom,vTo,vFrom){this.pTo=pTo,this.pFrom=pFrom,this.vTo=vTo,this.vFrom=vFrom,this.axis=null}function Layer(coordinate){coordinate||(coordinate=Coordinate.Default),this.coordinate=coordinate,this.objectList=ArrayList(),this.followCamera=!1,this.scene=null,this.onRender=null,this.onEndRender=null}function Background(){this.followSpeed=1,this.objectList=ArrayList(),this.scene=null,this.coordinate=Coordinate.Default.copy()}function ArrayList(){var list=[];return list.add=function(obj){return list[list.length]=obj,list.length-1},list.insert=function(obj,index){if(isNaN(index)||index<0)throw new Error("Invalid index.");for(var i=this.length-1;i>=index;i--)this[i+1]=this[i];this[index]=obj},list.removeAt=function(index){if(isNaN(index)||index<0||index>=list.length)throw new Error("Invalid index.");for(var i=index;i<list.length-1;i++)list[i]=list[i+1];list.length-=1},list.remove=function(obj){for(var i=0;i<list.length;i++)if(list[i]==obj){for(;i<list.length-1;i++)list[i]=list[i+1];return void(list.length-=1)}throw new Error("Object not found.")},list.clear=function(){list.length=0},list.addRange=function(arr,startIndex,count){startIndex&&!isNaN(startIndex)||(startIndex=0),count&&!isNaN(count)||(count=arr.length);for(var i=startIndex;i<count;i++)list[list.length]=arr[i]},list.contain=function(obj){return list.indexOf(obj)>=0},list}function Matrix(m,n){var rows=0,columns=0;this._innerMatrix=[];var matrix=this;if(Object.defineProperty(this,"rows",{get:function(){return rows},set:function(value){if(value<rows){for(var i=value;i<rows;i++)delete matrix[i];return matrix._innerMatrix.length=value,void(rows=value)}for(;rows<value;){matrix._innerMatrix[rows]=[];for(var i=0;i<columns;i++)matrix._innerMatrix[rows][i]=0;!function(index){Object.defineProperty(matrix,index,{configurable:!0,get:function(){return matrix._innerMatrix[index]}})}(rows),rows++}}}),Object.defineProperty(this,"columns",{get:function(){return columns},set:function(value){if(value<columns){for(var i=0;i<rows;i++)matrix._innerMatrix[i].length=value;columns=value}else if(columns<value){for(var i=0;i<rows;i++)for(var j=columns;j<value;j++)matrix._innerMatrix[i][j]=0;columns=value}}}),m instanceof Array){rows=m.length;for(var i=0;i<rows;i++){if(!(m[i]instanceof Array))throw new Error("Invalid Matrix.");if(matrix._innerMatrix[i]=[],0==i)columns=m[i].length;else if(columns!=m[i].length)throw new Error("Columns not same.");for(var j=0;j<columns;j++)matrix._innerMatrix[i][j]=m[i][j];!function(index){Object.defineProperty(matrix,index.toString(),{configurable:!0,get:function(){return matrix._innerMatrix[index]}})}(i)}}else if(!isNaN(m)&&!isNaN(n)){rows=m,columns=n;for(var i=0;i<m;i++){matrix._innerMatrix[i]=[];for(var j=0;j<n;j++)matrix._innerMatrix[i][j]=0;!function(index){Object.defineProperty(matrix,index.toString(),{configurable:!0,get:function(){return matrix._innerMatrix[index]}})}(i)}}}function Output(node,w,h){function applySize(){node.style.width=width+"px",node.style.height=height+"px"}function applyRenderSize(){node.width=renderWidth,node.height=renderHeight}function applySize(){for(var i=0;i<graphics.length;i++)graphics[i].canvas.style.width=width+"px",graphics[i].canvas.style.height=height+"px"}function applyRenderSize(){for(var i=0;i<graphics.length;i++)graphics[i].canvas.width=renderWidth,graphics[i].canvas.height=renderHeight}if(!(node instanceof Node))throw new Error("Cannot create a output by this object.");this.type=Output.OutputTypes.None,this.getLayer=function(){},this.setLayer=function(){},this.camera=null,this.layers=ArrayList(),this.audioTracks=ArrayList(),this.outputDOM=null,this.viewArea=null;var outputDom=null,graphics=null,width=0,height=0,renderWidth=0,renderHeight=0,seperateSize=!1;"CANVAS"==node.nodeName?(outputDom=node,this.outputDOM=node,this.type=Output.OutputTypes.Single,graphics=new Graphics(node),this.layers[0]=graphics,this.getLayer=function(){return graphics},isNaN(w)||isNaN(h)||(width=w,height=h,renderWidth=w,renderHeight=h,applySize(),applyRenderSize()),Object.defineProperty(this,"width",{get:function(){return width},set:function(value){width=value,seperateSize||(renderWidth=value,applyRenderSize()),applySize()}}),Object.defineProperty(this,"height",{get:function(){return height},set:function(value){height=value,seperateSize||(renderHeight=value,applyRenderSize()),applySize()}}),Object.defineProperty(this,"renderWidth",{get:function(){return renderWidth=node.width,node.width},set:function(value){renderWidth=value,seperateSize=!0,applyRenderSize()}}),Object.defineProperty(this,"renderHeight",{get:function(){return renderHeight=node.height,node.height},set:function(value){renderHeight=value,seperateSize=!0,applyRenderSize()}})):(node.innerHTML="",outputDom=node,this.outputDOM=node,"static"==getComputedStyle(outputDom).position&&(outputDom.style.position="relative"),this.type=Output.OutputTypes.MultiLayer,graphics=ArrayList(),this.layers=graphics,this.getLayer=function(z){return graphics.length<=0?null:(z>=graphics.length&&(z=graphics.length-1),z<0&&(z=0),graphics[z])},this.setLayer=function(count){var d=count-graphics.length;if(d<0)for(;d<0;d++){var node=graphics[i].canvas;node.remove(),graphics.removeAt(graphics.length-1)}else if(d>0)for(;d>0;d--){var canvas=document.createElement("canvas");canvas.width=renderWidth,canvas.height=renderHeight,canvas.style.width=width+"px",canvas.style.height=height+"px",canvas.style.position="absolute",canvas.style.left="0px",canvas.style.top="0px",canvas.style.backgroundColor="transparent",outputDom.appendChild(canvas);var i=graphics.add(new Graphics(canvas));canvas.style.zIndex=i}},isNaN(w)||isNaN(h)||(width=w,height=h,renderWidth=w,renderHeight=h,applySize(),applyRenderSize()),Object.defineProperty(this,"width",{get:function(){return width},set:function(value){width=value,seperateSize||(renderWidth=value,applyRenderSize()),applySize()}}),Object.defineProperty(this,"height",{get:function(){return height},set:function(value){height=value,seperateSize||(renderHeight=value,applyRenderSize()),applySize()}}),Object.defineProperty(this,"renderWidth",{get:function(){return renderWidth},set:function(value){renderWidth=value,seperateSize=!0,applyRenderSize()}}),Object.defineProperty(this,"renderHeight",{get:function(){return renderHeight},set:function(value){renderHeight=value,seperateSize=!0,applyRenderSize()}})),this._sizeChangeCallback=null,this._renderSizeChangeCallback=null}function CollideGroup(){this.objectList=ArrayList(),this.ignoreList=ArrayList()}function Camera(x,y){this.center=new Engine.Position(x,y),this.position=new Engine.Position(x,y),this.coordinate=Coordinate.Default,this.viewCoordinate=Coordinate.createCartesian(x,y,1,-1,0),this.width=0,this.height=0,this.graphics=null,this.outputList=ArrayList(),this.scene=null;var camera=this,zoom=1,rotation=0;Object.defineProperty(this,"zoom",{get:function(){return zoom},set:function(value){zoom=value,camera.viewCoordinate.unitX=1/zoom,camera.viewCoordinate.unitY=-1/zoom}}),Object.defineProperty(this,"rotation",{get:function(){return rotation},set:function(value){rotation=value,camera.viewCoordinate.rotation=rotation}}),this.position.changeCallback=function(e){var dx=e.x-camera.position.x,dy=e.y-camera.position.y;camera.center.x+=dx,camera.center.y+=dy,camera.viewCoordinate.originX+=dx,camera.viewCoordinate.originY+=dy}}function Audio(audio){function onEnd(){self.playing=!1}this.src=null,this.audio=null;var self=this;if(this.playing=!1,Object.defineProperty(this,"src",{get:function(){return self.audio.src},set:function(value){self.audio.src=value}}),Object.defineProperty(this,"duration",{get:function(){return self.audio.duration}}),Object.defineProperty(this,"complete",{get:function(){return 4==self.audio.readyState}}),Object.defineProperty(this,"currentTime",{get:function(){return self.audio?self.audio.currentTime:0},set:function(value){self.audio&&(self.audio.currentTim=value)}}),audio){if(audio instanceof Element){if("AUDIO"!=audio.nodeName)throw new Error("A audio Element/Url/Blob required.");this.audio=audio}else if("string"==typeof audio)this.audio=new window.Audio(audio);else if(audio instanceof Blob){var src=URL.createObjectURL(audio);this.audio=new window.Audio(src)}else this.audio=new window.Audio;this.audio.addEventListener("ended",onEnd)}}function AudioTrack(audio){function onEnded(){audioTrack.playing=!1,audioTrack.onEnd&&audioTrack.onEnd()}var _audio=null;this.time=0,this.playing=!1,this.output=null,this.audioElement=null;var audioTrack=this;this.onEnd=null,Object.defineProperty(this,"audio",{get:function(){return _audio},set:function(value){if(!(value instanceof Engine.Audio))throw new Error("A object of SarEngine.Audio required.");_audio=value,audioTrack.audioElement=new window.Audio(value.src),audioTrack.audioElement.addEventListener("ended",onEnded)}}),Object.defineProperty(this,"currentTime",{get:function(){return audioTrack.audioElement?audioTrack.audioElement.currentTime:0},set:function(value){audioTrack.audioElement&&(audioTrack.audioElement.currentTime=value)}}),Object.defineProperty(this,"duration",{get:function(){return audioTrack.audio.duration}}),audio instanceof Engine.Audio&&(this.audio=audio)}function Graphics(canvas){if(!canvas)throw new Error("paramter error.");if(!canvas.getContext)throw new Error("paramter 1 must be a canvas");this.canvas=canvas,this.ctx=canvas.getContext("2d"),this.o=new Point(0,0),this.zoom=0,this.rotation=0,this.kx=1,this.ky=1,this.kw=1,this.kh=1,this.fillStyle="#000000",this.strokeStyle="#000000",this.shadowColor="#000000",this.shadowBlur="#000000",this.shadowOffsetX=0,this.shadowOffsetY=0,this.lineCap="butt",this.lineJoin="miter",this.miterLimit=10,this.font=new Font("sans-serif","10px"),this.textAlign=TextAlign.Start,this.textBaseline=TextBaseline.Alphabetic,this.globalAlpha=1;var globalCompositeOperation="source-over",_graphics=this,lineWidth=1;Object.defineProperty(this,"width",{get:function(){return _graphics.canvas.width},set:function(value){_graphics.canvas.width=value}}),Object.defineProperty(this,"height",{get:function(){return _graphics.canvas.height},set:function(value){_graphics.canvas.height=value}}),Object.defineProperty(this,"strokeWidth",{get:function(){return lineWidth},set:function(value){lineWidth=value,_graphics.ctx.lineWidth=value}}),Object.defineProperty(this,"lineWidth",{get:function(){return lineWidth},set:function(value){lineWidth=value,_graphics.ctx.lineWidth=value}}),Object.defineProperty(this,"globalCompositeOperation",{get:function(){return globalCompositeOperation},set:function(value){globalCompositeOperation=value,_graphics.ctx.globalCompositeOperation=value}})}function Color(r,g,b,a){r=parseInt(r),g=parseInt(g),b=parseInt(b),isNaN(r)||r>=256?r=255:r<0&&(r=0),isNaN(g)||g>=256?g=255:g<0&&(g=0),isNaN(b)||b>=256?b=255:b<0&&(b=0),isNaN(a)||a>1?a=1:a<0&&(a=0),this.red=r,this.green=g,this.blue=b,this.alpha=a}function LinkList(){this.head=null,this.tail=null,this.count=0}function Align(){}function Force(x,y,f){if(this.x=0,this.y=0,void 0!=x)if(x instanceof Vector2)this.x=x.x,this.y=x.y;else if(f){var l=Math.sqrt(x*x+y*y);this.x=x*f/l,this.y=y*f/l}else this.x=x,this.y=y}function Mouse(){this.x=0,this.y=0,this.dx=0,this.dy=0,this.left=Mouse.ButtonState.None,this.right=Mouse.ButtonState.None,this.wheel=Mouse.ButtonState.None}function MouseEventArgs(){this.x=0,this.y=0,this.dx=0,this.dy=0,this.wheelDelta=0,this.button=null,this.buttonState=Mouse.ButtonState.None,this.handled=!1}function Touch(){this.x=0,this.y=0,this.dx=0,this.dy=0,this.type=Touch.Types.None,this.id=0}function TouchEventArgs(){this.x=0,this.y=0,this.dx=0,this.dy=0,this.type=Touch.Types.None,this.touches=null,this.id=0,this.handled=!1}function Keyboard(){this.keys=[],this.keys[8]=Keyboard.KeyState.None,this.keys[9]=Keyboard.KeyState.None,this.keys[12]=Keyboard.KeyState.None,this.keys[13]=Keyboard.KeyState.None,this.keys[16]=Keyboard.KeyState.None,this.keys[17]=Keyboard.KeyState.None,this.keys[18]=Keyboard.KeyState.None,this.keys[19]=Keyboard.KeyState.None,this.keys[20]=Keyboard.KeyState.None,this.keys[27]=Keyboard.KeyState.None,this.keys[32]=Keyboard.KeyState.None,this.keys[33]=Keyboard.KeyState.None,this.keys[34]=Keyboard.KeyState.None,this.keys[35]=Keyboard.KeyState.None,this.keys[36]=Keyboard.KeyState.None,this.keys[37]=Keyboard.KeyState.None,this.keys[38]=Keyboard.KeyState.None,this.keys[39]=Keyboard.KeyState.None,this.keys[40]=Keyboard.KeyState.None,this.keys[41]=Keyboard.KeyState.None,this.keys[42]=Keyboard.KeyState.None,this.keys[43]=Keyboard.KeyState.None,this.keys[45]=Keyboard.KeyState.None,this.keys[46]=Keyboard.KeyState.None,this.keys[47]=Keyboard.KeyState.None,this.keys[48]=Keyboard.KeyState.None,this.keys[49]=Keyboard.KeyState.None,this.keys[50]=Keyboard.KeyState.None,this.keys[51]=Keyboard.KeyState.None,this.keys[52]=Keyboard.KeyState.None,this.keys[53]=Keyboard.KeyState.None,this.keys[54]=Keyboard.KeyState.None,this.keys[55]=Keyboard.KeyState.None,this.keys[56]=Keyboard.KeyState.None,this.keys[57]=Keyboard.KeyState.None,this.keys[65]=Keyboard.KeyState.None,this.keys[66]=Keyboard.KeyState.None,this.keys[67]=Keyboard.KeyState.None,this.keys[68]=Keyboard.KeyState.None,this.keys[69]=Keyboard.KeyState.None,this.keys[70]=Keyboard.KeyState.None,this.keys[71]=Keyboard.KeyState.None,this.keys[72]=Keyboard.KeyState.None,this.keys[73]=Keyboard.KeyState.None,this.keys[74]=Keyboard.KeyState.None,this.keys[75]=Keyboard.KeyState.None,this.keys[76]=Keyboard.KeyState.None,this.keys[77]=Keyboard.KeyState.None,this.keys[78]=Keyboard.KeyState.None,this.keys[79]=Keyboard.KeyState.None,this.keys[80]=Keyboard.KeyState.None,this.keys[81]=Keyboard.KeyState.None,this.keys[82]=Keyboard.KeyState.None,this.keys[83]=Keyboard.KeyState.None,this.keys[84]=Keyboard.KeyState.None,this.keys[85]=Keyboard.KeyState.None,this.keys[86]=Keyboard.KeyState.None,this.keys[87]=Keyboard.KeyState.None,this.keys[88]=Keyboard.KeyState.None,this.keys[89]=Keyboard.KeyState.None,this.keys[90]=Keyboard.KeyState.None,this.keys[96]=Keyboard.KeyState.None,this.keys[97]=Keyboard.KeyState.None,this.keys[98]=Keyboard.KeyState.None,this.keys[99]=Keyboard.KeyState.None,this.keys[100]=Keyboard.KeyState.None,this.keys[101]=Keyboard.KeyState.None,this.keys[102]=Keyboard.KeyState.None,this.keys[103]=Keyboard.KeyState.None,this.keys[104]=Keyboard.KeyState.None,this.keys[105]=Keyboard.KeyState.None,this.keys[106]=Keyboard.KeyState.None,this.keys[107]=Keyboard.KeyState.None,this.keys[108]=Keyboard.KeyState.None,this.keys[109]=Keyboard.KeyState.None,this.keys[110]=Keyboard.KeyState.None,this.keys[111]=Keyboard.KeyState.None,this.keys[112]=Keyboard.KeyState.None,this.keys[113]=Keyboard.KeyState.None,this.keys[114]=Keyboard.KeyState.None,this.keys[115]=Keyboard.KeyState.None,this.keys[116]=Keyboard.KeyState.None,this.keys[117]=Keyboard.KeyState.None,this.keys[118]=Keyboard.KeyState.None,this.keys[119]=Keyboard.KeyState.None,this.keys[120]=Keyboard.KeyState.None,this.keys[121]=Keyboard.KeyState.None,this.keys[122]=Keyboard.KeyState.None,this.keys[123]=Keyboard.KeyState.None,this.keys[124]=Keyboard.KeyState.None,this.keys[125]=Keyboard.KeyState.None,this.keys[126]=Keyboard.KeyState.None,this.keys[127]=Keyboard.KeyState.None,this.keys[128]=Keyboard.KeyState.None,this.keys[129]=Keyboard.KeyState.None,this.keys[130]=Keyboard.KeyState.None,this.keys[131]=Keyboard.KeyState.None,this.keys[132]=Keyboard.KeyState.None,this.keys[133]=Keyboard.KeyState.None,this.keys[134]=Keyboard.KeyState.None,this.keys[135]=Keyboard.KeyState.None,this.keys[136]=Keyboard.KeyState.None,this.keys[137]=Keyboard.KeyState.None}function KeyEventArgs(){this.key=0,this.keyName="Unknown",this.keyState=Keyboard.KeyState.None,this.ctrl=!1,this.alt=!1,this.shift=!1,this.handled=!1}function Device(){this.mouse=new Mouse,this.keyboard=new Keyboard,this.touches=[],this.touches.add=function(touch){this[this.length]=touch},this.touches.id=function(id){for(var i=0;i<this.length;i++)if(this[i].id==id)return this[i];throw new Error("Id not available.")},this.touches.removeId=function(id){for(var i=0;i<this.length;i++)if(this[i].id==id)for(var j=i+1;j<this.length;j++)this[j-1]=this[j]},this.touches.remove=function(index){for(var j=index+1;j<this.length;j++)this[j-1]=this[j]}}function int(x){return parseInt(x)}function sign(x){return x>0?1:x<0?-1:0}function Vector2(x,y){this.x=x,this.y=y,this.coordinate=Coordinate.Default}function Point(x,y){if(isNaN(x)||isNaN(y))throw"x and y must be numbers.";this.x=x,this.y=y,this.coordinate=Coordinate.Default}function Position(x,y){this.onChange=null,this.changeCallback=null,this.coordinate=Coordinate.Default,this.innerX=x,this.innerY=y;var position=this;Object.defineProperty(this,"x",{get:function(){return position.innerX},set:function(value){position.onChange&&(args={changed:"y",x:value,y:position.innerY,cancle:!1},position.onChange(args),args.cancle)||position.changeCallback&&(args={changed:"y",x:value,y:position.innerY,cancle:!1},position.changeCallback(args),args.cancle)||(position.innerX=value)}}),Object.defineProperty(this,"y",{get:function(){return position.innerY},set:function(value){position.onChange&&(args={changed:"y",x:position.innerX,y:value,cancle:!1},position.onChange(args),args.cancle)||position.changeCallback&&(args={changed:"y",x:position.innerX,y:value,cancle:!1},position.changeCallback(args),args.cancle)||(position.innerY=value)}})}function Line(_p1,_p2){var p1=_p1,p2=_p2;_p1 instanceof Vector2&&_p2 instanceof Vector2&&(p1=new Point(_p1.x,_p1.y,this),p2=new Point(_p2.x,_p2.y,this)),this.p1=p1,this.p2=p2,this.center=new Point((p1.x+p2.x)/2,(p1.y+p2.y)/2),this.position=new Point((p1.x+p2.x)/2,(p1.y+p2.y)/2),this.coordinate=Coordinate.Default,this.strokeStyle=new Color(0,0,0,1),this.strokeWidth=1}function Arc(r,startAng,endAng,antiCW){this.o=new Point(0,0),this.position=new Point(0,0),this.coordinate=Coordinate.Default,this.r=r,this.start=startAng,this.end=endAng,this.antiCW=antiCW,this.strokeStyle=new Color(0,0,0,1),this.fillStyle=new Color(255,255,255,0),this.strokeWidth=1,this.lineCap=Graphics.LineCap.Square}function Font(fontFamily,fontSize){fontFamily=fontFamily?fontFamily:"sans-serif",fontSize=fontSize||0==fontSize?fontSize:"10px",this.fontFamily=fontFamily,this.fontSize=fontSize,this.fontStyle=FontStyle.Normal,this.fontVariant=FontVariant.Normal,this.fontWeight=FontWeight.Normal,this.caption="",this.icon="",this.menu="",this.messageBox="",this.smallCaption="",this.statusBar=""}function FontStyle(){}function FontVariant(){}function FontWeight(){}function TextAlign(){}function TextBaseline(){}function Text(text){this.text=text,this.font=new Font("sans-serif",16),this.position=new Point(0,0),this.coordinate=Coordinate.Default,this.center=new Point(0,0),this.fillStyle=new Color(0,0,0,1),this.strokeStyle=new Color(255,255,255,0),this.onRender=null}function Image(img){img||(img=new window.Image),this.img=img,this.position=new Position(0,0),this.center=new Position(0,0),this.coordinate=Coordinate.Default,this.o=new Point(0,0),this.rotation=0,this.onRender=null;var obj=this;this.setPosition(0,0),Object.defineProperty(this,"width",{get:function(){return obj.img.width},set:function(value){obj.img.width=value}}),Object.defineProperty(this,"height",{get:function(){return obj.img.height},set:function(value){obj.img.height=value}})}function Path(){this.pList=function(){var list=[];return list.add=function(p){list[list.length]=p},list.remove=function(index){for(var i=index+1;i<list.length;i++)list[i-1]=list[i];list.pop()},list.clear=function(){for(;list.length;)list.pop()},list.last=function(){return list[list.length-1]},list}(),this.position=new Point(0,0),this.coordinate=Coordinate.Default,this.center=this.position,this.strokeStyle=new Color(0,0,0,1),this.fillStyle=new Color(255,255,255,1),this.strokeWidth=1}function Combination(){this.objectList=ArrayList(),this.position=new Point(0,0),this.center=new Point(0,0),this.rotation=0,this.coordinate=Coordinate.Default}function ImageAnimation(){this.center=new Point(0,0),this.position=this.center.copy(),this.coordinate=Coordinate.Default,this.fCount=0,this.fps=0,this.clipX=0,this.clipY=0,this.fWidth=0,this.fHeight=0,this.time=0,this.img=null,this.frame=0,this.playing=!0,this.reverse=!1,this.width=0,this.heigh=0,this.onBegine=null,this.onEnd=null,this.onFrameUpdate=null,this.loop=new ImageAnimation.Loop}function GameObject(){this.id=-1,this.name="GameObject",this.graphic=null,this.collider=null,this.collideGroups=ArrayList(),this.animationCallbackList=ArrayList(),this.links=ArrayList(),this.lifeTime=0,this.layer=null,this.zIndex=0,this.mass=1,this.gravity=!1,this.onGround=!1,this.hitTest=!1,this.F=new Force(0,0),this.constantForce=new Force(0,0),this.v=new Vector2(0,0),this.angV=0,this.a=new Vector2(0,0),this.position=new Position(0,0),this.center=new Position(0,0),this.rotation=0,this.coordinate=Engine.Coordinate.Default,this.onRender=null,this.onUpdate=null,this.onStart=null,this.onCollide=null,this.onCollideSimulate=null,this.onMouseDown=null,this.onMouseUp=null,this.onClick=null,this.onDoubleClick=null;this.setPosition(0,0)}function Colliders(){}function Particle(){this.size=1,this.color=new Color(0,0,0,1),this.v=new Vector2(0,0),this.position=new Point(0,0),this.center=new Point(0,0),this.o=new Point(0,0),this.rotation=0,this.coordinate=Coordinate.Default}function Circle(r){r||(r=0),this.r=r,this.o=new Point(0,0),this.position=new Point(0,0),this.center=this.position,this.angV=0,this.rotation=0,this.coordinate=Coordinate.Default,this.rigidBody=!1,this.e=1,this.I=1,this.dff=0,this["static"]=!1,this.soft=!0,this.landed=!1,this.strokeWidth=1,this.strokeStyle=new Color(0,0,0,1),this.fillStyle=new Color(255,255,255,1)}function Polygon(v){if(this.E=[],this.V=[],this.position=new Point(0,0),this.center=this.position,this.e=1,this.dff=0,this.angV=0,this.rotation=0,this.coordinate=Coordinate.Default,this.I=1,this.rigidBody=!1,this["static"]=!1,this.soft=!0,this.landed=!1,this.convex=!0,this.cw=null,this.constructing=!1,this.strokeWidth=1,this.strokeStyle=new Color(0,0,0,1),this.fillStyle=new Color(255,255,255,1),v instanceof Array){this.beginInit();for(var i=0;i<v.length;i++)this.addPoint(v[i]);this.endInit()}}function Rectangle(w,h){w=isNaN(w)?0:w,h=isNaN(h)?0:h,this.width=w,this.height=h,this.o=new Point(-w/2,-h/2),this.position=new Point(0,0),this.coordinate=Coordinate.Default,this.center=new Point(0,0),this.rigidBody=!1,this.dff=0,this.e=1,this.I=1,this["static"]=!1,this.soft=!0,this.landed=!1,this.fillStyle=new Color(255,255,255,1),this.strokeStyle=new Color(0,0,0,1),this.V=[new Point(-w/2,h/2),new Point(w/2,h/2),new Point(w/2,-h/2),new Point(-w/2,-h/2)],this.E=[new Line(this.V[0],this.V[1]),new Line(this.V[1],this.V[2]),new Line(this.V[2],this.V[3]),new Line(this.V[3],this.V[0])];for(var i=0;i<4;i++){var p=this.V[i];p.norV=new Vector2(p.x-this.center.x,p.y-this.center.y),p.tanV=new Vector2(-p.norV.y,p.norV.x),p.polygon=this;var l=this.E[i];l.p1.lines||(l.p1.lines=[]),l.p2.lines||(l.p2.lines=[]),l.p1.lines[l.p1.lines.length]=l,l.p2.lines[l.p2.lines.length]=l,l.polygon=this}this.E[0].length=w,this.E[1].length=h,this.E[2].length=w,this.E[3].length=h,this.E[0].norV=new Vector2(0,1),this.E[1].norV=new Vector2(1,0),this.E[2].norV=new Vector2(0,-1),this.E[3].norV=new Vector2(-1,0),this.E[0].tanV=new Vector2(1,0),this.E[1].tanV=new Vector2(0,-1),this.E[2].tanV=new Vector2(-1,0),this.E[3].tanV=new Vector2(0,1)}function Ground(y,xL,xR){xL=isNaN(xL)?0:xL,xR=isNaN(xR)?Number.MAX_SAFE_INTEGER:xR,this.position=new Point(xL,y),this.y=y,this.width=xR-xL,this.xL=xL,this.xR=xR,this["static"]=!0,this.rigidBody=!0}function Wall(x,yL,yH){yL=isNaN(yL)?0:yL,yH=isNaN(yH)?Number.MAX_SAFE_INTEGER:yH,this.x=x,this.height=yH-yL,this.yL=yL,this.yH=yH,this["static"]=!0,this.rigidBody=!0,this.position=new Point(x,yL)}function LinkList(){this.head=null,this.tail=null,this.count=0}function Color(r,g,b,a){r=parseInt(r),g=parseInt(g),b=parseInt(b),isNaN(r)||r>=256?r=255:r<0&&(r=0),isNaN(g)||g>=256?g=255:g<0&&(g=0),isNaN(b)||b>=256?b=255:b<0&&(b=0),isNaN(a)||a>1?a=1:a<0&&(a=0),this.red=r,this.green=g,this.blue=b,this.alpha=a}function Thickness(top,bottom,left,right){isNaN(top)?top=bottom=left=right=0:isNaN(bottom)&&(bottom=left=right=top),this.top=top,this.bottom=bottom,this.left=left,this.right=right}function GUI(){this.scene=null,this.children=new LinkList,this.width=0,this.height=0,this.x=0,this.y=0,this.color=new Color(0,0,0,1),this.bgColor=new Color(0,0,0,0),this.onRender=null,this.onMouseDown=null,this.onMouseUp=null,this.onMouseMove=null,this.onClick=null,this.onDoubleClick=null,this.onTouchStart=null,this.onTouchEnd=null,this.onTouchMove=null}function Block(width,height){this.children=new LinkList,this.parent=null,this.widthAuto=!1,this.heightAuto=!0,isNaN(width)&&(width=0,this.widthAuto=!0),isNaN(height)&&(height=0,this.heightAuto=!0),this.width=width,this.height=height,this.x=0,this.y=0,this.margin=new Thickness(0),this.padding=new Thickness(0),this.horAlign=HorAlign.Left,this.verAlign=VerAlign.Top,this.color=null,this.bgColor=null,this.border=1,this.font=new Font,this.collider=null,this.onClick=null,this.onMouseDown=null,this.onMouseUp=null,this.onMouseMove=null,this.onTouchStart=null,this.onTouchEnd=null,this.onTouchMove=null}function Button(content){content||(content="button"),this.parent=null,this.content=content,this.width=0,this.widthAuto=!0,this.height=0,this.heightAuto=!0,this.x=0,this.y=0,this.margin=new Thickness(0),this.padding=new Thickness(0),this.horAlign=HorAlign.Left,this.verAlign=VerAlign.Top,this.color=new Color(0,0,0,1),this.bgColor=new Color(0,0,0,0),this.border=1,this.radius=5,this.font=new Font,this.collider=null,this.onRender=null,this.onClick=null,this.onDoubleClick=null,this.onMouseMove=null,this.onMouseDown=null,this.onMouseUp=null,this.onMouseMove=null,this.onTouchStart=null,this.onTouchEnd=null,this.onTouchMove=null,this.isPressed=!1}function TextBlock(text){text||(text="textBlock"),this.parent=null,this.text=text,this.width=0,this.widthAuto=!0,this.height=0,this.heightAuto=!0,this.x=0,this.y=0,this.margin=new Thickness(0),this.padding=new Thickness(0),this.horAlign=HorAlign.Left,this.verAlign=VerAlign.Top,this.color=new Color(0,0,0,1),this.borderColor=new Color(0,0,0,1),this.bgColor=new Color(0,0,0,0),this.border=new Thickness(0,0,0,0),this.font=new Font,this.collider=null,this.onRender=null,this.onClick=null,this.onMouseDown=null,this.onMouseUp=null,this.onMouseMove=null,this.onTouchStart=null,this.onTouchEnd=null,this.onTouchMove=null}function Joystick(){this.margin=new Thickness(0),this.padding=new Thickness(0),this.horAlign=HorAlign.Left,this.verAlign=VerAlign.Top,this.width=0,this.height=0,this.content="",this.color=new Color(0,0,0,1),this.bgColor=new Color(0,0,0,0),this.border=1,this.font=new Font,this.onClick=null}window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,Engine.Version=.5,Engine.createByCanvas=function(canvas,width,height){var engine=new Engine,output=new Output(canvas,width,height),scene=new Scene;scene.eventSource=output,engine.scene=scene;var camera=new Camera(0,0,0,0,1);return camera.addOutput(output),scene.addCamera(camera),engine},Engine.createInNode=function(node,width,height){var engine=new Engine,output=new Output(node,width,height),scene=new Scene;scene.eventSource=output,engine.scene=scene;var camera=new Camera(0,0,0,0,1);return camera.addOutput(output),scene.addCamera(camera),engine},Engine.prototype.start=function(){function animationFrame(delay){if(engine.status==EngineStatus.Starting){if(engine.status=EngineStatus.Running,engine.onStart){var args={cancel:!1,handled:!1};if(engine.onStart(args),args.cancel)return void(engine.status=EngineStatus.NotRun)}return void(engine.animationFrameId=requestAnimationFrame(animationFrame))}if(engine.status==EngineStatus.Pausing){if(!engine.onPause)return void(engine.status=EngineStatus.Paused);var args={cancel:!1,handled:!1};if(engine.onPause(args),!args.cancel)return void(engine.status=EngineStatus.Paused);engine.status=EngineStatus.Running}else{if(engine.status==EngineStatus.Resuming){if(engine.onResume){var args={cancel:!1,handled:!1};if(engine.onResume(args),args.cancel)return void(engine.status=EngineStatus.Paused)}return engine.status=EngineStatus.Running,void(engine.animationFrameId=requestAnimationFrame(animationFrame))}if(engine.status==EngineStatus.Ending){if(!engine.onEnd)return void(engine.status=EngineStatus.NotRun);var args={cancel:!1,handled:!1};if(engine.onEnd(args),args.cancel)engine.status=EngineStatus.Running;else if(engine.status==EngineStatus.Ending)return void(engine.status=EngineStatus.NotRun)}}var x=delay;delay=13,lastDelay=x,engine.onUpdate&&engine.onUpdate(delay,engine),engine.scene.updateFrame(delay),engine.animationFrameId=requestAnimationFrame(animationFrame)}var engine=this;this.status=EngineStatus.Starting;var lastDelay=0;return this.end=function(){if(engine.status==EngineStatus.NotRun)throw new Error("Game not run.");engine.status=EngineStatus.Ending},this.pause=function(){if(engine.status!=EngineStatus.Running&&engine.status!=EngineStatus.Resuming&&engine.status!=EngineStatus.Starting)throw engine.status==EngineStatus.NotRun?new Error("Game not run."):new Error("Pause invailable.");engine.status=EngineStatus.Pausing},this.resume=function(){if(engine.status!=EngineStatus.Paused)throw new Error("Game not paused");engine.status=EngineStatus.Resuming,engine.animationFrameId=requestAnimationFrame(animationFrame)},!!this.scene&&(this.animationFrameId=requestAnimationFrame(animationFrame),void(this.status=EngineStatus.Starting))},Engine.prototype.end=function(){throw new Error("Game not run.")},Engine.prototype.pause=function(){throw new Error("Game not run.")},Engine.prototype.resume=function(){throw new Error("Game not run.")};var EngineStatus={NotRun:1,Running:2,Paused:4,Starting:3,Pausing:6,Resuming:7,Ending:5};Engine.EngineStatus=EngineStatus,window.EngineStatus=EngineStatus,LayerCollection.prototype.add=function(layer,depth){if(layer.scene)throw new Error("This Layer has belong to another Scene.");if(isNaN(depth)||this[depth])throw new Error("Invalid depth.");if(layer.scene=this.scene,this[depth]=layer,0==this.count)this.topDepth=depth,
this.top=layer,this.bottomDepth=depth,this.bottom=layer,this.depthList[0]=depth;else if(depth<this.depthList[0])this.bottomDepth=depth,this.bottom=layer,this.depthList.insert(depth,0);else if(this.depthList[this.depthList.length-1]<depth)this.topDepth=depth,this.top=layer,this.depthList[this.depthList.length]=depth;else for(var i=0;i<this.depthList.length;i++)if(depth<this.depthList[i]){this.depthList.insert(depth,i);break}for(var i=0;i<this.scene.cameraList.length;i++)for(var camera=this.scene.cameraList[i],j=0;j<camera.outputList.length;j++)camera.outputList[j].setLayer(this.count+this.scene.background.count)},LayerCollection.prototype.removeAt=function(depth){if(!this[depth])throw new Error("There is not a Layer at "+depth);var layer=this[depth];this[depth]=null,this.depthList.remove(depth),this.depthList.length>0?(this.topDepth=this.depthList[this.depthList.length-1],this.top=this[this.topDepth],this.bottomDepth=this.depthList[0],this.bottom=this[this.bottomDepth]):(this.topDepth=NaN,this.top=null,this.bottomDepth=NaN,this.bottomDepth=null);for(var camera=this.scene.cameraList[i],j=0;j<camera.outputList.length;j++)camera.outputList[j].setLayer(this.count+this.scene.background.count);return layer},Scene.LayerCollection=LayerCollection,BackgroundCollection.prototype.add=function(bg,zIndex){if(!bg)throw new Error("Give me a Background please!");if(!this.scene)throw new Error("Are you kidding me?");if(bg.scene)throw new Error("Existed.");bg.scene=this.scene,isNaN(zIndex)&&(zIndex=this.bgList.length),zIndex<0&&(zIndex=0),this.bgList.insert(bg,zIndex);for(var i=0;i<this.scene.cameraList;i++)for(var j=0;j<this.scene.cameraList[i].outputList.length;j++){var output=this.scene.cameraList[i].outputList[j];output.setLayer(this.count+this.scene.layers.count)}var bgCollection=this;!function(index){Object.defineProperty(bgCollection,index,{configurable:!0,get:function(){return bgCollection.bgList[index]}})}(this.count-1)},BackgroundCollection.prototype.remove=function(bg){if(!bg)throw new Error("Give me a Background please!");if(!this.scene)throw new Error("Are you kidding me?");var index=this.bgList.indexOf(ob);if(index<0)return!1;this.bgList.removeAt(index);for(var i=0;i<this.scene.cameraList;i++)for(var j=0;j<this.scene.cameraList[i].outputList.length;j++){var output=this.scene.cameraList[i].outputList[j];output.setLayer(this.count+this.scene.layers.count)}delete this[this.count]},Scene.BackgroundCollection=BackgroundCollection,Scene.Physics=function(){this.g=new Vector2(0,0),this.f=0},Scene.Physics.prototype.copy=function(){var phy=new Scene.Physics;return phy.g=this.g.copy(),phy.f=this.f,phy},Scene.Physics.prototype.reset=function(){this.g=new Vector2(0,0),this.f=0},Scene.prototype.reset=function(){this.camera=null,this.objectList=ArrayList(),this._objList=ArrayList(),this.physics&&this.physics.reset()},Scene.prototype.physicalSimulate=function(dt){for(var scene=this,useGroup=!0,d=0;d<this.layers.depthList.length;d++){for(var objectList=this.layers[this.layers.depthList[d]].objectList,i=0;i<objectList.length;i++){var obj=this.layers[this.layers.depthList[d]].objectList[i];if(obj.a.x=(obj.F.x+obj.constantForce.x)/obj.mass,obj.a.y=(obj.F.y+obj.constantForce.y)/obj.mass,!obj.gravity||obj.collider&&obj.collider.landed||(obj.a.x+=scene.physics.g.x,obj.a.y+=scene.physics.g.y),obj.moveTo(obj.position.x+obj.v.x*dt+.5*obj.a.x*dt*dt,obj.position.y+obj.v.y*dt+.5*obj.a.y*dt*dt),obj.v.x+=obj.a.x*dt,obj.v.y+=obj.a.y*dt,obj.collider&&obj.collider.angV){var w=obj.collider.angV,ang=w*dt;obj.rotate(ang,obj.collide.center.x,obj.collide.center.y)}if(obj.angV){var w=obj.angV,ang=w*dt;obj.rotate(ang)}obj.resetForce(),obj.collider&&(obj.collider.landed=!1)}if(!useGroup)for(var i=0;i<objectList.length;i++){var obj=this.layers[this.layers.depthList[d]].objectList[i];if(obj.collider&&obj.collider.rigidBody)for(var j=i+1;j<objectList.length;j++){var target=objectList[j];target.collider&&target.collider.rigidBody&&obj.collider.isCollideWith(target.collider)&&obj.collider.collide(obj,target,dt)}}}for(var i=0;i<this.collideGroups.defaultGroup.objectList.length;i++){var obj1=this.collideGroups.defaultGroup.objectList[i];if(obj1.collider)for(var group2=0;group2<this.collideGroups.length;group2++)for(var j=0;j<this.collideGroups[group2].objectList.length;j++){var obj2=this.collideGroups[group2].objectList[j];if(obj1!=obj2&&obj1.layer.coordinate==obj2.layer.coordinate&&!(obj1.id<0||obj2.id<0)&&this.collideTable[obj1.id][obj2.id]!=this.runtime&&obj2.collider&&(this.collideTable[obj1.id][obj2.id]=this.collideTable[obj2.id][obj1.id]=this.runtime,obj1.collider.isCollideWith(obj2.collider,obj1.v,obj2.v,dt))){if(obj1.onCollide){var args={target:obj2};obj1.onCollide(args)}if(obj2.onCollide){var args={target:obj1};obj2.onCollide(args)}obj1.collider.collide(obj1,obj2,dt)}}}for(var group1=0;group1<this.collideGroups.length;group1++)for(var i=0;i<this.collideGroups[group1].objectList.length;i++){var obj1=this.collideGroups[group1].objectList[i];if(obj1.collider)for(var group2=0;group2<this.collideGroups.length;group2++)if(group1!=group2&&!this.collideGroups[group1].ignoreList.contain(this.collideGroups[group2]))for(var j=0;j<this.collideGroups[group2].objectList.length;j++){var obj2=this.collideGroups[group2].objectList[j];if(obj1!=obj2&&obj1.layer.coordinate==obj2.layer.coordinate&&!(obj1.id<0||obj2.id<0)&&this.collideTable[obj1.id][obj2.id]!=this.runtime&&obj2.collider&&(this.collideTable[obj1.id][obj2.id]=this.collideTable[obj2.id][obj1.id]=this.runtime,obj1.collider.isCollideWith(obj2.collider,obj1.v,obj2.v,dt))){if(obj1.onCollide){var args={target:obj2};obj1.onCollide(args)}if(obj2.onCollide){var args={target:obj1};obj2.onCollide(args)}obj1.collider.collide(obj1,obj2,dt)}}}},Scene.prototype.render=function(dt){var scene=this;if(this.cameraList.length){if(scene.onRender){var args={dt:dt,cancel:!1};if(scene.onRender(args),args.cancel)return}for(var i=0;i<this.cameraList.length;i++)this.cameraList[i].clear(),this.cameraList[i].render(dt);this.onEndRender&&this.onEndRender()}},Scene.prototype.updateFrame=function(delay){var scene=this;this.runtime+=delay;var dt=delay/1e3;if(!scene.onUpdate||(args={dt:dt,cancle:!1},scene.onUpdate(args),!args.cancle)){for(var i=0;i<this.objectList.length;i++){var obj=this.objectList[i];if(obj.lifeTime+=delay,obj.deleted)return;obj.onUpdate&&obj.onUpdate(obj,dt);for(var j=0;this.objectList[i]&&j<this.objectList[i].animationCallbackList.length;j++)this.objectList[i].animationCallbackList[j](dt)}var whileRender=!0;this.render(dt),whileRender=!1,this.physicalSimulate(dt)}},Scene.prototype.initEvents=function(output){function mouseMoveCallback(e){var mapTo=output.camera.map(e.pageX,e.pageY,output,Coordinate.Default);scene.device.mouse.dx=mapTo.x-scene.device.mouse.x,scene.device.mouse.dy=mapTo.y-scene.device.mouse.y,scene.device.mouse.x=mapTo.x,scene.device.mouse.y=mapTo.y;var args=new MouseEventArgs;args.button=e.button,args.buttonState=Mouse.ButtonState.None,args.handled=!1,args.x=e.pageX,args.y=e.pageY,scene.GUI&&scene.GUI.mouseMoveCallback(e),args.handled||(args.x=mapTo.x,args.y=mapTo.y,scene.onMouseMove&&scene.onMouseMove(args))}function mouseOverCallback(e){var args=new MouseEventArgs;args.x=output.camera.map(e.pageX,e.pageY,output,Coordinate.Default).x,args.y=output.camera.map(e.pageX,e.pageY,output,Coordinate.Default).y,args.button=e.button,args.buttonState=Mouse.ButtonState.None,args.handled=!1,scene.onMouseOver&&scene.onMouseOver(args)}function mouseOutCallback(e){var args=new MouseEventArgs;args.x=output.camera.map(e.pageX,e.pageY,output,Coordinate.Default).x,args.y=output.camera.map(e.pageX,e.pageY,output,Coordinate.Default).y,args.button=e.button,args.buttonState=Mouse.ButtonState.None,args.handled=!1,scene.onMouseOut&&scene.onMouseOut(args)}function mouseDownCallback(e){var mapTo=output.camera.map(e.pageX,e.pageY,output,Coordinate.Default);scene.device.mouse.dx=mapTo.x-scene.device.mouse.x,scene.device.mouse.dy=mapTo.y-scene.device.mouse.y,scene.device.mouse.x=mapTo.x,scene.device.mouse.y=mapTo.y,e.button==Mouse.Buttons.Left?scene.device.mouse.left=Mouse.ButtonState.Pressed:e.button==Mouse.Buttons.Wheel?scene.device.mouse.wheel=Mouse.ButtonState.Pressed:e.button==Mouse.Buttons.Right&&(scene.device.mouse.right=Mouse.ButtonState.Pressed);var args=new MouseEventArgs;if(args.button=e.button,args.buttonState=Mouse.ButtonState.Pressed,args.handled=!1,args.x=e.pageX,args.y=e.pageY,scene.GUI&&scene.GUI.mouseDownCallback(args),!args.handled){args.x=mapTo.x,args.y=mapTo.y;for(var i=0;i<scene.objectList.length;i++){var obj=scene.objectList[i];if(obj.hitTest&&obj.onMouseDown&&obj.collider){var p=new Point(args.x,args.y);if(obj.collider.isCollideWith(p)&&(obj.onMouseDown(args),args.handled))return!0}}args.handled||scene.onMouseDown&&scene.onMouseDown(args)}}function mouseUpCallback(e){var mapTo=output.camera.map(e.pageX,e.pageY,output,Coordinate.Default);scene.device.mouse.dx=mapTo.x-scene.device.mouse.x,scene.device.mouse.dy=mapTo.y-scene.device.mouse.y,scene.device.mouse.x=mapTo.x,scene.device.mouse.y=mapTo.y,e.button==Mouse.Buttons.Left?scene.device.mouse.left=Mouse.ButtonState.Released:e.button==Mouse.Buttons.Wheel?scene.device.mouse.wheel=Mouse.ButtonState.Released:e.button==Mouse.Buttons.Right&&(scene.device.mouse.right=Mouse.ButtonState.Released);var args=new MouseEventArgs;if(args.button=e.button,args.buttonState=Mouse.ButtonState.Released,args.handled=!1,args.x=e.pageX,args.y=e.pageY,scene.GUI&&scene.GUI.mouseUpCallback(args),!args.handled){args.x=mapTo.x,args.y=mapTo.y;for(var i=0;i<scene.objectList.length;i++){var obj=scene.objectList[i];if(obj.hitTest&&obj.onMouseUp&&obj.collider){var p=new Point(args.x,args.y);if(obj.collider.isCollideWith(p)&&(obj.onMouseUp(args),args.handled))return!0}}args.handled||scene.onMouseUp&&scene.onMouseUp(args)}}function mouseWheelCallback(e){var mapTo=output.camera.map(e.pageX,e.pageY,output,Coordinate.Default);scene.device.mouse.dx=mapTo.x-scene.device.mouse.x,scene.device.mouse.dy=mapTo.y-scene.device.mouse.y,scene.device.mouse.x=mapTo.x,scene.device.mouse.y=mapTo.y;var args=new MouseEventArgs;if(args.wheelDelta=e.wheelDelta,args.handled=!1,args.x=e.pageX,args.y=e.pageY,scene.GUI&&scene.GUI.mouseWheelCallback&&scene.GUI.mouseWheelCallback(args),!args.handled){args.x=mapTo.x,args.y=mapTo.y;for(var i=0;i<scene.objectList.length;i++){var obj=scene.objectList[i];if(obj.hitTest&&obj.onMouseWheel&&obj.collider){var p=new Point(args.x,args.y);if(obj.collider.isCollideWith(p)&&(obj.onMouseWheel(args),args.handled))return!0}}args.handled||scene.onMouseWheel&&scene.onMouseWheel(args)}}function clickCallback(e){var args=new MouseEventArgs;args.button=e.button,args.buttonState=Mouse.ButtonState.Click,args.handled=!1;var t=(new Date).getTime();if(t-clickTime<=scene.doubleClickDelay){if(args.buttonState=Mouse.ButtonState.DoubleClick,args.x=e.pageX,args.y=e.pageY,scene.GUI&&scene.GUI.doubleClickCallback(args),args.handled)return;args.x=output.camera.map(e.pageX,e.pageY,output,Coordinate.Default).x,args.y=output.camera.map(e.pageX,e.pageY,output,Coordinate.Default).y,clickTime=0;for(var i=0;i<scene.objectList.length;i++){var obj=scene.objectList[i];if(obj.hitTest&&obj.onDoubleClick&&obj.collider){var p=new Point(args.x,args.y);if(obj.collider.isCollideWith(p)&&(obj.onDoubleClick(args),args.handled))break}}if(args.handled)return;scene.onDoubleClick&&scene.onDoubleClick(args)}else{if(args.x=e.pageX,args.y=e.pageY,scene.GUI&&scene.GUI.clickCallback(args),args.handled)return;args.x=output.camera.map(e.pageX,e.pageY,output,Coordinate.Default).x,args.y=output.camera.map(e.pageX,e.pageY,output,Coordinate.Default).y,clickTime=t;for(var i=0;i<scene.objectList.length;i++){var obj=scene.objectList[i];if(obj.hitTest&&obj.onClick&&obj.collider){var p=new Point(args.x,args.y);if(obj.collider.isCollideWith(p)&&(obj.onClick(args),args.handled))break}}if(args.handled)return;scene.onClick&&scene.onClick(args)}}function keyDownCallback(e){if(scene.device.keyboard.keys[e.keyCode]!=Keyboard.KeyState.Down){scene.device.keyboard.keys[e.keyCode]=Keyboard.KeyState.Down;var args=new KeyEventArgs;args.key=e.keyCode,args.keyName=Keyboard.Keys.toString(args.key),args.keyState=Keyboard.KeyState.Down,args.ctrl=e.ctrlKey,args.alt=e.altKey,args.shift=e.shiftKey,args.handled=!1,scene.onKeyDown&&scene.onKeyDown(args)}}function KeyUpCallback(e){if(scene.device.keyboard.keys[e.keyCode]==Keyboard.KeyState.Down){scene.device.keyboard.keys[e.keyCode]=Keyboard.KeyState.Up;var args=new KeyEventArgs;args.key=e.keyCode,args.keyName=Keyboard.Keys.toString(args.key),args.keyState=Keyboard.KeyState.Up,args.ctrl=e.ctrlKey,args.alt=e.altKey,args.shift=e.shiftKey,args.handled=!1,scene.onKeyUp&&scene.onKeyUp(args)}}function keyPressCallback(e){var args=new KeyEventArgs;args.key=e.keyCode,args.keyName=Keyboard.Keys.toString(args.key),args.keyState=Keyboard.KeyState.Pressed,args.ctrl=e.ctrlKey,args.alt=e.altKey,args.shift=e.shiftKey,args.handled=!1,scene.onKeyPress&&scene.onKeyPress(args)}function touchStartCallback(e){for(var i=0;i<e.changedTouches.length;i++){var t=new Touch(e.changedTouches[i].identifier);t.x=output.camera.map(e.changedTouches[i].pageX,e.changedTouches[i].pageY).x,t.y=output.camera.map(e.changedTouches[i].pageX,e.changedTouches[i].pageY).y,t.type=Touch.Types.Start,scene.device.touches.add(t);var argsGUI=new Touch.TouchEventArgs;argsGUI.type=Touch.Types.Start,argsGUI.id=e.changedTouches[i].identifier,argsGUI.x=e.changedTouches[i].pageX,argsGUI.y=e.changedTouches[i].pageY;var args=argsGUI.copy();args.x=output.camera.map(e.changedTouches[i].pageX,e.changedTouches[i].pageY).x,args.y=output.camera.map(e.changedTouches[i].pageX,e.changedTouches[i].pageY).y,scene.GUI&&scene.GUI.touchStartCallback(argsGUI),argsGUI.handled||scene.onTouchStart&&scene.onTouchStart(args)}}function touchMoveCallback(e){for(var i=0;i<e.changedTouches.length;i++){var mapTo=output.camera.map(e.pageX,e.pageY,output,Coordinate.Default),id=e.changedTouches[i].identifier,t=scene.device.touches.id(id);t.dx=mapTo.x-scene.device.mouse.x,t.dy=mapTo.y-scene.device.mouse.y,t.x=mapTo.x,t.y=mapTo.y,t.type=Touch.Types.Move;var argsGUI=new Touch.TouchEventArgs;argsGUI.type=Touch.Types.Move,argsGUI.touches=scene.device.touches,argsGUI.id=e.changedTouches[i].identifier,argsGUI.x=e.changedTouches[i].pageX,argsGUI.y=e.changedTouches[i].pageY;var args=argsGUI.copy();args.type=Touch.Types.Move,args.x=output.camera.map(e.changedTouches[i].pageX,e.changedTouches[i].pageY).x,args.y=output.camera.map(e.changedTouches[i].pageX,e.changedTouches[i].pageY).y,scene.GUI&&scene.GUI.touchMoveCallback(argsGUI),argsGUI.handled||scene.onTouchMove&&scene.onTouchMove(args)}}function touchEndCallback(e){for(var i=0;i<e.changedTouches.length;i++){var id=e.changedTouches[i].identifier;scene.device.touches.removeId(id);var argsGUI=new Touch.TouchEventArgs;argsGUI.type=Touch.Types.End,argsGUI.id=e.changedTouches[i].identifier,argsGUI.touches=touchListGUI.toArray(),argsGUI.x=e.changedTouches[i].pageX,argsGUI.y=e.changedTouches[i].pageY;var args=argsGUI.copy();args.type=Touch.Types.End,args.touches=touchList.toArray(),args.x=output.camera.map(e.changedTouches[i].pageX,e.changedTouches[i].pageY).x,args.y=output.camera.map(e.changedTouches[i].pageX,e.changedTouches[i].pageY).y,scene.GUI&&scene.GUI.touchEndCallback(argsGUI),args.handled||scene.onTouchEnd&&scene.onTouchEnd(args)}}var clickTime=0,scene=this;output.outputDOM.addEventListener("mousemove",mouseMoveCallback),output.outputDOM.addEventListener("mouseover",mouseOverCallback),output.outputDOM.addEventListener("mouseout",mouseOutCallback),output.outputDOM.addEventListener("mousedown",mouseDownCallback),output.outputDOM.addEventListener("mouseup",mouseUpCallback),output.outputDOM.addEventListener("mousewheel",mouseWheelCallback),output.outputDOM.addEventListener("click",clickCallback),window.addEventListener("keydown",keyDownCallback),window.addEventListener("keyup",KeyUpCallback),window.addEventListener("keypress",keyPressCallback),output.outputDOM.addEventListener("touchstart",touchStartCallback),output.outputDOM.addEventListener("touchmove",touchMoveCallback),output.outputDOM.addEventListener("touchend",touchEndCallback)},Scene.prototype.addGameObject=function(obj,layer,collideGroup){if(obj.id>=0)throw new Error("Object existed.");if(this.objectList.add(obj),obj.id=this._objList.add(obj),layer instanceof Layer)layer.scene||this.layers.add(layer,this.layers.topDepth+1),layer.addGameObject(obj);else if(layer instanceof Background)layer.scene||this.background.add(layer),layer.addGameObject(obj);else{if(isNaN(layer)&&(layer=0),!this.layers[layer])throw new Error("Invalid layer.");this.layers[layer].addGameObject(obj)}return collideGroup?(this.collideGroups.contain(collideGroup)||this.addCollideGroup(collideGroup),collideGroup.addGameObject(obj)):this.collideGroups.defaultGroup.addGameObject(obj),this.collideTable.rows=this._objList.length,this.collideTable.columns=this._objList.length,obj.id},Scene.prototype.removeGameObject=function(id){if(id instanceof GameObject){for(var i=0;i<this._objList.length;i++)if(this._objList[i]==id){id=i;break}if(id instanceof GameObject)throw new Error("Object not in scene.")}if(null==id||id<0||isNaN(id))throw new Error("Invalid id.");var obj=this._objList[id];if(!obj)throw new Error("Object not existed.");obj.layer.removeGameObject(obj),this.objectList.remove(obj);for(var i=0;i<obj.collideGroups.length;i++)obj.collideGroups[i].removeGameObject(obj);this._objList[id]=null,obj.id=-1},Scene.prototype.addLayer=function(layer,depth){this.layers.add(layer,depth)},Scene.prototype.removeLayer=function(depth){return this.layers.removeAt(depth)},Scene.prototype.addBackground=function(bg,zIndex){return this.background.add(bg,zIndex)},Scene.prototype.removeBackground=function(bg){return this.background.remove(bg)},Scene.prototype.addCamera=function(camera){if(camera.scene)throw new Error("This camera is in another scene.");camera.scene=this,this.cameraList.add(camera);for(var i=0;i<camera.outputList.length;i++)camera.outputList[i].setLayer(this.layers.count)},Scene.prototype.removeCamera=function(camera){var index=this.cameraList.indexOf(camera);if(index<0)throw new Error("Not found.");this.cameraList.removeAt(index),camera.scene=null},Scene.prototype.addCollideGroup=function(group){this.collideGroups.add(group)},Engine.Scene=Scene,window.Scene=Scene,Coordinate.Axis=function(){this.visible=!1,this.graphic=null},Coordinate.Axis.createCartesian=function(coordinate,xLen,yLen,xColor,yColor){var axis=new Coordinate.Axis,lineX=new Line(new Point(-xLen,0),new Point(xLen,0));lineX.strokeStyle=xColor,lineX.strokeWidth=1;var lineY=new Line(new Point(0,-yLen),new Point(0,yLen));return lineY.strokeStyle=yColor,lineY.strokeWidth=1,axis.x=lineX,axis.y=lineY,axis.graphic=new Combination,axis.graphic.addObject(lineX),axis.graphic.addObject(lineY),axis.graphic.setCoordinate(coordinate),axis},Coordinate.Axis.prototype.render=function(graphics,dt){this.graphic&&this.graphic.render(graphics,dt)},Coordinate.Default=function(){var coordinate=new Coordinate(function(x,y){return{x:x,y:y}},function(x,y){return{x:x,y:y}},function(x,y){return{x:x,y:y}},function(x,y){return{x:x,y:y}});coordinate.copy=function(){var cdn=Coordinate.createCartesian(0,0,1,1,0);return coordinate.axis.graphic&&(cdn.axis.graphic=coordinate.axis.graphic.copy()),cdn};var axis=new Coordinate.Axis,axisVisible=!1;return Object.defineProperty(axis,"visible",{get:function(){return axisVisible},set:function(value){if(!axisVisible){var lineX=new Line(new Point(-1024,0),new Point(1024,0));lineX.strokeStyle=new Color(255,0,0,1),lineX.strokeWidth=1;var lineY=new Line(new Point(0,-1024),new Point(0,1024));lineY.strokeStyle=new Color(0,255,0,1),lineY.strokeWidth=1,axis.graphic=new Combination,axis.graphic.addObject(lineX),axis.graphic.addObject(lineY)}axisVisible=value}}),coordinate.axis=axis,coordinate}(),Coordinate.createCartesian=function(x,y,unitX,unitY,rotation){function pointTo(x,y){if(0==rotation)return{x:(x-originX)/unitX,y:(y-originY)/unitY};var cos=Math.cos(-rotation),sin=Math.sin(-rotation),dx=x-originX,dy=y-originY;return{x:(dx*cos-dy*sin)/unitX,y:(dy*cos+dx*sin)/unitY}}function pointFrom(x,y){if(0==rotation)return{x:x*unitX+originX,y:y*unitY+originY};var cos=Math.cos(rotation),sin=Math.sin(rotation),dx=x*unitX,dy=y*unitY;return{x:dx*cos-dy*sin+originX,y:dy*cos+dx*sin+originY}}function vectorTo(x,y){if(0==rotation)return{x:x/xZoom,y:y/yZoom};var cos=Math.cos(-rotation),sin=Math.sin(-rotation);return{x:(x*cos-y*sin)/xZoom,y:(y*cos+x*sin)/yZoom}}function vectorFrom(x,y){if(0==rotation)return{x:x*xZoom,y:y*yZoom};var cos=Math.cos(rotation),sin=Math.sin(rotation),dx=x*xZoom,dy=y*yZoom;return{x:dx*cos-dy*sin,y:dy*cos+dx*sin}}var originX=x,originY=y,rotation=rotation,coordinate=new Coordinate(pointTo,pointFrom,vectorTo,vectorFrom);Object.defineProperty(coordinate,"originX",{get:function(){return originX},set:function(value){originX=value}}),Object.defineProperty(coordinate,"originY",{get:function(){return originY},set:function(value){originY=value}}),Object.defineProperty(coordinate,"unitX",{get:function(){return unitX},set:function(value){unitX=value}}),Object.defineProperty(coordinate,"unitY",{get:function(){return unitY},set:function(value){unitY=value}}),Object.defineProperty(coordinate,"rotation",{get:function(){return rotation},set:function(value){rotation=value}}),coordinate.copy=function(){var cdn=Coordinate.createCartesian(originX,originY,unitX,unitY,rotation);return coordinate.axis.graphic&&(cdn.axis.graphic=coordinate.axis.graphic.copy()),cdn};var axis=new Coordinate.Axis;coordinate.axis=axis;var lineX=new Line(new Point(-1024,0),new Point(1024,0));lineX.strokeStyle=new Color(255,0,0,1),lineX.strokeWidth=1;var lineY=new Line(new Point(0,-1024),new Point(0,1024));return lineY.strokeStyle=new Color(0,255,0,1),lineY.strokeWidth=1,axis.graphic=new Combination,axis.graphic.addObject(lineX),axis.graphic.addObject(lineY),axis.graphic.setCoordinate(coordinate),coordinate},Coordinate.createPolar=function(x,y,unit,rotation){function pointTo(x,y){var l=Math.sqrt((x-originX)*(x-originX)+(y-originY)*(y-originY)),ang=Math.acos((x-originX)/l)-rotation;return{x:l/unit,y:ang}}function pointFrom(l,ang){return{x:l*unit*Math.cos(ang+rotation)+originX,y:l*unit*Math.sin(ang+rotation)+originY}}function vectorTo(x,y){var l=Math.sqrt(x*x+y*y),ang=Math.acos(x/l)-rotation;return{x:l/unit,y:ang}}function vectorFrom(l,ang){return{x:l*unit*Math.cos(ang+rotation),y:l*unit*Math.sin(ang+rotation)}}var originX=x,originY=y,unit=unit,rotation=rotation,coordinate=new Coordinate(pointTo,pointFrom,vectorTo,vectorFrom);coordinate.originX=originX,coordinate.originY=originY,coordinate.unit=unit,coordinate.rotation=rotation;var axis=new Coordinate.Axis;return coordinate.axis=axis,coordinate},Coordinate.prototype.pointMapTo=function(coordinate,x,y){if(coordinate==this)return{x:x,y:y};if(coordinate==Coordinate.Default)return this.pFrom(x,y);if(this==coordinate.Default)return coordinate.pFrom(x,y);var p=this.pFrom(x,y);return coordinate.pTo(p.x,p.y)},Coordinate.prototype.vectorMapTo=function(coordinate,x,y){if(coordinate==this)return{x:x,y:y};if(coordinate==Coordinate.Default)return this.vFrom(x,y);if(this==coordinate.Default)return coordinate.vFrom(x,y);coordinate.vFrom(x,y);return this.vTo(x,y)},Engine.Coordinate=Coordinate,window.Coordinate=Coordinate,Layer.prototype.addGameObject=function(obj,keepCoordinate,index){if(!this.scene)throw new Error("This layer must belong to a scene before add GameOject.");isNaN(index)?this.objectList.add(obj):this.objectList.insert(obj,index),obj.layer=this,keepCoordinate||obj.setCoordinate(this.coordinate)},Layer.prototype.removeGameObject=function(obj){this.objectList.remove(obj)},Layer.prototype.render=function(graphics,dt){for(var i=0;i<this.objectList.length;i++)this.objectList[i].onRender&&(args={graphics:graphics,x:this.objectList[i].position.x,y:this.objectList[i].position.y,r:this.objectList[i].rotation,dt:dt,cancel:!1},this.objectList[i].onRender(args),args.cancel)||this.objectList[i].render(graphics,this.objectList[i].position.x,this.objectList[i].position.y,this.objectList[i].rotation,dt);this.coordinate.axis&&this.coordinate.axis.visible&&this.coordinate.axis.render(graphics,dt)},Engine.Layer=Layer,window.Layer=Layer,Background.prototype.addGameObject=function(obj){if(!this.scene)throw new Error("The Background is not belong to any Scene.");this.objectList.contain(obj)||this.objectList.add(obj),obj.setCoordinate(this.coordinate),obj.layer=this},Background.prototype.removeGameObject=function(obj){var index=this.objectList.indexOf(obj);return!(index<0)&&void this.objectList.removeAt(index)},Background.prototype.render=function(graphics,dt,camera){var dx=0,dy=0;camera&&(dx=camera.viewCoordinate.originX*this.followSpeed,dy=camera.viewCoordinate.originY*this.followSpeed),this.coordinate.originX=dx,this.coordinate.originY=dy;for(var i=0;i<this.objectList.length;i++)this.objectList[i].render(graphics,0,0,0,dt)},Engine.Background=Background,window.Background=Background,Engine.ArrayList=ArrayList,Matrix.plus=function(a,b){if(!(a instanceof Matrix&&b instanceof Matrix))throw new Error("Not Matrix.");if(a.columns!=b.columns||a.rows!=b.rows)throw new Error("Two Matrix must have same columns and rows.");for(var matrix=new Matrix(a.rows,a.columns),i=0;i<a.rows;i++)for(var j=0;j<a.columns;j++)matrix._innerMatrix[i][j]=a._innerMatrix[i][j]+b._innerMatrix[i][j];return matrix},Matrix.minus=function(a,b){if(!(a instanceof Matrix&&b instanceof Matrix))throw new Error("Not Matrix.");if(a.columns!=b.columns||a.rows!=b.rows)throw new Error("Two Matrix must have same columns and rows.");for(var matrix=new Matrix(a.rows,a.columns),i=0;i<a.rows;i++)for(var j=0;j<a.columns;j++)matrix._innerMatrix[i][j]=a._innerMatrix[i][j]-b._innerMatrix[i][j];return matrix},Matrix.multi=function(a,b){if(a instanceof Matrix&&b){for(var matrix=new Matrix(a.rows,a.columns),i=0;i<a.rows;i++)for(var j=0;j<a.columns;j++)matrix._innerMatrix[i][j]=a._innerMatrix[i][j]*b;return matrix}if(a instanceof Matrix&&b instanceof Matrix){if(a.columns!=b.rows)throw new Error("The number of columns of the left matrix must be the same as the number of rows of the right matrix.");for(var matrix=new Matrix(a.rows,b.columns),i=0;i<a.rows;i++)for(var j=0;j<b.columns;j++)for(var k=0;k<a.columns;k++)matrix._innerMatrix[i][j]+=a._innerMatrix[i][k]*b._innerMatrix[k][j];return matrix}throw new Error("Can only multiply Matrix with Matrix or Matrix with Number.")},Matrix.scale=function(a,b){if(!(a instanceof Matrix)||isNaN(b))throw new Error("The left must be Matrix and right mustv be Number.");for(var matrix=new Matrix(a.rows,a.columns),i=0;i<a.rows;i++)for(var j=0;j<a.columns;j++)matrix._innerMatrix[i][j]=a._innerMatrix[i][j]*b;return matrix},Matrix.transpose=function(matrix){for(var newMatrix=new Matrix(matrix.columns,matrix.rows),i=0;i<newMatrix.rows;i++)for(var j=0;j<newMatrix.columns;j++)newMatrix._innerMatrix[i][j]=matrix._innerMatrix[j][i];return newMatrix},Matrix.prototype.plus=function(matrix){if(!(matrix instanceof Matrix))throw new Error("Not Matrix.");if(matrix.columns!=this.columns||matrix.rows!=this.rows)throw new Error("The Matrix must has same columns and rows.");for(var i=0;i<this.rows;i++)for(var j=0;j<this.columns;j++)this._innerMatrix[i][j]+=matrix._innerMatrix[i][j]},Matrix.prototype.minus=function(matrix){if(!(matrix instanceof Matrix))throw new Error("Not Matrix.");if(matrix.columns!=this.columns||matrix.rows!=this.rows)throw new Error("The Matrix must has same columns and rows.");for(var i=0;i<this.rows;i++)for(var j=0;j<this.columns;j++)this._innerMatrix[i][j]-=matrix._innerMatrix[i][j]},Matrix.prototype.multi=function(x){if(isNaN(x))throw new Error("x must be number. Or use Matrix.multi(a,b) to multiply two Matrix.");for(var i=0;i<this.rows;i++)for(var j=0;j<this.columns;j++)this._innerMatrix[i][j]*=x},Matrix.prototype.scale=Matrix.prototype.multi,Matrix.prototype.transpose=function(){var innerMatrix=this._innerMatrix,rows=this.rows,columns=this.columns;this._innerMatrix=[];for(var i=0;i<columns;i++){this._innerMatrix[i]=[];for(var j=0;j<rows;j++)this._innerMatrix[i][j]=innerMatrix[j][i]}this.columns=rows,this.rows=columns},Engine.Matrix=Matrix,window.Matrix=Matrix,Output.OutputTypes={None:0,Single:1,MultiLayer:2},Output.prototype.outScreen=function(obj){if(!this.viewArea)throw new Error("Are you kidding me?");if(obj instanceof GameObject)if(obj.graphic)obj=obj.graphic;else{var p=new Point(obj.position.x,obj.position.y);p.setCoordinate(obj.position.coordinate),obj=p}if(obj instanceof Engine.Image){var rect=new Rectangle(obj.width,obj.height);rect.center=obj.center.copy(),rect.position=obj.position.copy(),rect.o=obj.o.copy(),obj=rect}if(obj instanceof Point){var p=obj.coordinate.pointMapTo(this.viewArea.coordinate,obj.x,obj.y);return!this.viewArea.isCollideWith(new Point(p.x,p.y))}if(obj instanceof Polygon){for(var i=0;i<obj.V.length;i++){var p=obj.coordinate.pointMapTo(this.viewArea.coordinate,obj.V[i].x,obj.V[i].y);if(this.viewArea.isCollideWith(new Point(p.x,p.y)))return!1}return!0}if(obj instanceof Rectangle){var o=obj.coordinate.pointMapTo(Coordinate.Default,obj.center.x,obj.center.y),p=obj.coordinate.pointMapTo(this.viewArea.coordinate,o.x-obj.width/2,o.y+obj.height/2);return!this.viewArea.isCollideWith(new Point(p.x,p.y))&&(p=obj.coordinate.pointMapTo(this.viewArea.coordinate,o.x+obj.width/2,o.y+obj.height/2),!this.viewArea.isCollideWith(new Point(p.x,p.y))&&(p=obj.coordinate.pointMapTo(this.viewArea.coordinate,o.x+obj.width/2,o.y-obj.height/2),!this.viewArea.isCollideWith(new Point(p.x,p.y))&&(p=obj.coordinate.pointMapTo(this.viewArea.coordinate,o.x-obj.width/2,o.y-obj.height/2),!this.viewArea.isCollideWith(new Point(p.x,p.y)))))}if(obj instanceof Circle){var o=obj.coordinate.pointMapTo(this.viewArea.coordinate,obj.o.x,obj.o.y);if(o.x+obj.r<this.viewArea.center.x-this.viewArea.width/2||this.viewArea.center.x+this.viewArea.width/2<o.x-obj.r)return!0;if(o.y+obj.r<this.viewArea.center.y-this.viewArea.height/2||this.viewArea.center.y+this.viewArea.height/2<o.y-obj.r)return!0}},Output.prototype.connectTo=function(camera){this.camera&&this.camera.removeOutput(this),camera.addOutput(this)},Output.prototype.addAudioTrack=function(audioTrack){if(!this.audioTracks.contain(audioTrack)){var index=this.audioTracks.add(audioTrack);return audioTrack.output=this,index}},Output.prototype.removeAudioTrack=function(audioTrack){var index=this.audioTracks.indexOf(audioTrack);return index<0?-1:(this.audioTracks.removeAt(index),void(audioTrack.output=null))},Output.prototype.playAudio=function(audio){if(!(audio instanceof Engine.Audio&&audio instanceof window.Audio))throw new Error("Audio required.");audio.play()},Output.prototype.playNewAudio=function(audio){if(audio instanceof window.Audio&&(audio=new Engine.Audio(audio)),!(audio instanceof Engine.Audio))throw new Error("Audio required.");var track=new AudioTrack(audio);this.addAudioTrack(track);var output=this;track.onEnd=function(){output.removeAudioTrack(track)},track.play()},Engine.Output=Output,window.Output=Output,CollideGroup.prototype.addGameObject=function(obj){if(!(obj instanceof GameObject))throw new Error("Must be GameObject");obj.collideGroups.contain(this)||(this.objectList.add(obj),obj.collideGroups.add(this))},CollideGroup.prototype.removeGameObject=function(obj){this.objectList.remove(obj),obj.collideGroups.remove(this)},Engine.CollideGroup=CollideGroup,window.CollideGroup=CollideGroup,Camera.prototype.copy=function(){var c=new Camera(this.x,this.y,this.width,this.height,this.zoom);return c.graphics=this.graphics,c},Camera.prototype.setCenter=function(x,y,align){if(!align)throw new Error("Align function is required!");this.position.x=x,this.position.y=y,this.center.x=x+this.width/2-align(this.width,this.height).x,this.center.y=y+this.height/2-align(this.width,this.height).y},Camera.prototype.moveTo=function(x,y){this.position.x=x,this.position.y=y},
Camera.prototype.zoomTo=function(z,x,y){var k=this.zoom/z;if(!isNaN(x)&&!isNaN(y)){var ox=this.center.x,oy=this.center.y;ox=x-(x-ox)*k,oy=y-(y-oy)*k,this.moveTo(ox,oy)}this.zoom=z},Camera.prototype.rotate=function(angle,x,y){isNaN(x)||isNaN(y)||(this.position.rotate(angle,x,y),this.center.rotate(angle,x,y),this.viewCoordinate.originX=this.center.x,this.viewCoordinate.originY=this.center.y),this.rotation+=angle},Camera.prototype.rotateTo=function(angle,x,y){isNaN(x)||isNaN(y)||(this.position.rotate(angle-this.rotation,x,y),this.center.rotate(angle-this.rotation,x,y),this.viewCoordinate.originX=this.center.x,this.viewCoordinate.originY=this.center.y),this.rotation=angle},Camera.prototype.resetTransform=function(graphics){graphics.ky=1,graphics.setTransform(1,0,0,1,0,0)},Camera.prototype.clear=function(bgColor){for(var i=0;i<this.outputList.length;i++){var output=this.outputList[i];if(output.type==Output.OutputTypes.Single){var graphics=output.layers[0];this.resetTransform(graphics),graphics.ctx.clearRect(0,0,graphics.canvas.width,graphics.canvas.height),bgColor&&(graphics.ctx.fillStyle=bgColor,graphics.ctx.fillRect(0,0,graphics.canvas.width,graphics.canvas.height)),this.applyTransform()}else if(output.type==Output.OutputTypes.MultiLayer)for(var j=0;j<output.layers.length;j++){var graphics=output.layers[j];this.resetTransform(graphics),graphics.ctx.clearRect(0,0,graphics.canvas.width,graphics.canvas.height),bgColor&&(graphics.ctx.fillStyle=bgColor,graphics.ctx.fillRect(0,0,graphics.canvas.width,graphics.canvas.height)),this.applyTransform()}}},Camera.prototype.applyTransform=function(graphics){if(graphics&&graphics.ctx){var sinA=Math.sin(this.rotation),cosA=Math.cos(this.rotation),rw=graphics.width,rh=graphics.height;this.width=graphics.canvas.width/this.zoom,this.height=graphics.canvas.height/this.zoom,graphics.setTransform(1,0,0,1,rw/2,rh/2),graphics.transform(cosA,sinA,-sinA,cosA,0,0),graphics.transform(this.zoom,0,0,this.zoom,0,0),graphics.transform(1,0,0,1,-this.position.x,this.position.y),graphics.ky=-1}},Camera.prototype.map=function(x,y,output,coordinate){var x0=x-output.renderWidth/2,y0=y-output.renderHeight/2,p=this.viewCoordinate.pointMapTo(coordinate,x0,y0);return p},Camera.prototype.linkTo=function(target){function DFS(obj,target){for(var i=0;obj.links&&i<obj.links.length;i++)return obj.links[i]==target||DFS(obj.links[i],target);return!1}if(!target.links)throw new Error("Cannot link to this target.");if(DFS(target,this))throw new Error("Link Loop.");target.links.add(this)},Camera.prototype.unlink=function(target){if(!target.links)throw new Error("Are you kidding me?");var index=target.links.indexOf(this);return!(index<0)&&void target.links.removeAt(index)},Camera.prototype.addOutput=function(output){if(!(output instanceof Output))throw new Error("Invalid Output.");if(output.camera)throw new Error("This output has linked to another camera.");output.camera=this,this.outputList.add(output),output.viewArea=new Rectangle(output.renderWidth,output.renderHeight),output.viewArea.setCoordinate(this.viewCoordinate)},Camera.prototype.removeOutput=function(output){var index=this.outputList.indexOf(output);if(index<1)throw new Error("Not found.");this.outputList.removeAt(index),output.camera=null},Camera.prototype.render=function(dt){if(!this.scene)throw new Error("Camera not in scene.");for(var i=0;i<this.scene.background.count;i++)for(var layer=this.scene.background[i],j=0;j<this.outputList.length;j++){var graphics=this.outputList[j].getLayer(i);this.resetTransform(graphics),this.applyTransform(graphics),layer.render(graphics,dt,this)}for(var bgCount=this.scene.background.count,i=0;i<this.scene.layers.depthList.length;i++)for(var layer=this.scene.layers[this.scene.layers.depthList[i]],j=0;j<this.outputList.length;j++){var graphics=this.outputList[j].getLayer(bgCount+i);this.resetTransform(graphics),this.applyTransform(graphics),layer.render(graphics,dt)}},Camera.prototype.renderTo=function(){},Engine.Camera=Camera,window.Camera=Camera,Audio.prototype.load=function(src,callback){function onLoad(){self.audio.removeEventListener("loadedmetadata",onLoad),src instanceof Function?src():callback instanceof Function&&callback()}var self=this;"string"==typeof src?this.src=src:src instanceof Blob&&(this.src=URL.createObjectURL(audio)),this.audio.complete&&(this.complete&&(src instanceof Function?src():callback instanceof Function&&callback()),this.audio.addEventListener("loadedmetadata",onLoad))},Audio.prototype.play=function(){this.audio.play(),this.playing=!0},Audio.prototype.pause=function(){this.audio.pause(),this.playing=!1},Audio.prototype.end=function(){this.currentTime=this.duration,this.pause()},Engine.Audio=Audio,AudioTrack.prototype.play=function(){if(!this.output)throw new Error("The AudioTrack must be add to an Output before playing.");this.audioElement.play(),this.playing=!0},AudioTrack.prototype.pause=function(){if(!this.output)throw new Error("The AudioTrack must be add to an Output before playing.");if(this.audioElement)throw new Error("Are you kidding me?");this.audioElement.pause(),this.playing=!1},AudioTrack.prototype.end=function(){if(!this.output)throw new Error("The AudioTrack must be add to an Output before playing.");if(this.audioElement)throw new Error("Are you kidding me?");this.currentTime=this.duration,this.pause()},AudioTrack.prototype.addToOutput=function(output){if(!(output instanceof Output))throw new Error("Output required.");output.addAudioTrack(this)},AudioTrack.prototype.removeFromOutput=function(output){if(!(output instanceof Output))throw new Error("Output required.");output.removeAudioTrack(this)},Engine.AudioTrack=AudioTrack,Graphics.LineCap=function(){var lineCap={};return lineCap.Butt="butt",lineCap.Round="round",lineCap.Square="square",lineCap}(),Graphics.LineJoin=function(){var lineJoin={};return lineJoin.Bevel="bevel",lineJoin.Round="round",lineJoin.Miter="miter",lineJoin}(),Graphics.CompositeOperation=function(){var co={};return co.SourceOver="source-over",co.SourceAtop="source-atop",co.SourceIn="source-in",co.SourceOut="source-out",co.DestinationOver="destination-over",co.DestinationAtop="destination-atop",co.DestinationIn="destination-in",co.DestinationOut="destination-out",co.Lighter="lighter",co.Copy="copy",co.Xor="xor",co}(),Graphics.drawLine=function(canvas,x1,y1,x2,y2,color){if(!canvas)throw new Error("paramter error.");if(!canvas.getContext)throw new Error("paramter 1 must be a canvas");ctx=canvas.getContext("2d"),ctx.beginPath(),ctx.moveTo(this.kx*x1,this.ky*y1),ctx.lineTo(this.kx*x2,this.ky*y2),color&&(ctx.strokeStyle=color),ctx.stroke()},Graphics.drawArc=function(canvas,x,y,r,ang1,ang2,antiCW,color){var ctx=canvas.getContext("2d");ctx.beginPath(),ctx.arc(this.kx*x,this.ky*y,r,ang1,ang2,antiCW),ctx.strokeStyle=color,ctx.stroke()},Graphics.drawCircle=function(canvas,x,y,r,strokeStyle,fillStyle,strokeWidth){var ctx=canvas.getContext("2d");ctx.beginPath(),ctx.arc(this.kx*x,this.ky*y,r,0,2*Math.PI),ctx.strokeStyle=strokeStyle,ctx.fillStyle=fillStyle,ctx.lineWidth=strokeWidth,ctx.fill(),ctx.stroke()},Graphics.drawImage=function(canvas,img,sx,sy,swidth,sheight,x,y,width,height){var ctx=canvas.getContext("2d");ctx.drawImage(img,sx,sy,swidth,sheight,this.kx*x,this.ky*y,this.kw*width,this.kh*height)},Graphics.fillRect=function(canvas,x,y,w,h,color){if(!canvas)throw new Error("paramter error.");if(!canvas.getContext)throw new Error("paramter 1 must be a canvas");ctx=canvas.getContext("2d"),ctx.fillStyle=color?color:"black",ctx.fillRect(this.kx*x,this.ky*y,this.kw*w,this.kh*h)},Graphics.clear=function(canvas,color){if(!canvas)throw new Error("paramter error.");if(!canvas.getContext)throw new Error("paramter 1 must be a canvas");var ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height),color&&(ctx.fillStyle=color,ctx.fillRect(0,0,width,height))},Graphics.clearRect=function(canvas,x,y,width,height){var ctx=canvas.getContext("2d");ctx.clearRect(this.kx*x,this.ky*y,this.kw*width,this.kh*height)},Graphics.prototype.rect=function(x,y,width,height){return this.ctx.rect(this.kx*x,this.ky*y,this.kw*width,this.kh*height)},Graphics.prototype.roundRect=function(x,y,width,height,r){this.ctx&&(width<2*r&&(width=2*r),height<2*r&&(height=2*r),this.ctx.beginPath(),this.ctx.moveTo(this.kx*x+r,this.ky*y),this.ctx.lineTo(this.kx*x+this.kw*width-r,this.ky*y),this.ctx.arcTo(this.kx*x+this.kw*width,this.ky*y,this.kx*x+this.kw*width,this.ky*y+r,r),this.ctx.lineTo(this.kx*x+this.kw*width,this.ky*y+this.kh*height-r),this.ctx.arcTo(this.kx*x+this.kw*width,this.ky*y+this.kh*height,this.kx*x+this.kw*width-r,this.ky*y+this.kh*height,r),this.ctx.lineTo(this.kx*x+r,this.ky*y+this.kh*height),this.ctx.arcTo(this.kx*x,this.ky*y+this.kh*height,this.kx*x,this.ky*y+this.kh*height-r,r),this.ctx.lineTo(this.kx*x,this.ky*y+r),this.ctx.arcTo(this.kx*x,this.ky*y,this.kx*x+r,this.ky*y,r),this.ctx.closePath())},Graphics.prototype.fillRect=function(x,y,width,height){return this.ctx.fillStyle=this.fillStyle,this.ctx.fillRect(this.kx*x,this.ky*y,this.kw*width,this.kh*height)},Graphics.prototype.strokeRect=function(x,y,width,height){return this.ctx.lineCap=this.lineCap,this.ctx.lineJoin=this.lineJoin,this.ctx.lineWidth=this.strokeWidth,this.ctx.miterLimit=this.miterLimit,this.ctx.strokeStyle=this.strokeStyle,this.ctx.strokeRect(this.kx*x,this.ky*y,this.kw*width,this.kh*height)},Graphics.prototype.fillRoundRect=function(x,y,width,height,r){this.roundRect(this.kx*x,this.ky*y,this.kw*width,this.kh*height,r),this.fill()},Graphics.prototype.strokeRoundRect=function(x,y,width,height,r){this.roundRect(this.kx*x,this.ky*y,this.kw*width,this.kh*height,r),this.stroke()},Graphics.prototype.clearRect=function(x,y,width,height){this.ctx.clearRect(this.kx*x,this.ky*y,this.kw*width,this.kh*height)},Graphics.prototype.fill=function(){return this.ctx.fillStyle=this.fillStyle,this.ctx.fill()},Graphics.prototype.stroke=function(){return this.ctx.lineCap=this.lineCap,this.ctx.lineJoin=this.lineJoin,this.ctx.lineWidth=this.strokeWidth,this.ctx.miterLimit=this.miterLimit,this.ctx.strokeStyle=this.strokeStyle,this.ctx.stroke()},Graphics.prototype.beginPath=function(){return this.ctx.beginPath()},Graphics.prototype.moveTo=function(x,y){return this.ctx.moveTo(this.kx*x,this.ky*y)},Graphics.prototype.closePath=function(){return this.ctx.closePath()},Graphics.prototype.lineTo=function(x,y){return this.ctx.lineTo(this.kx*x,this.ky*y)},Graphics.prototype.clip=function(){return this.ctx.clip()},Graphics.prototype.quadraticCurveTo=function(cpx,cpy,x,y){return this.ctx.quadraticCurveTo(this.kx*cpx,this.ky*cpy,this.kx*x,this.ky*y)},Graphics.prototype.bezierCurveTo=function(cp1x,cp1y,cp2x,cp2y,x,y){return this.ctx.bezierCurveTo(this.kx*cp1x,this.ky*cp1y,this.kx*cp2x,this.ky*cp2y,this.kx*x,this.ky*y)},Graphics.prototype.arc=function(x,y,r,sAngle,eAngle,antiCW){return this.ctx.arc(this.kx*x,this.ky*y,r,sAngle,eAngle,antiCW)},Graphics.prototype.arcTo=function(x1,y1,x2,y2,r){return this.ctx.arcTo(this.kx*x1,this.ky*y1,this.kx*x2,this.ky*y2,r)},Graphics.prototype.isPointInPath=function(x,y){return this.ctx.isPointInPath(this.kx*x,this.ky*y)},Graphics.prototype.scale=function(scalewidth,scaleheight){return this.ctx.scale(scalewidth,scaleheight)},Graphics.prototype.rotate=function(angle,x,y){if(isNaN(x)||isNaN(y))return this.ctx.rotate(angle);this.ctx.translate(this.kx*x,this.ky*y);var r=this.ctx.rotate(sign(this.kx)*sign(this.ky)*angle);return this.ctx.translate(-this.kx*x,-this.ky*y),r},Graphics.prototype.translate=function(x,y){return this.ctx.translate(this.kx*x,this.ky*y)},Graphics.prototype.transform=function(a,b,c,d,e,f){return this.ctx.transform(a,b,c,d,e,f)},Graphics.prototype.setTransform=function(a,b,c,d,e,f){return this.ctx.setTransform(a,b,c,d,e,f)},Graphics.prototype.fillText=function(text,x,y,maxWidth){return this.ctx.font=this.font.toString(),this.ctx.textAlign=this.textAlign,this.ctx.textBaseline=this.textBaseline,this.ctx.fillStyle=this.fillStyle,maxWidth?this.ctx.fillText(text,this.kx*x,this.ky*y,this.kw*maxWidth):this.ctx.fillText(text,this.kx*x,this.ky*y)},Graphics.prototype.strokeText=function(text,x,y,maxWidth){return this.ctx.font=this.font.toString(),this.ctx.fontAlign=this.fontAlign,this.ctx.textBaseline=this.textBaseline,this.ctx.lineCap=this.lineCap,this.ctx.lineJoin=this.lineJoin,this.ctx.lineWidth=this.strokeWidth,this.ctx.miterLimit=this.miterLimit,this.ctx.strokeStyle=this.strokeStyle,this.ctx.strokeText(text,this.kx*x,this.ky*y,this.kw*maxWidth)},Graphics.prototype.measureText=function(text){return this.ctx.font=this.font.toString(),this.ctx.fontAlign=this.fontAlign,this.ctx.textBaseline=this.textBaseline,this.ctx.measureText(text)},Graphics.prototype.drawImage=function(img,sx,sy,swidth,sheight,x,y,width,height){return isNaN(x)&&!isNaN(sx)?this.ctx.drawImage(img,this.kx*sx,this.ky*sy,this.kw*swidth,this.kh*sheight):this.ctx.drawImage(img,sx,sy,swidth,sheight,this.kx*x,this.ky*y,this.kw*width,this.kh*height)},Graphics.prototype.drawLine=function(x1,y1,x2,y2){this.ctx.lineCap=this.lineCap,this.ctx.lineJoin=this.lineJoin,this.ctx.lineWidth=this.strokeWidth,this.ctx.miterLimit=this.miterLimit,this.ctx.strokeStyle=this.strokeStyle,this.beginPath(),this.moveTo(this.kx*x1,this.ky*y1),this.lineTo(this.kx*x2,this.ky*y2),this.stroke()},Engine.Graphics=Graphics,window.Graphics=Graphics,Color.version=2,Color.random=function(){return new Color(255*Math.random(),255*Math.random(),255*Math.random(),1)},Color.fromString=function(str){str=str.replace(new RegExp(/\s/g),"");var reg=new RegExp("#[0-9a-fA-F]{6}");if(reg.test(str)){str=str.replace("#","");var strR=str.charAt(0)+str.charAt(1),strG=str.charAt(2)+str.charAt(3),strB=str.charAt(4)+str.charAt(5),r=parseInt(strR,16),g=parseInt(strG,16),b=parseInt(strB,16);return new Color(r,g,b,1)}if(reg=new RegExp("rgb\\(([0-9]+(\\.[0-9]+){0,1}),([0-9]+(\\.[0-9]+){0,1}),([0-9]+(\\.[0-9]+){0,1})\\)"),reg.test(str)){var colorArray=str.replace("rgb(","").replace(")","").split(","),r=parseInt(colorArray[0]),g=parseInt(colorArray[1]),b=parseInt(colorArray[2]),a=1;return new Color(r,g,b,a)}if(reg=new RegExp("rgba\\(([0-9]+(\\.[0-9]+){0,1}),([0-9]+(\\.[0-9]+){0,1}),([0-9]+(\\.[0-9]+){0,1}),([0-9]+(\\.[0-9]+){0,1})\\)"),reg.test(str)){var colorArray=str.replace("rgba(","").replace(")","").split(","),r=parseInt(colorArray[0]),g=parseInt(colorArray[1]),b=parseInt(colorArray[2]),a=parseFloat(colorArray[3]);return new Color(r,g,b,a)}switch(str){case"transparent":return new Color(255,255,255,0);case"aliceblue":return new Color(240,248,255,1);case"antiquewhite":return new Color(250,235,215,1);case"aqua":return new Color(0,255,255,1);case"aquamarine":return new Color(127,255,212,1);case"azure":return new Color(240,255,255,1);case"beige":return new Color(245,245,220,1);case"bisque":return new Color(255,228,196,1);case"black":return new Color(0,0,0,1);case"blanchedalmond":return new Color(255,235,205,1);case"blue":return new Color(0,0,255,1);case"blueviolet":return new Color(138,43,226,1);case"brown":return new Color(165,42,42,1);case"burlywood":return new Color(222,184,135,1);case"cadetblue":return new Color(95,158,160,1);case"chartreuse":return new Color(127,255,0,1);case"chocolate":return new Color(210,105,30,1);case"coral":return new Color(255,127,80,1);case"cornflowerblue":return new Color(100,149,237,1);case"cornsilk":return new Color(255,248,220,1);case"crimson":return new Color(220,20,60,1);case"cyan":return new Color(0,255,255,1);case"darkblue":return new Color(0,0,139,1);case"darkcyan":return new Color(0,139,139,1);case"darkgoldenrod":return new Color(184,134,11,1);case"darkgray":return new Color(169,169,169,1);case"darkgreen":return new Color(0,100,0,1);case"darkgrey":return new Color(169,169,169,1);case"darkkhaki":return new Color(189,183,107,1);case"darkmagenta":return new Color(139,0,139,1);case"darkolivegreen":return new Color(85,107,47,1);case"darkorange":return new Color(255,140,0,1);case"darkorchid":return new Color(153,50,204,1);case"darkred":return new Color(139,0,0,1);case"darksalmon":return new Color(233,150,122,1);case"darkseagreen":return new Color(143,188,143,1);case"darkslateblue":return new Color(72,61,139,1);case"darkslategray":return new Color(47,79,79,1);case"darkslategrey":return new Color(47,79,79,1);case"darkturquoise":return new Color(0,206,209,1);case"darkviolet":return new Color(148,0,211,1);case"deeppink":return new Color(255,20,147,1);case"deepskyblue":return new Color(0,191,255,1);case"dimgray":return new Color(105,105,105,1);case"dimgrey":return new Color(105,105,105,1);case"dodgerblue":return new Color(30,144,255,1);case"firebrick":return new Color(178,34,34,1);case"floralwhite":return new Color(255,250,240,1);case"forestgreen":return new Color(34,139,34,1);case"fuchsia":return new Color(255,0,255,1);case"gainsboro":return new Color(220,220,220,1);case"ghostwhite":return new Color(248,248,255,1);case"gold":return new Color(255,215,0,1);case"goldenrod":return new Color(218,165,32,1);case"gray":return new Color(128,128,128,1);case"green":return new Color(0,128,0,1);case"greenyellow":return new Color(173,255,47,1);case"grey":return new Color(128,128,128,1);case"honeydew":return new Color(240,255,240,1);case"hotpink":return new Color(255,105,180,1);case"indianred":return new Color(205,92,92,1);case"indigo":return new Color(75,0,130,1);case"ivory":return new Color(255,255,240,1);case"khaki":return new Color(240,230,140,1);case"lavender":return new Color(230,230,250,1);case"lavenderblush":return new Color(255,240,245,1);case"lawngreen":return new Color(124,252,0,1);case"lemonchiffon":return new Color(255,250,205,1);case"lightblue":return new Color(173,216,230,1);case"lightcoral":return new Color(240,128,128,1);case"lightcyan":return new Color(224,255,255,1);case"lightgoldenrodyellow":return new Color(250,250,210,1);case"lightgray":return new Color(211,211,211,1);case"lightgreen":return new Color(144,238,144,1);case"lightgrey":return new Color(211,211,211,1);case"lightpink":return new Color(255,182,193,1);case"lightsalmon":return new Color(255,160,122,1);case"lightseagreen":return new Color(32,178,170,1);case"lightskyblue":return new Color(135,206,250,1);case"lightslategray":return new Color(119,136,153,1);case"lightslategrey":return new Color(119,136,153,1);case"lightsteelblue":return new Color(176,196,222,1);case"lightyellow":return new Color(255,255,224,1);case"lime":return new Color(0,255,0,1);case"limegreen":return new Color(50,205,50,1);case"linen":return new Color(250,240,230,1);case"magenta":return new Color(255,0,255,1);case"maroon":return new Color(128,0,0,1);case"mediumaquamarine":return new Color(102,205,170,1);case"mediumblue":return new Color(0,0,205,1);case"mediumorchid":return new Color(186,85,211,1);case"mediumpurple":return new Color(147,112,219,1);case"mediumseagreen":return new Color(60,179,113,1);case"mediumslateblue":return new Color(123,104,238,1);case"mediumspringgreen":return new Color(0,250,154,1);case"mediumturquoise":return new Color(72,209,204,1);case"mediumvioletred":return new Color(199,21,133,1);case"midnightblue":return new Color(25,25,112,1);case"mintcream":return new Color(245,255,250,1);case"mistyrose":return new Color(255,228,225,1);case"moccasin":return new Color(255,228,181,1);case"navajowhite":return new Color(255,222,173,1);case"navy":return new Color(0,0,128,1);case"oldlace":return new Color(253,245,230,1);case"olive":return new Color(128,128,0,1);case"olivedrab":return new Color(107,142,35,1);case"orange":return new Color(255,165,0,1);case"orangered":return new Color(255,69,0,1);case"orchid":return new Color(218,112,214,1);case"palegoldenrod":return new Color(238,232,170,1);case"palegreen":return new Color(152,251,152,1);case"paleturquoise":return new Color(175,238,238,1);case"palevioletred":return new Color(219,112,147,1);case"papayawhip":return new Color(255,239,213,1);case"peachpuff":return new Color(255,218,185,1);case"peru":return new Color(205,133,63,1);case"pink":return new Color(255,192,203,1);case"plum":return new Color(221,160,221,1);case"powderblue":return new Color(176,224,230,1);case"purple":return new Color(128,0,128,1);case"red":return new Color(255,0,0,1);case"rosybrown":return new Color(188,143,143,1);case"royalblue":return new Color(65,105,225,1);case"saddlebrown":return new Color(139,69,19,1);case"salmon":return new Color(250,128,114,1);case"sandybrown":return new Color(244,164,96,1);case"seagreen":return new Color(46,139,87,1);case"seashell":return new Color(255,245,238,1);case"sienna":return new Color(160,82,45,1);case"silver":return new Color(192,192,192,1);case"skyblue":return new Color(135,206,235,1);case"slateblue":return new Color(106,90,205,1);case"slategray":return new Color(112,128,144,1);case"slategrey":return new Color(112,128,144,1);case"snow":return new Color(255,250,250,1);case"springgreen":return new Color(0,255,127,1);case"steelblue":return new Color(70,130,180,1);case"tan":return new Color(210,180,140,1);case"teal":return new Color(0,128,128,1);case"thistle":return new Color(216,191,216,1);case"tomato":return new Color(255,99,71,1);case"turquoise":return new Color(64,224,208,1);case"violet":return new Color(238,130,238,1);case"wheat":return new Color(245,222,179,1);case"white":return new Color(255,255,255,1);case"whitesmoke":return new Color(245,245,245,1);case"yellow":return new Color(255,255,0,1);case"yellowgreen":return new Color(154,205,50,1);default:return new Color(0,0,0,1)}},Color.prototype.copy=function(){return new Color(this.red,this.green,this.blue,this.alpha)},Color.prototype.toString=function(){return this.red=this.red>255?255:this.red,this.green=this.green>255?255:this.green,this.blue=this.blue>255?255:this.blue,this.alpha=this.realphad>1?1:this.alpha,this.red=this.red<0?0:this.red,this.green=this.green<0?0:this.green,this.blue=this.blue<0?0:this.blue,this.alpha=this.alpha<0?0:this.alpha,"rgba("+parseInt(this.red).toString()+","+parseInt(this.green).toString()+","+parseInt(this.blue).toString()+","+this.alpha.toString()+")"},Color.prototype.equal=function(color){return!(!color instanceof Color)&&(color.red==this.red&&color.green==this.green&&color.blue==this.blue&&color.alpha==this.alpha)},Engine.Color=Color,window.Color&&window.Color.version&&window.Color.version>2||(window.Color=Color),LinkList.version=1.2,LinkList.Node=function(obj,last,next){this.object=obj,last?this.last=last:this.last=null,next?this.next=next:this.next=null},LinkList.prototype.add=function(obj){if(this.count<=0)return this.head=new LinkList.Node(obj,null,null),this.head.parent=this,this.tail=this.head,this.count=1,this.head;var node=new LinkList.Node(obj,this.tail,null);return node.parent=this,this.tail.next=node,this.tail=node,this.count++,node},LinkList.prototype.remove=function(node){if(!(node instanceof LinkList.Node))for(var p=this.head;null!=p;p=p.next)p.object==node&&(node=p);if(node.parent!=this)throw new Error("The node doesn't belong to this link list");null==node.last?this.head=node.next:node.last.next=node.next,null==node.next?this.tail=node.last:node.next.last=node.last,this.count--},LinkList.prototype.foreach=function(callback){if(!callback)throw new Error("A callback function is require.");for(var p=this.head,p=this.head;p;p=p.next){var br=callback(p.object,p);if(br)return}},LinkList.prototype.toArray=function(){var ar=[],i=0;return this.foreach(function(obj){ar[i]=obj,i++}),ar},(!window.LinkList||!window.LinkList.version||window.LinkList.version<LinkList.version)&&(window.LinkList=LinkList),Align.topLeft=function(){return new Point(0,0)},Align.topCenter=function(w){return new Point(w/2,0)},Align.topRight=function(w){return new Point(w,0)},Align.middleLeft=function(w,h){return new Point(0,h/2)},Align.center=function(w,h){return new Point(w/2,h/2)},Align.middleRight=function(w,h){return new Point(w,h/2)},Align.bottomLeft=function(w,h){return new Point(0,h)},Align.bottomCenter=function(w,h){return new Point(w/2,h)},Align.bottomRight=function(w,h){return new Point(w,h)},window.Align=Align,Force.prototype.copy=function(){return new Force(this.x,this.y,this.f)},Force.prototype.toString=function(){return"("+this.x+","+this.y+")"},Force.prototype.getValue=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Force.prototype.toAcceleration=function(m){return new Vector(this.x/m,this.y/m)},Engine.Force=Force,window.Force=Force,Mouse.Buttons={},Mouse.Buttons.Left=0,Mouse.Buttons.Wheel=1,Mouse.Buttons.Right=2,Mouse.ButtonState={},Mouse.ButtonState.None=0,Mouse.ButtonState.Pressed=1,Mouse.ButtonState.Released=2,Mouse.ButtonState.Click=3,Mouse.ButtonState.DoubleClick=4,Mouse.ButtonState.Rolled=8,Mouse.MouseEventArgs=MouseEventArgs,Engine.Mouse=Mouse,window.Mouse=Mouse,Touch.Types={},Touch.Types.None=0,Touch.Types.Start=1,Touch.Types.Move=2,Touch.Types.End=3,TouchEventArgs.prototype.copy=function(){var args=new TouchEventArgs;return args.x=this.x,args.y=this.y,args.type=this.type,args.touches=this.touches,args.id=this.id,args.handled=this.handled,args},Touch.TouchEventArgs=TouchEventArgs,Engine.Touch=Touch,window.Touch=Touch,Keyboard.Keys=function(keys){return keys={},keys.BackSpace=8,keys.Tab=9,keys.Clear=12,keys.Enter=13,keys.Shift=16,keys.Control=17,keys.Alt=18,keys.Pause=19,keys.CapsLock=20,keys.Escape=27,keys.Space=32,keys.Prior=33,keys.Next=34,keys.End=35,keys.Home=36,keys.Left=37,keys.Up=38,keys.Right=39,keys.Down=40,keys.Select=41,keys.Print=42,keys.Execute=43,keys.Insert=45,keys.Delete=46,keys.Help=47,keys.Num0=48,keys.Num1=49,keys.Num2=50,keys.Num3=51,keys.Num4=52,keys.Num5=53,keys.Num6=54,keys.Num7=55,keys.Num8=56,keys.Num9=57,keys.A=65,keys.B=66,keys.C=67,keys.D=68,keys.E=69,keys.F=70,keys.G=71,keys.H=72,keys.I=73,keys.J=74,keys.K=75,keys.L=76,keys.M=77,keys.N=78,keys.O=79,keys.P=80,keys.Q=81,keys.R=82,keys.S=83,keys.T=84,keys.U=85,keys.V=86,keys.W=87,keys.X=88,keys.Y=89,keys.Z=90,keys.KP0=96,keys.KP1=97,keys.KP2=98,keys.KP3=99,keys.KP4=100,keys.KP5=101,keys.KP6=102,keys.KP7=103,keys.KP8=104,keys.KP9=105,keys.KPMultiply=106,keys.KPAdd=107,keys.KPSeparator=108,keys.KPSubtract=109,keys.KPDecimal=110,keys.KPDivide=111,keys.F1=112,keys.F2=113,keys.F3=114,keys.F4=115,keys.F5=116,keys.F6=117,keys.F7=118,keys.F8=119,keys.F9=120,keys.F10=121,keys.F11=122,keys.F12=123,keys.F13=124,keys.F14=125,keys.F15=126,keys.F16=127,keys.F17=128,keys.F18=129,keys.F19=130,keys.F20=131,keys.F21=132,keys.F22=133,keys.F23=134,keys.F24=135,keys.NumLock=136,keys.ScrollLock=137,keys.toString=function(keyCode){switch(keyCode){case 8:return"BackSpace";case 9:return"Tab";case 12:return"Clear";case 13:return"Enter";case 16:return"Shift";case 17:return"Control";case 18:return"Alt";case 19:return"Pause";case 20:return"CapsLock";case 27:return"Escape";case 32:return"Space";case 33:return"Prior";case 34:return"Next";case 35:return"End";case 36:return"Home";case 37:return"Left";case 38:return"Up";case 39:return"Right";case 40:return"Down";case 41:return"Select";case 42:return"Print";case 43:return"Execute";case 45:return"Insert";case 46:return"Delete";case 47:return"Help";case 48:return"0";case 49:return"1";case 50:return"2";case 51:return"3";case 52:return"4";case 53:return"5";case 54:return"6";case 55:return"7";case 56:return"8";case 57:return"9";case 65:return"A";case 66:return"B";case 67:return"C";case 68:return"D";case 69:return"E";case 70:return"F";case 71:return"G";case 72:return"H";case 73:return"I";case 74:return"J";case 75:return"K";case 76:return"L";case 77:return"M";case 78:return"N";case 79:return"O";case 80:return"P";case 81:return"Q";case 82:return"R";case 83:return"S";case 84:return"T";case 85:return"U";case 86:return"V";case 87:return"W";case 88:return"X";case 89:return"Y";case 90:return"Z";case 96:return"KP0";case 97:return"KP1";case 98:return"KP2";case 99:return"KP3";case 100:return"KP4";case 101:return"KP5";case 102:return"KP6";case 103:return"KP7";case 104:return"KP8";case 105:return"KP9";case 106:return"KPMultiply";case 107:return"KPAdd";case 108:return"KPSeparator";case 109:return"KPSubtract";case 110:return"KPDecimal";case 111:return"KPDivide";case 112:return"F1";case 113:return"F2";case 114:return"F3";case 115:return"F4";case 116:return"F5";case 117:return"F6";case 118:return"F7";case 119:return"F8";case 120:return"F9";case 121:return"F10";case 122:return"F11";case 123:return"F12";case 124:return"F13";case 125:return"F14";case 126:return"F15";case 127:return"F16";case 128:return"F17";case 129:return"F18";case 130:return"F19";case 131:return"F20";case 132:return"F21";case 133:return"F22";case 134:return"F23";case 135:return"F24";case 136:return"NumLock";case 137:return"ScrollLock";default:return"Unknown"}},keys}(Keyboard.Keys),Keyboard.Keys.check=function(key,keys){for(var i=0;i<keys.length;i++)if(key==keys[i])return!0;return!1},window.Keys=Keyboard.Keys;Keyboard.KeyState={};Keyboard.KeyState.None=0,Keyboard.KeyState.Down=1,Keyboard.KeyState.Up=2,Keyboard.KeyState.Pressed=3,Keyboard.checkKeys=function(key,keys){for(var i=0;i<keys.length;i++)if(key==keys[i])return!0;return!1},Keyboard.KeyEventArgs=KeyEventArgs,Engine.Keyboard=Keyboard,window.Keyboard=Keyboard,Vector2.fromPoint=function(p1,p2){return new Vector2(p2.x-p1.x,p2.y-p1.y)},Vector2.prototype.copy=function(){var v=new Vector2(this.x,this.y);return v.coordinate=this.coordinate,v},Vector2.prototype.toString=function(){return"("+this.x+","+this.y+")"},Vector2.prototype.setCoordinate=function(coordinate){this.coordinate=coordinate},Vector2.prototype.changeCoordinate=function(coordinate){var v=this.coordinate.vectorMapTo(coordinate,this.x,this.y);this.x=v.x,this.y=v.y,this.coordinate=coordinate},Vector2.prototype.getLength=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Vector2.prototype.rotate=function(rad){var x=this.x,y=this.y;this.x=x*Math.cos(rad)-y*Math.sin(rad),this.y=y*Math.cos(rad)+x*Math.sin(rad)},Vector2.prototype.mod=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Vector2.prototype.plus=function(v){if(!(v instanceof Vector2))throw new Error("v must be a Vector");return this.x=this.x+v.x,this.y=this.y+v.y,this},Vector2.prototype.minus=function(v){if(!(v instanceof Vector2))throw new Error("v must be a Vector");return this.x=this.x-v.x,this.y=this.y-v.y,this},Vector2.prototype.multi=function(n){if(!isNaN(n))return this.x*=n,this.y*=n,this},Vector2.prototype.toLine=function(x,y){return new Line(new Point(x,y),new Point(x+this.x,y+this.y))},Vector2.plus=function(u,v){if(!(u instanceof Vector2&&u instanceof Vector2))throw new Error("u and v must be an Vector2.");return new Vector2(u.x+v.x,u.y+v.y)},Vector2.minus=function(u,v){if(!(u instanceof Vector2&&u instanceof Vector2))throw new Error("u and v must be an Vector2.");return new Vector2(u.x-v.x,u.y-v.y)},Vector2.multi=function(u,v){if(!(u instanceof Vector2))throw new Error("u must be an Vector2.");return v instanceof Vector2?u.x*v.x+u.y*v.y:isNaN(v)?void 0:new Vector2(u.x*v,u.y*v)},Engine.Vector2=Vector2,window.Vector2=Vector2,Point.Distance=function(p1,p2){return Math.sqrt((p1.x-p2.x)*(p1.x-p2.x)+(p1.y-p2.y)*(p1.y-p2.y))},Point.prototype.copy=function(){var p=new Point(this.x,this.y);return p.coordinate=this.coordinate,p},Point.prototype.toString=function(){return"("+this.x+","+this.y+")"},Point.prototype.setCoordinate=function(coordinate){this.coordinate=coordinate},Point.prototype.changeCoordinate=function(coordinate){var p=this.coordinate.pointMapTo(coordinate,this.x,this.y);this.x=p.x,this.y=p.y,this.coordinate=coordinate},Point.prototype.rotate=function(rad,x0,y0){var x=this.x-x0,y=this.y-y0,dx=x*Math.cos(rad)-y*Math.sin(rad),dy=y*Math.cos(rad)+x*Math.sin(rad);this.x=x0+dx,this.y=y0+dy},Point.prototype.isBelongTo=function(l){if(!(this.lines instanceof Array))throw"this object has something wrong.";for(var i=0;i<this.lines.length;i++)if(this.lines[i]==l)return!0;return!1},Point.prototype.addLine=function(l){if(!(this.lines instanceof Array))throw"this object has something wrong.";this.lines[this.lines.length]=l},Point.prototype.render=function(){},Engine.Point=Point,window.Point=Point,Position.prototype.copy=function(){var pos=new Position(this.innerX,this.innerY);
return pos.setCoordinate(this.coordinate),pos},Position.prototype.setCoordinate=function(coordinate){this.coordinate=coordinate},Position.prototype.changeCoordinate=function(coordinate){var p=this.coordinate.pointMapTo(coordinate,this.x,this.y);this.innerX=p.x,this.innerY=p.y,this.coordinate=coordinate},Position.prototype.rotate=function(rad,x0,y0){var x=this.innerX-x0,y=this.innerY-y0,dx=x*Math.cos(rad)-y*Math.sin(rad),dy=y*Math.cos(rad)+x*Math.sin(rad);this.innerX=x0+dx,this.innerY=y0+dy},Engine.Position=Position,Line.prototype.copy=function(){var p1=this.p1.copy(),p2=this.p2.copy(),line=new Line(p1,p2);return line.setCenter(this.center.x,this.center.y),line.position=this.position.copy(),line.coordinate=this.coordinate,this.strokeStyle.copy?line.strokeStyle=this.strokeStyle.copy():line.strokeStyle=this.strokeStyle,line.strokeWidth=this.strokeWidth,line},Line.prototype.setCoordinate=function(coordinate){this.coordinate=coordinate,this.position.setCoordinate(coordinate),this.center.setCoordinate(coordinate),this.p1.setCoordinate(coordinate),this.p2.setCoordinate(coordinate)},Line.prototype.changeCoordinate=function(coordinate){this.p1.changeCoordinate(coordinate),this.p2.changeCoordinate(coordinate),this.center.changeCoordinate(coordinate),this.position.changeCoordinate(coordinate),this.coordinate=coordinate},Line.prototype.setCenter=function(x,y){this.center.x=x,this.center.y=y},Line.prototype.moveTo=function(x,y){if(x!=this.position.x||y!=this.position.y){var dx=x-this.position.x,dy=y-this.position.y;this.p1.x+=dx,this.p1.y+=dy,this.p2.x+=dx,this.p2.y+=dy,this.center.x+=dx,this.center.y+=dy,this.position.x=x,this.position.y=y}},Line.prototype.rotate=function(rad,x,y){(isNaN(x)||isNaN(y))&&(x=this.center.x,y=this.center.y),this.p1.rotate(rad,x,y),this.p2.rotate(rad,x,y)},Line.prototype.isCross=function(obj){if(obj instanceof Line){var p1=this.p1,p2=this.p2,p3=obj.p1,p4=obj.p2,v13=new Vector2(p3.x-p1.x,p3.y-p1.y),v14=new Vector2(p4.x-p1.x,p4.y-p1.y),v31=new Vector2(p1.x-p3.x,p1.y-p3.y),v32=new Vector2(p2.x-p3.x,p2.y-p3.y),v12=new Vector2(p2.x-p1.x,p2.y-p1.y),v34=new Vector2(p4.x-p3.x,p4.y-p3.y);return(v13.x*v12.y-v12.x*v13.y)*(v14.x*v12.y-v12.x*v14.y)<0&&(v31.x*v34.y-v34.x*v31.y)*(v32.x*v34.y-v34.x*v32.y)<0}if(obj instanceof Circle){var v1=new Vector2(obj.o.x-this.p1.x,obj.o.y-this.p1.y),v2=new Vector2(this.p2.x-this.p1.x,this.p2.y-this.p1.y),v3=new Vector2(obj.o.x-this.p2.x,obj.o.y-this.p2.y),v4=new Vector2(-v2.x,-v2.y),d1=(obj.o.x-this.p1.x)*(obj.o.x-this.p1.x)+(obj.o.y-this.p1.y)*(obj.o.y-this.p1.y);d1=d1<=obj.r*obj.r?1:0;var d2=(obj.o.x-this.p2.x)*(obj.o.x-this.p2.x)+(obj.o.y-this.p2.y)*(obj.o.y-this.p2.y);if(d2=d2<=obj.r*obj.r?1:0,d1^d2)return!0;if(d1&&d2)return!1;if(v1.x*v2.x+v1.y*v2.y<0||v3.x*v4.x+v3.y*v4.y<0)return!1;v3.x*v4.x+v3.y*v4.y<0;var x=v1.x*v2.y-v2.x*v1.y,l=v2.x*v2.x+v2.y*v2.y;return l=l*obj.r*obj.r,x*=x,x<=l}if(obj instanceof Rectangle){for(var i=0;i<obj.E.length;i++)if(this.isCross(obj.E[i]))return!0;return!1}if(obj instanceof Polygon){for(var i=0;i<obj.E.length;i++)if(this.isCross(obj.E[i]))return!0;return!1}if(obj instanceof Particle)return obj.isCollideWith(this,0,0)},Line.prototype.render=function(graphics){var p1=this.p1.coordinate.pFrom(this.p1.x,this.p1.y),p2=this.p2.coordinate.pFrom(this.p2.x,this.p2.y);graphics.beginPath(),graphics.moveTo(p1.x,p1.y),graphics.lineTo(p2.x,p2.y),graphics.strokeStyle=this.strokeStyle,graphics.strokeWidth=this.strokeWidth,graphics.stroke()},Line.prototype.toGameObject=function(){var obj=new GameObject;return obj.graphic=this,obj},Engine.Line=Line,window.Line=Line,Arc.prototype.copy=function(){var arc=new Arc(this.r,this.start,this.end,this.antiCW);return arc.o=this.o.copy(),arc.position=this.position.copy(),arc.coordinate=this.coordinate,arc.strokeStyle=this.strokeStyle.copy?this.strokeStyle.copy():this.strokeStyle,arc.fillStyle=this.fillStyle.copy?this.fillStyle.copy():this.fillStyle,arc.strokeWidth=this.strokeWidth,arc},Arc.prototype.setCoordinate=function(coordinate){this.o.setCoordinate(coordinate),this.position.setCoordinate(coordinate),this.coordinate=coordinate},Arc.prototype.changeCoordinate=function(coordinate){this.o.changeCoordinate(coordinate),this.position.changeCoordinate(coordinate),this.coordinate=coordinate},Arc.prototype.rotate=function(ang,o){this.o.rotate(o,ang),this.start+=ang,this.end+=ang},Arc.prototype.render=function(graphics){var o=this.o.coordinate.pFrom(this.o.x,this.o.y);graphics.beginPath(),graphics.arc(o.x,o.y,this.r,this.start,this.end,this.antiCW),graphics.lineCap=this.lineCap,graphics.strokeWidth=this.strokeWidth,graphics.strokeStyle=this.strokeStyle,graphics.fillStyle=this.fillStyle,graphics.fill(),graphics.stroke()},Engine.Arc=Arc,window.Arc=Arc,Font.prototype.copy=function(){var f=new Font(this.fontFamily,this.fontSize);return f.fontStyle=this.fontStyle,f.fontVariant=this.fontVariant,f.fontWeight=this.fontWeight,f.caption=this.caption,f.icon=this.icon,f.menu=this.menu,f.messageBox=this.messageBox,f.smallCaption=this.smallCaption,f.statusBar=this.statusBar,f},Font.prototype.toString=function(){return this.fontStyle+" "+this.fontVariant+" "+this.fontWeight+" "+this.fontSize+"px "+this.fontFamily},window.Font=Font,FontStyle.Normal="normal",FontStyle.Italic="italic",FontStyle.Oblique="oblique",window.FontStyle=FontStyle,FontVariant.Normal="normal",FontVariant.SmallCaps="small-caps",window.FontVariant=FontVariant,FontWeight.Normal="normal",FontWeight.Bold="bold",FontWeight.Bolder="bolder",FontWeight.Lighter="lighter",window.FontWeight=FontWeight,TextAlign.Start="start",TextAlign.End="end",TextAlign.Center="center",TextAlign.Left="left",TextAlign.Right="right",window.TextAlign=TextAlign,TextBaseline.Alphabetic="alphabetic",TextBaseline.Top="top",TextBaseline.Hanging="hanging",TextBaseline.Middle="middle",TextBaseline.Ideographic="ideographic",TextBaseline.Bottom="bottom",window.TextBaseline=TextBaseline,Text.prototype.copy=function(){var text=new Text(this.text);return text.font=this.font.copy(),text.position=this.position.copy(),text.coordinate=this.coordinate,text.center=this.center.copy(),text.onRender=this.onRender,this.fillStyle&&this.fillStyle.copy?text.fillStyle=this.fillStyle.copy():text.fillStyle=this.fillStyle,this.strokeStyle&&this.strokeStyle.copy?text.strokeStyle=this.strokeStyle.copy():text.strokeStyle=this.strokeStyle,text},Text.prototype.setCoordinate=function(coordinate){this.position.setCoordinate(coordinate),this.center.setCoordinate(coordinate),this.coordinate=coordinate},Text.prototype.changeCoordinate=function(coordinate){this.position.changeCoordinate(coordinate),this.center.changeCoordinate(coordinate),this.coordinate=coordinate},Text.prototype.setCenter=function(x,y,align){if(this.position=new Point(x,y),!align)throw new Error("");this.center=align(this.width,this.height),this.center.x=x-this.center.x,this.center.y=y+this.center.y},Text.prototype.moveTo=function(x,y){var rx=this.position.x,ry=this.position.y;this.position.x=x,this.position.y=y,this.center.x=this.center.x-rx+x,this.center.y=this.center.y-ry+y},Text.prototype.drawToCanvas=function(canvas,x,y){var ctx=canvas.getContext("2d");ctx.font=this.fontStyle+" "+this.fontVariant+" "+this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,ctx.fillStyle=this.fillStyle,ctx.strokeStyle=this.strokeStyle,ctx.fillText(this.text,x,y),ctx.strokeText(this.text,x,y)},Text.prototype.render=function(graphics){if(graphics&&graphics.ctx){this.onRender&&this.onRender();var center=this.center.coordinate.pFrom(this.center.x,this.center.y);graphics.textAlign=TextAlign.Left,graphics.textBaseline=TextBaseline.Top,graphics.font=this.font,graphics.fillStyle=this.fillStyle,graphics.strokeStyle=this.strokeStyle,graphics.fillText(this.text,center.x,center.y),graphics.strokeText(this.text,center.x,center.y)}},Engine.Text=Text,window.Text=Text,Image.fromUrl=function(url,width,height){var img=new window.Image,image=new Image(img);return image.o.x=-width/2,image.o.y=height/2,img.onload=function(){(isNaN(width)||isNaN(height))&&(width=img.width,height=img.height),image.width=width,image.height=height,image.o.x=-img.width/2,image.o.y=img.height/2,img.onload=null},img.src=url,image},Image.prototype.copy=function(){var img=new Engine.Image(this.img);return img.setPosition(this.position.x,this.position.y),img.setCenter(this.center.x,this.center.y),img.o=this.o.copy(),img.coordinate=this.coordinate,img.onRender=this.onRender,img},Image.prototype.setCoordinate=function(coordinate){this.o.setCoordinate(coordinate),this.center.setCoordinate(coordinate),this.position.setCoordinate(coordinate),this.coordinate=coordinate},Image.prototype.changeCoordinate=function(coordinate){this.position.changeCoordinate(coordinate),this.center.changeCoordinate(coordinate),this.coordinate=coordinate},Image.prototype.setCenter=function(x,y){var dx=x-this.center.x,dy=y-this.center.y;this.o.x-=dx,this.o.y-=dy,this.center=new Position(x,y)},Image.prototype.setPosition=function(x,y){this.position=new Position(x,y);var image=this;this.position.changeCallback=function(e){var dx=e.x-image.position.x,dy=e.y-image.position.y;image.center.x+=dx,image.center.y+=dy}},Image.prototype.move=function(){},Image.prototype.moveTo=function(x,y){this.position.x=x,this.position.y=y},Image.prototype.rotate=function(angle,x,y){(isNaN(x)||isNaN(y))&&(x=this.center.x,y=this.center.y),this.position.rotate(angle,x,y),this.center.rotate(angle,x,y),this.rotation+=angle},Image.prototype.rotateTo=function(angle,x,y){isNaN(x)||isNaN(y)||(this.position.rotate(angle-this.rotation,x,y),this.center.rotate(angle-this.rotation,x,y)),this.rotation=angle},Image.prototype.render=function(graphics){if(graphics){this.onRender&&this.onRender();var o=this.center.coordinate.pFrom(this.center.x,this.center.y);o.x+=this.o.x,o.y+=this.o.y,this.rotation?(graphics.rotate(this.rotation,this.center.x,this.center.y),graphics.drawImage(this.img,o.x,o.y,this.width,this.height),graphics.rotate(-this.rotation,this.center.x,this.center.y)):graphics.drawImage(this.img,o.x,o.y,this.width,this.height)}},Engine.Image=Image,Path.Point=function(x,y){this.x=x,this.y=y,this.coordinate=Coordinate.Default,this.cp1=new Point(x,y),this.cp2=new Point(x,y)},Path.Point.prototype.copy=function(){var p=new Path.Point(this.x,this.y);return p.coordinate=this.coordinate,p.cp1=this.cp1.copy(),p.cp2=this.cp2.copy(),p},Path.Point.prototype.setCoordinate=function(coordinate){this.cp1.setCoordinate(coordinate),this.cp2.setCoordinate(coordinate),this.coordinate=coordinate},Path.Point.prototype.changeCoordinate=function(coordinate){this.cp1.changeCoordinate(coordinate),this.cp2.changeCoordinate(coordinate);var p=this.coordinate.pointMapTo(coordinate);this.x=p.x,this.y=p.y,this.coordinate=coordinate},Path.Point.prototype.moveTo=function(x,y){var dx=x-this.x,dy=y-this.y;this.cp1.x+=dx,this.cp1.y+=dy,this.cp2.x+=dx,this.cp2.y+=dy,this.x=x,this.y=y},Path.prototype.copy=function(){var path=new Path;path.coordinate=this.coordinate;for(var i=0;i<this.pList.length;i++)path.pList[i]=this.pList[i].copy();return path},Path.prototype.setCoordinate=function(coordinate){for(var i=0;i<this.pList;i++)this.pList[i].setCoordinate(coordinate);this.position.setCoordinate(coordinate),this.center.setCoordinate(coordinate),this.coordinate=coordinate},Path.prototype.changeCoordinate=function(coordinate){for(var i=0;i<this.pList;i++)this.pList[i].changeCoordinate(coordinate);this.position.changeCoordinate(coordinate),this.center.changeCoordinate(coordinate),this.coordinate=coordinate},Path.prototype.setCenter=function(x,y){isNaN(x)||isNaN(y)||(this.position.x=x,this.position.y=y,this.center=this.position)},Path.prototype.moveTo=function(x,y){for(var dx=x-this.position.x,dy=y-this.position.y,i=0;i<this.pList.length;i++)this.pList[i].moveTo(this.pList[i].x+dx,this.pList[i].y+dy);this.position.x=x,this.position.y=y},Path.prototype.close=function(){this.pList.length&&this.pList.add(this.pList[0])},Path.prototype.render=function(graphics){graphics.beginPath();for(var i=0;i<this.pList.length-1;i++){var p1=this.pList[i].coordinate.pFrom(this.pList[i].x,this.pList[i].y);p1.cp2=this.pList[i].cp2.coordinate.pFrom(this.pList[i].cp2.x,this.pList[i].cp2.y);var p2=this.pList[i+1].coordinate.pFrom(this.pList[i+1].x,this.pList[i+1].y);p2.cp1=this.pList[i+1].cp1.coordinate.pFrom(this.pList[i+1].cp1.x,this.pList[i+1].cp1.y),graphics.lineTo(p1.x,p1.y),graphics.bezierCurveTo(p1.cp2.x,p1.cp2.y,p2.cp1.x,p2.cp1.y,p2.x,p2.y)}this.pList.last()==this.pList[0]&&graphics.closePath(),graphics.fillStyle=this.fillStyle.toString(),graphics.strokeStyle=this.strokeStyle.toString(),graphics.lineWidth=this.strokeWidth,graphics.fill(),graphics.stroke()},Engine.Path=Path,window.Path=Path,Combination.prototype.copy=function(){for(var comb=new Combination,i=0;i<this.objectList.length;i++)comb.objectList[i]=this.objectList[i].copy();return comb.position=this.position.copy(),comb.center=this.center.copy(),comb.coordinate=this.coordinate,comb},Combination.prototype.addObject=function(obj){this.objectList.add(obj)},Combination.prototype.removeObject=function(obj){this.objectList.remove(obj)},Combination.prototype.removeObjectAt=function(index){this.objectList.removeAt(index)},Combination.prototype.setCoordinate=function(coordinate){for(var i=0;i<this.objectList.length;i++)this.objectList[i].setCoordinate&&this.objectList[i].setCoordinate(coordinate);this.position.setCoordinate(coordinate),this.center.setCoordinate(coordinate),this.coordinate=coordinate},Combination.prototype.changeCoordinate=function(coordinate){for(var i=0;i<this.objectList.length;i++)this.objectList[i].changeCoordinate&&this.objectList[i].changeCoordinate(coordinate);this.position.changeCoordinate(coordinate),this.center.changeCoordinate(coordinate),this.coordinate=coordinate},Combination.prototype.setPositionPoint=function(x,y){this.position=new Point(x,y)},Combination.prototype.setCenterPoint=function(x,y){this.center=new Center(x,y)},Combination.prototype.moveTo=function(x,y){for(var dx=x-this.position.x,dy=y-this.position.y,i=0;i<this.objectList.length;i++)this.objectList[i].moveTo(this.objectList[i].position.x+dx,this.objectList[i].position.y+dy);this.position.x+=dx,this.position.y+=dy,this.center.x+=dx,this.center.y+=dy},Combination.prototype.move=function(dx,dy){for(var i=0;i<this.objectList.length;i++)this.objectList[i].moveTo(this.objectList[i].position.x+dx,this.objectList[i].position.y+dy);this.position.x+=dx,this.position.y+=dy,this.center.x+=dx,this.center.y+=dy},Combination.prototype.rotate=function(ang,x,y){(isNaN(x)||isNaN(y))&&(x=this.center.x,y=this.center.y);for(var i=0;i<this.objectList.length;i++)this.objectList[i].rotate&&this.objectList[i].rotate(ang,x,y);this.position.rotate(ang,x,y),this.center.rotate(ang,x,y),this.rotation+=ang},Combination.prototype.render=function(graphics,x,y,r,dt){for(var i=0;i<this.objectList.length;i++)this.objectList[i].render(graphics,this.objectList[i].position.x,this.objectList[i].position.y,this.objectList[i].rotation,dt)},Engine.Combination=Combination,window.Combination=Combination,ImageAnimation.Loop=function(){this.from=0,this.to=0,this.length=0,this.loopTimes=-1,this.lt=0,this.enable=!0,this.onEnd=null,this.onStart=null},ImageAnimation.Loop.prototype.copy=function(){var loop=new ImageAnimation.Loop;return loop.from=this.from,loop.to=this.to,loop.length=this.length,loop.loopTimes=this.loopTimes,loop.lt=this.lt,loop.enable=this.enable,loop.onEnd=this.onEnd,loop.onStart=this.onStart,loop},ImageAnimation.Loop.prototype.begin=function(){this.enable=!0,this.onStart&&this.onStart()},ImageAnimation.Loop.prototype.end=function(){var t=this.enable;this.enable=!1,t&&this.onEnd&&this.onEnd()},ImageAnimation.loadFromUrl=function(url,clipX,clipY,fWidth,fHeight,width,height,fCount,fps,callback){var ia=new ImageAnimation;return ia.img=new Image,ia.img.onload=function(){ia.fps=fps,ia.width=width,ia.heigh=height,ia.clipFrame(clipX,clipY,fWidth,fHeight,fCount),callback&&callback()},ia.img.src=url,ia},ImageAnimation.create=function(){},ImageAnimation.prototype.copy=function(){var ia=new ImageAnimation;return ia.img=this.img,ia.center=this.center.copy(),ia.position=this.position.copy(),ia.coordinate=this.coordinate,ia.fCount=this.fCount,ia.fps=this.fps,ia.clipX=this.clipX,ia.clipY=this.clipY,ia.fWidth=this.fWidth,ia.fHeight=this.fHeight,ia.time=this.time,ia.width=this.width,ia.heigh=this.heigh,ia.frame=this.frame,ia.playing=this.playing,ia.reverse=this.reverse,ia.onBegine=this.onBegine,ia.onEnd=this.onEnd,ia.onFrameUpdate=this.onFrameUpdate,ia.loop=this.loop.copy(),ia},ImageAnimation.prototype.setCoordinate=function(coordinate){this.position.setCoordinate(coordinate),this.position.setCoordinate(coordinate),this.coordinate=coordinate},ImageAnimation.prototype.changeCoordinate=function(coordinate){this.position.changeCoordinate(coordinate),this.position.changeCoordinate(coordinate),this.coordinate=coordinate},ImageAnimation.prototype.setCenter=function(x,y,align){if(this.position=new Point(x,y),!align)throw new Error("");this.center=align(this.width,this.heigh),this.center.x=x-this.center.x,this.center.y=y+this.center.y},ImageAnimation.prototype.moveTo=function(x,y){var rx=this.position.x,ry=this.position.y;this.position.x=x,this.position.y=y,this.center.x=this.center.x-rx+x,this.center.y=this.center.y-ry+y},ImageAnimation.prototype.clipFrame=function(clipX,clipY,fWidth,fHeight,fCount){this.clipX=clipX,this.clipY=clipY,this.fWidth=fWidth,this.fHeight=fHeight,this.fCount=fCount,this.loop.from=0,this.loop.to=fCount-1},ImageAnimation.prototype.begine=function(){this.playing=!0,this.time=0,this.frame=0,this.loop.lt=0},ImageAnimation.prototype.end=function(){var t=this.playing;this.playing=!1,this.onEnd&&t&&this.onEnd()},ImageAnimation.prototype.play=function(){this.playing=!0,this.time=0},ImageAnimation.prototype.drawToCanvas=function(){},ImageAnimation.prototype.preload=function(graphics){graphics.drawImage(this.img,0,0,this.fWidth,this.fHeight,0,0,this.width,this.heigh),graphics.clearRect(0,0,this.width,this.height)},ImageAnimation.prototype.render=function(graphics,x,y,r,dt){0==this.time&&this.onBegine&&this.onBegine(),this.time+=dt;var f=Math.floor(this.time/(1/this.fps));if(this.reverse&&(f=this.fCount-f),this.loop.enable?f>this.loop.to&&(this.loop.lt++,this.loop.loopTimes>0&&this.loop.lt>=this.loop.loopTimes?(this.loop.enable=!1,f%=this.fCount):(f-=this.loop.from,f%=this.loop.to-this.loop.from,f||(f=0),f=this.loop.from+f)):this.playing&&(f>=this.fCount&&!this.reverse&&(this.frame=f=this.fCount-1,this.end()),f<=0&&this.reverse&&(this.frame=f=0,this.end())),this.playing){var F=f;this.frame!=f&&this.onFrameUpdate&&(F=this.onFrameUpdate(f)),isNaN(F)||(f=F),this.frame=f}var center=this.center.coordinate.pFrom(this.center.x,this.center.y);graphics.drawImage(this.img,this.clipX+this.fWidth*this.frame,this.clipY,this.fWidth,this.fHeight,center.x,center.y,this.width,this.heigh)},Engine.ImageAnimation=ImageAnimation,window.ImageAnimation=ImageAnimation,GameObject.CollideEventArgs=function(target){this.target=target,this.e=1,this.dff=0,this.ignore=!1},GameObject.prototype.copy=function(){var obj=new GameObject;return obj.name=this.name,this.graphic&&(obj.graphic=this.graphic.copy?this.graphic.copy():this.graphic),this.collider&&(obj.collider=this.collider.copy?this.collider.copy():this.collider),obj.mass=this.mass,obj.gravity=this.gravity,obj.onGround=this.onGround,obj.hitTest=this.hitTest,obj.constantForce=this.constantForce,obj.F=this.F.copy(),obj.v=this.v.copy(),obj.a=this.a.copy(),obj.position=this.position.copy(),obj.center=obj.position,obj.rotation=this.rotation,obj.coordinate=this.coordinate,obj.onRender=this.onRender,obj.onUpdate=this.onUpdate,obj.onStart=this.onStart,obj.onCollide=this.onCollider,obj.onMouseDown=this.onMouseDown,obj.onMouseUp=this.onMouseUp,obj.onClick=this.onClick,obj.onDoubleClick=this.onDoubleClick,obj},GameObject.prototype.setCoordinate=function(coordinate){this.center.setCoordinate(coordinate),this.position.setCoordinate(coordinate),this.graphic&&this.graphic.setCoordinate&&this.graphic.setCoordinate(coordinate),this.collider&&this.collider.setCoordinate&&this.collider.setCoordinate(coordinate),this.coordinate=coordinate},GameObject.prototype.changeCoordinate=function(coordinate){this.center.changeCoordinate(coordinate),this.position.changeCoordinate(coordinate),this.graphic&&this.graphic.changeCoordinate&&this.graphic.changeCoordinate(coordinate),this.collider&&this.collider.changeCoordinate&&this.collider.changeCoordinate(coordinate),this.coordinate=coordinate},GameObject.prototype.animate=function(properties,time,callback){var gameObject=this;for(var key in properties){for(var keys=key.split("."),lastKey=keys[keys.length-1],obj=this,i=0;i<keys.length-1;i++)obj=obj[keys[i]];!function(obj,key,from,to,time,callback){var delta=(to-from)/time;if(0!=delta){var animeCallback=function(dt){obj[key]+=delta*dt,delta<0&&obj[key]<=to?(obj[key]=to,gameObject.animationCallbackList.remove(animeCallback),callback&&callback()):delta>0&&obj[key]>=to&&(obj[key]=to,gameObject.animationCallbackList.remove(animeCallback),callback&&callback())};gameObject.animationCallbackList.add(animeCallback)}}(obj,lastKey,obj[lastKey],properties[key],time,callback)}},GameObject.prototype.stop=function(){this.animationCallbackList.length=0},GameObject.prototype.linkTo=function(gameObject){function DFS(obj,target){for(var i=0;i<obj.links.length;i++)return obj.links[i]==target||DFS(obj.links[i],target);return!1}if(DFS(gameObject,this))throw new Error("Link Loop.");gameObject.links.add(this)},GameObject.prototype.unLink=function(gameObject){var index=gameObject.links.indexOf(this);return!(index<0)&&void gameObject.links.removeAt(index)},GameObject.prototype.resetForce=function(){this.F.x=0,this.F.y=0},GameObject.prototype.resetConstantForce=function(){this.constantForce.x=0,this.constantForce.y=0},GameObject.prototype.force=function(a,b,c){if(a instanceof Force)return b?(this.constantForce.x+=a.x,this.constantForce.y+=a.y,this.constantForce):(this.F.x+=a.x,this.F.y+=a.y,this.F);if(isNaN(a)||isNaN(b))throw new Error("Paramate must be a Number.");return c?(this.constantForce.x+=a,this.constantForce.y+=b,this.constantForce):(this.F.x+=a,this.F.y+=b,this.F)},GameObject.prototype.addMomenta=function(){},GameObject.prototype.drawToCanvas=function(canvas,x,y,r,dt){this.graphic&&this.graphic.drawToCanvas(canvas,x,y,r,dt)},GameObject.prototype.render=function(graphics,x,y,r,dt){this._animCallback&&this._animCallback(dt),this.graphic&&this.graphic.render(graphics,x,y,r,dt)},GameObject.prototype.setCenter=function(x,y){this.center=new Position(x,y)},GameObject.prototype.setPosition=function(x,y){this.position=new Position(x,y);var gameObject=this;this.position.changeCallback=function(e){var dx=e.x-gameObject.position.x,dy=e.y-gameObject.position.y;gameObject.graphic&&gameObject.graphic.moveTo(gameObject.graphic.position.x+dx,gameObject.graphic.position.y+dy),gameObject.collider&&gameObject.collider!=gameObject.graphic&&gameObject.collider.moveTo(gameObject.collider.position.x+dx,gameObject.collider.position.y+dy);for(var i=0;i<gameObject.links.length;i++)gameObject.links[i].position.x+=dx,gameObject.links[i].position.y+=dy;gameObject.center.x+=dx,gameObject.center.y+=dy}},GameObject.prototype.moveTo=function(x,y){this.position.x=x,this.position.y=y},GameObject.prototype.rotate=function(rad,x,y){(isNaN(x)||isNaN(y))&&(x=this.center.x,y=this.center.y),this.graphic&&this.graphic.rotate&&this.graphic.rotate(rad,x,y),this.collider&&this.collider!=this.graphic&&this.collider.rotate&&this.collider.rotate(rad,x,y);for(var i=0;i<this.links.length;i++)this.links[i].rotate&&this.links[i].rotate(rad,x,y);this.position.rotate(rad,x,y),this.center.rotate(rad,x,y),this.rotation+=rad},GameObject.prototype.moveAnimateTo=function(x,y,t,callback){var startPosition=this.position.copy(),time=0,gameObject=this;this._animCallback=function(dt){time+=dt,time>=t&&(time=t),gameObject.moveTo((x-startPosition.x)/t*time+startPosition.x,(y-startPosition.y)/t*time+startPosition.y),time==t&&(gameObject._animCallback=null,callback&&callback())}},Engine.GameObject=GameObject,window.GameObject=GameObject,Particle.prototype.copy=function(){var p=new Particle;return p.size=this.size,this.color&&this.color.copy?p.color=this.color.copy():p.color=this.color,p.v=this.v.copy(),p},Particle.prototype.setCoordinate=function(coordinate){this.coordinate=coordinate,this.position.setCoordinate(coordinate),this.center.setCoordinate(coordinate),this.o.setCoordinate(coordinate),this.v.setCoordinate(coordinate)},Particle.prototype.changeCoordinate=function(coordinate){this.coordinate=coordinate,this.position.changeCoordinate(coordinate),this.center.changeCoordinate(coordinate),this.o.changeCoordinate(coordinate),this.v.changeCoordinate(coordinate)},Particle.prototype.move=function(dx,dy){this.position.x+=dx,this.position.y+=dy,this.center.x+=dx,this.center.y+=dy},Particle.prototype.moveTo=function(x,y){var dx=x-this.position.x,dy=y-this.position.y;this.position.x+=dx,this.position.y+=dy,this.center.x+=dx,this.center.y+=dy},Particle.prototype.setCenter=function(x,y){var dx=x-this.center.x,dy=y-this.center.y;this.center=new Point(x,y),this.o.x-=dx,this.o.y-=dy},Particle.prototype.setPosition=function(x,y){this.position=new Point(x,y)},Particle.prototype.rotate=function(rad,x,y){isNaN(x)||isNaN(y)?this.position.rotate(rad,this.center.x,this.center.y):(this.position.rotate(rad,x,y),this.center.rotate(rad,x,y)),this.rotation+=rad},Particle.prototype.rotateTo=function(rad,x,y){isNaN(x)||isNaN(y)?this.position.rotate(rad-this.rotation,this.center.x,this.center.y):(this.position.rotate(rad-this.rotation,x,y),this.center.rotate(rad-this.rotation,x,y)),this.rotation+=rad},Particle.prototype.render=function(graphics){var o=this.o.coordinate.pFrom(this.o.x,this.o.y);o.x+=this.center.x,o.y+=this.center.y,graphics.beginPath(),graphics.arc(o.x,o.y,this.size,0,2*Math.PI),graphics.fillStyle=this.color,graphics.fill()},Particle.prototype.isCollideWith=function(target,v1,v2,dt){var o=this.o.coordinate.pFrom(this.o.x,this.o.y);o.x+=this.center.x,o.y+=this.center.y;var l=new Line(o,new Point(v1.x*dt+o.x,v1.y*dt+o.y));if(target instanceof Particle){var o2=this.o.coordinate.pFrom(target.o.x,target.o.y);o2.x+=target.center.x,o2.y+=target.center.y;var l2=new Line(o,new Point(v2.x*dt+o2.x,v2.y*dt+o2.y));return l2.isCross(l)}return l.isCross(target)},Particle.prototype.collide=function(){},Engine.Particle=Particle,window.Particle=Particle,Circle.prototype.copy=function(){var circle=new Circle(this.r);return circle.setCenter(this.position.x,this.position.y),circle.angV=this.angV.copy(),circle.rotation=this.rotation,circle.coordinate=this.coordinate,circle.rigidBody=this.rigidBody,circle.e=this.e,circle.I=this.I,circle.dff=this.dff,circle["static"]=this["static"],circle.soft=this.soft,circle.strokeWidththis.strokeWidth,this.strokeStyle instanceof Color?circle.strokeStyle=this.strokeStyle.copy():circle.strokeStyle=this.strokeStyle,this.fillStyle instanceof Color?circle.fillStyle=this.fillStyle.copy():circle.fillStyle=this.fillStyle,circle},Circle.prototype.setCoordinate=function(coordinate){this.center.setCoordinate(coordinate),this.position.setCoordinate(coordinate),this.o.setCoordinate(coordinate),this.coordinate=coordinate},Circle.prototype.changeCoordinate=function(coordinate){this.center.changeCoordinate(coordinate),this.position.changeCoordinate(coordinate),this.o.changeCoordinate(coordinate),this.coordinate=coordinate},Circle.prototype.setPosition=function(x,y){this.o.x+=x-this.position.x,this.o.y+=y-this.position.y,this.position.x=x,this.position.y=y},Circle.prototype.setCenter=function(x,y){this.position.x=x,this.position.y=y},Circle.prototype.rotate=function(rad,x,y){(isNaN(x)||isNaN(y))&&(x=this.center.x,y=this.center.y),this.position.rotate(rad,x,y),this.center.rotate(rad,x,y)},Circle.prototype.moveTo=function(x,y){x==this.position.x&&y==this.position.y||(this.o.x=this.o.x-this.position.x+x,this.o.y=this.o.y-this.position.y+y,this.position.x=x,this.position.y=y)},Circle.prototype.drawToCanvas=function(canvas){var ctx=canvas.getContext("2d");ctx.beginPath(),ctx.arc(this.o.x,this.o.y,this.r,0,2*Math.PI),ctx.lineWidth=this.strokeWidth,ctx.strokeStyle=this.strokeStyle,ctx.fillStyle=this.fillStyle,ctx.fill(),ctx.stroke()},Circle.prototype.render=function(graphics){var o=this.o.coordinate.pFrom(this.o.x,this.o.y);graphics.beginPath(),graphics.arc(o.x,o.y,this.r,0,2*Math.PI),graphics.lineWidth=this.strokeWidth,graphics.strokeStyle=this.strokeStyle,graphics.fillStyle=this.fillStyle,graphics.fill(),graphics.stroke()};Circle.prototype.isCross=function(obj){return obj instanceof Line?obj.isCross(this):obj instanceof Circle?this.isCollideWith(obj):void 0};Circle.prototype.isCollideWith=function(col,v1,v2,dt){if(col instanceof Polygon)return col.isCollideWith(this);if(col instanceof Point)return(col.x-this.o.x)*(col.x-this.o.x)+(col.y-this.o.y)*(col.y-this.o.y)<=this.r*this.r;if(col instanceof Circle){var dx=this.o.x-col.o.x,dy=this.o.y-col.o.y,d=dx*dx+dy*dy;return(this.r-col.r)*(this.r-col.r)<=d&&d<=(this.r+col.r)*(this.r+col.r)}if(col instanceof Rectangle){var o=new Point(col.o.x+col.center.x,col.o.y+col.center.y);if(o.x<=this.o.x&&this.o.x<=o.x+col.width&&o.y-this.r<=this.o.y&&this.o.y<=o.y+col.height+this.r)return!0;if(o.y<=this.o.y&&this.o.y<=o.y+col.height&&o.x-this.r<=this.o.x&&this.o.x<=o.x+col.width+this.r)return!0;for(var i=0;i<4;i++){var p=col.V[i];if((p.x-this.o.x)*(p.x-this.o.x)+(p.y-this.o.y)*(p.y-this.o.y)<=this.r*this.r)return!0}return!1}return col instanceof Particle?col.isCollideWith(this,v2,v1,dt):void 0},Circle.prototype.collide=function(self,target,dt){if(self.collider.rigidBody&&target.collider.rigidBody&&(!self.collider["static"]||!target.collider["static"]))if(target.collider instanceof Circle){var args=new GameObject.CollideEventArgs;if(args.dff=Math.min(self.collider.dff,target.collider.dff),args.e=Math.min(self.collider.e,target.collider.e),self.onCollide&&(args.target=target,self.onCollide(args),args.ignore))return;if(target.onCollide&&(args.target=self,target.onCollide(args),args.ignore))return;var circle=self.collider,rect=target.collider,o1=self.collider.o,o2=target.collider.o,m1=self.mass,m2=target.mass,v0=self.v,e=args.e,v1=(args.dff,new Vector2(0,0)),v2=new Vector2(target.v.x-v0.x,target.v.y-v0.y),o21=new Vector2(o1.x-o2.x,o1.y-o2.y),n=new Vector2(o21.y,-o21.x),Lo21=o21.x*o21.x+o21.y*o21.y,Ln=n.x*n.x+n.y*n.y,vt=Vector2.multi(n,(v2.x*n.x+v2.y*n.y)/Ln),Lvn=v2.x*o21.x+v2.y*o21.y;if(Lvn<=0)return;var vn=Vector2.multi(o21,Lvn/Lo21);if(v1_=Vector2.multi(vn,(m2+e*m2)/(m1+m2)),v2_=Vector2.multi(vn,(m2-e*m1)/(m1+m2)),self.collider["static"]){var dv=Vector2.minus(v1_,v1);v1_.minus(dv),v2_.minus(dv)}else if(target.collider["static"]){var dv=Vector2.minus(v2_,vn);v1_.minus(dv),v2_.minus(dv)}if(v1_.plus(v0),v2_.plus(vt),v2_.plus(v0),self.v=v1_,target.v=v2_,!circle.soft||!rect.soft){d=Math.abs(o21.mod()-(self.collider.r+target.collider.r));var dv=Math.abs(vn.mod()),t=d/dv;t=t>dt?dt:t,self.moveTo(self.position.x+self.v.x*t,self.position.y+self.v.y*t),target.moveTo(target.position.x+target.v.x*t,target.position.y+target.v.y*t),self.v.plus(Vector2.multi(self.a,t)),target.v.plus(Vector2.multi(target.a,t))}}else{if(!(target.collider instanceof Rectangle))return target.collider instanceof Polygon?target.collider.collide(target,self,dt):void 0;var args=new GameObject.CollideEventArgs;if(args.dff=Math.min(self.collider.dff,target.collider.dff),args.e=Math.min(self.collider.e,target.collider.e),self.onCollide&&(args.target=target,self.onCollide(args),args.ignore))return;if(target.onCollide&&(args.target=self,target.onCollide(args),args.ignore))return;for(var e=args.e,m1=(args.dff,target.mass),m2=self.mass,rect=target.collider,circle=self.collider,v0=target.v,v1=new Vector2(0,0),v2=new Vector2(self.v.x-v0.x,self.v.y-v0.y),minL=null,minLD=-1,i=0;i<4;i++){var l=rect.E[i];if(!(v2.x*l.norV.x+v2.y*l.norV.y>0)){var n=new Vector2(circle.o.x-l.p1.x,circle.o.y-l.p1.y),t=l.tanV.x*n.x+l.tanV.y*n.y;
if(0<=t&&t<=l.length){var d=n.x*l.norV.x+n.y*l.norV.y;0<=d&&d<=circle.r&&(d<minLD||minLD<0)&&(minL=l,minLD=d)}}}minP=null,minPD=-1;for(var i=0;i<4;i++){var p=rect.V[i];if(!(v2.x*p.norV.x+v2.y*p.norV.y>0)){var n=new Vector2(circle.o.x-p.x,circle.o.y-p.y),d=n.mod();0<=d&&d<=circle.r&&(d<minPD||minPD<0)&&(minP=p,minPD=d)}}if(minLD<0&&minPD<0)return;var vn=null,vt=null,d=0;if(minPD<0||minLD>0&&minLD<=minPD)d=minLD,vn=Vector2.multi(minL.norV,v2.x*minL.norV.x+v2.y*minL.norV.y),vt=new Vector2(v2.x-vn.x,v2.y-vn.y);else{if(!(minLD<0||minPD>=0&&minPD<minLD))return;d=minPD;var n=new Vector2(minP.x-circle.o.x,minP.y-circle.o.y),Ln=n.x*n.x+n.y*n.y;vn=Vector2.multi(n,(n.x*v2.x+n.y*v2.y)/Ln),vt=new Vector2(v2.x-vn.x,v2.y-vn.y)}if(!vn||!vt)return;if(v1_=Vector2.multi(vn,(m2+e*m2)/(m1+m2)),v2_=Vector2.multi(vn,(m2-e*m1)/(m1+m2)),target.collider["static"]){var dv=Vector2.minus(v1_,v1);v1_.minus(dv),v2_.minus(dv)}else if(self.collider["static"]){var dv=Vector2.minus(v2_,vn);v1_.minus(dv),v2_.minus(dv)}var dv=v2;if(v2_.plus(vt),v2_.plus(v0),v1_.plus(v0),target.v=v1_,self.v=v2_,!circle.soft||!rect.soft){d=Math.abs(d);var dv=Math.abs(vn.mod()),t=d/dv;t=t>dt?dt:t,self.moveTo(self.position.x+self.v.x*t,self.position.y+self.v.y*t),target.moveTo(target.position.x+target.v.x*t,target.position.y+target.v.y*t),self.v.plus(Vector2.multi(self.a,t)),target.v.plus(Vector2.multi(target.a,t))}}},Colliders.Circle=Circle,window.Circle=Circle,Polygon.createRect=function(x,y,width,height){var v=[];return v[0]=new Point(x,y),v[1]=new Point(x+width,y),v[2]=new Point(x+width,y+height),v[3]=new Point(x,y+height),new Polyon(v)},Polygon.prototype.copy=function(){for(var v=[],i=0;i<this.V.length;i++)v[i]=new Point(this.V[i].x,this.V[i].y);var pol=new Polygon(v);return pol.angV=this.angV,pol.rotation=this.rotation,pol.coordinate=this.coordinate,pol.rigidBody=this.rigidBody,pol.e=this.e,pol.I=this.I,pol.dff=this.dff,pol["static"]=this["static"],pol.soft=this.soft,pol.setCenter(this.center.x,this.center.y),pol.strokeWidth=this.strokeWidth,this.strokeStyle instanceof Color?pol.strokeStyle=this.strokeStyle.copy():pol.strokeStyle=this.strokeStyle,this.fillStyle instanceof Color?pol.fillStyle=this.fillStyle.copy():pol.fillStyle=this.fillStyle,pol},Polygon.prototype.setCoordinate=function(coordinate){for(var i=0;i<this.V.length;i++)this.V[i].setCoordinate(coordinate);for(var i=0;i<this.E.length;i++)this.E[i].setCoordinate(coordinate);this.position.setCoordinate(coordinate),this.center.setCoordinate(coordinate),this.coordinate=coordinate},Polygon.prototype.changeCoordinate=function(coordinate){for(var i=0;i<this.V.length;i++)this.V[i].changeCoordinate(coordinate);for(var i=0;i<this.E.length;i++)this.E[i].changeCoordinate(coordinate);this.position.changeCoordinate(coordinate),this.center.changeCoordinate(coordinate),this.coordinate=coordinate},Polygon.prototype.moveTo=function(x,y){for(var dx=x-this.position.x,dy=y-this.position.y,i=0;i<this.V.length;i++)this.V[i].x+=dx,this.V[i].y+=dy;this.position.x=x,this.position.y=y},Polygon.prototype.rotate=function(rad,x,y){(isNaN(x)||isNaN(y))&&(x=this.center.x,y=this.center.y);for(var i=0;i<this.V.length;i++)this.V[i].rotate(rad,x,y);this.position.rotate(rad,x,y),this.center.rotate(rad,x,y),this.rotation+=rad},Polygon.prototype.setCenter=function(x,y){this.position.x=x,this.position.y=y},Polygon.prototype.getCenter=function(){if(this.V.length<3)throw new Error("3 or more points are required.");for(var sumX=0,sumY=0,i=0;i<this.V.length;i++)sumX+=this.V[i].x,sumY+=this.V[i].y;return new Point(sumX/this.V.length,sumY/this.V.length)},Polygon.prototype.beginInit=function(){this.E=[],this.constructing=!0},Polygon.prototype.addPoint=function(p){if(!this.constructing)throw new Error("Polygon isn't constructing.");var i=this.V.length;if(i>=2){var n1=new Vector2(this.V[i-1].x-this.V[i-2].x,this.V[i-1].y-this.V[i-2].y),n2=new Vector2(p.x-this.V[i-1].x,p.y-this.V[i-1].y),d=n1.x*n2.y-n1.y*n2.x;this.dir?d&&this.dir*d<0&&(this.convex=!1):this.dir=d>0?1:-1}p.lines||(p.lines=[]),this.V[i]=p},Polygon.prototype.endInit=function(){if(this.V.length<3)throw new Error("3 or more points are required.");if(!this.dir)throw new Error("Points must not in a line.");var n1=new Vector2(this.V[this.V.length-1].x-this.V[this.V.length-2].x,this.V[this.V.length-1].y-this.V[this.V.length-2].y),n2=new Vector2(this.V[0].x-this.V[this.V.length-1].x,this.V[0].y-this.V[this.V.length-1].y),d=n1.x*n2.y-n1.y*n2.x;d&&d*this.dir<0&&(this.convex=!1);for(var i=0;i<this.V.length;i++){var p1=this.V[i],p2=this.V[(i+1)%this.V.length],l=new Line(p1,p2);p1.lines[p1.lines.length]=l,p2.lines[p2.lines.length]=l,l.polygon=this;var length=Math.sqrt((p1.x-p2.x)*(p1.x-p2.x)+(p1.y-p2.y)*(p1.y-p2.y));l.length=length,l.lengthR=1/length,this.E[this.E.length]=l}this.convex&&this.dir>0?this.cw=!1:this.convex&&(this.cw=!0),this.position=this.getCenter(),this.center=this.position,this.constructing=!1},Polygon.prototype.render=function(graphics){if(graphics.beginPath(),this.V.length<3)throw new Error("The polygen must contains at least 3 points.");var v0=this.V[0].coordinate.pFrom(this.V[0].x,this.V[0].y);graphics.moveTo(v0.x,v0.y);for(var i=1;i<this.V.length;i++){var v=this.V[i].coordinate.pFrom(this.V[i].x,this.V[i].y);graphics.lineTo(v.x,v.y)}graphics.lineTo(v0.x,v0.y),graphics.lineWidth=this.strokeWidth,graphics.strokeStyle=this.strokeStyle.toString(),graphics.fillStyle=this.fillStyle.toString(),graphics.fill(),graphics.stroke()},Polygon.prototype.isCollideWith=function(col,v1,v2,dt){if(!(this.E instanceof Array))throw new Error("Something wrong with this polygon");if(col instanceof Polygon){if(!(col.E instanceof Array))throw new Error("Something wrong with the polygon");for(var i=0;i<this.E.length;i++)for(var j=0;j<col.E.length;j++)if(this.E[i].isCross(col.E[j]))return!0;return!1}if(col instanceof Circle){for(var i=0;i<this.V.length;i++){var p=this.V[i],d=(col.o.x-p.x)*(col.o.x-p.x)+(col.o.y-p.y)*(col.o.y-p.y);if(d<=col.r*col.r)return!0}for(var i=0;i<this.E.length;i++){var n,l=this.E[i];n=this.cw?new Vector2(l.p1.y-l.p2.y,l.p2.x-l.p1.x):new Vector2(l.p2.y-l.p1.y,l.p1.x-l.p2.x);var t1=new Vector2(col.o.x-l.p1.x,col.o.y-l.p1.y),t2=new Vector2(col.o.x-l.p2.x,col.o.y-l.p2.y),m1=t1.x*n.y-t1.y*n.x,m2=t2.x*n.y-t2.y*n.x;if(!(m1*m2>0)){var d=Vector2.multi(t1,n)*l.lengthR;if(d>0&&d<=col.r)return!0}}return!1}if(col instanceof Rectangle){if(!(col.E instanceof Array))throw new Error("Something wrong with the polygon");for(var i=0;i<this.V.length;i++)if(col.isCollideWith(this.V[i]))return!0;for(var i=0;i<this.E.length;i++)for(var j=0;j<col.E.length;j++)if(this.E[i].isCross(col.E[j]))return!0;return!1}return col instanceof Particle&&col.isCollideWith(this,v2,v1,dt)},Polygon.prototype.collide=function(self,target,dt){if(self.collider.rigidBody&&target.collider.rigidBody&&(!self.collider["static"]||!target.collider["static"]))if(target.collider instanceof Circle){var args=new GameObject.CollideEventArgs;if(args.dff=Math.min(self.collider.dff,target.collider.dff),args.e=Math.min(self.collider.e,target.collider.e),self.onCollide&&(args.target=target,self.onCollide(args),args.ignore))return;if(target.onCollide&&(args.target=self,target.onCollide(args),args.ignore))return;for(var P,L,e=args.e,poly=(args.dff,self.collider),circle=target.collider,v1=self.v,v2=target.v,minLD=-1,minPD=-1,i=0;i<poly.E.length;i++){var n,l=poly.E[i];n=poly.cw?new Vector2(l.p1.y-l.p2.y,l.p2.x-l.p1.x):new Vector2(l.p2.y-l.p1.y,l.p1.x-l.p2.x),n.multi(1/n.mod());var t=new Vector2(l.p2.x-l.p1.x,l.p2.y-l.p1.y);l.norV=n,l.tanV=t,t.multi(1/t.mod());var dv=Vector2.minus(v2,v1);if(!(Vector2.multi(n,dv)>0)){var po=Vector2.fromPoint(l.p1,circle.o),dt=Vector2.multi(t,Vector2.multi(t,po)).mod(),dn=Vector2.multi(po,n);0<=dn&&dn<=circle.r&&0<=dt&&dt<=l.length&&(minLD<0||dn<minLD)&&(minLD=dn,L=l)}}for(var i=0;i<poly.V.length;i++){var p=poly.V[i],n=Vector2.fromPoint(p,circle.o);if(n.multi(1/n.mod()),!(Vector2.multi(n,dv)>0)){var d=Point.Distance(p,circle.o);0<=d&&d<=circle.r&&(minPD<0||d<minPD)&&(minPD=d,P=p)}}if(minPD<0&&minLD<0)return;var N,T,d;minLD<0||minPD>=0&&minPD<minLD?(d=circle.r-minPD,N=Vector2.fromPoint(P,circle.o),N.multi(1/N.mod()),T=new Vector2(-N.y,N.x)):(minPD<0||minLD>=0&&minLD<minPD)&&(d=circle.r-minLD,N=L.norV,T=l.tanV);var v1=self.v,v2=target.v,v0=v1.copy(0),m1=self.mass,m2=target.mass;v1.minus(v0),v2.minus(v0);var dv=v2.copy(),vn=Vector2.multi(N,Vector2.multi(N,v2)),vt=Vector2.minus(v2,vn);if(v1_=Vector2.multi(vn,(m2+e*m2)/(m1+m2)),v2_=Vector2.multi(vn,(m2-e*m1)/(m1+m2)),poly["static"]){var dv=Vector2.minus(v1_,v1);v1_.minus(dv),v2_.minus(dv)}else if(circle["static"]){var dv=Vector2.minus(v2_,vn);v2_.minus(dv),v1_.minus(dv)}if(v2_.plus(vt),v1_.plus(v0),v2_.plus(v0),self.v=v1_,target.v=v2_,!poly.soft||!circle.soft){dv=Math.abs(Vector2.multi(dv,N));var t=d/dv;t=t>dt?dt:t,self.moveTo(self.position.x+self.v.x*t,self.position.y+self.v.y*t),target.moveTo(target.position.x+target.v.x*t,target.position.y+target.v.y*t)}}else if(target.collider instanceof Rectangle){var args=new GameObject.CollideEventArgs;if(args.dff=Math.min(self.collider.dff,target.collider.dff),args.e=Math.min(self.collider.e,target.collider.e),self.onCollide&&(args.target=target,self.onCollide(args),args.ignore))return;if(target.onCollide&&(args.target=self,target.onCollide(args),args.ignore))return;var e=args.e,poly=(args.dff,self.collider),rect=target.collider;poly.obj=self,rect.obj=target;for(var maxD=1,maxP=null,maxL=null,i=0;i<poly.V.length;i++){var p=poly.V[i],t=new Vector2(-(p.y-poly.center.y),p.x-poly.center.x),R=t.mod();t.multi(1/R);var v=self.v.copy(),vt=Vector2.multi(t,R*poly.angV);v.plus(vt),v.plus(Vector2.multi(target.v,-1));for(var p0=new Point(p.x-v.x*dt,p.y-v.y*dt),j=(new Line(p0,p),0);j<rect.E.length;j++){var l=rect.E[j];if(p.lines[0].isCross(l)||p.lines[1].isCross(l)){var n=l.norV,t=new Vector2(l.p2.x-l.p1.x,l.p2.y-l.p1.y),p1p=new Vector2(p.x-l.p1.x,p.y-l.p1.y);if(Vector2.multi(n,v)<0&&Vector2.multi(t,p1p)>=0&&Vector2.multi(t,p1p)/t.mod()<=t.mod()){var d=Vector2.multi(p1p,n);d<0&&(d>maxD||maxD>0)&&(maxD=d,maxP=p,maxL=l)}}}}for(var i=0;i<rect.V.length;i++){var p=rect.V[i],v=target.v.copy();v.plus(Vector2.multi(self.v,-1));var r1=Vector2.fromPoint(p,poly.center),t1=new Vector2(p.y-poly.center.y,-(p.x-poly.center.x));t1.multi(1/t1.mod());var vt1=Vector2.multi(t1,r1.mod()*poly.angV);v.plus(vt1);for(var p0=new Point(p.x-v.x*dt,p.y-v.y*dt),j=(new Line(p0,p),0);j<poly.E.length;j++){var l=poly.E[j];if(p.lines[0].isCross(l)||p.lines[1].isCross(l)){var n;n=poly.cw?new Vector2(l.p1.y-l.p2.y,l.p2.x-l.p1.x):new Vector2(l.p2.y-l.p1.y,l.p1.x-l.p2.x);var t=new Vector2(l.p2.x-l.p1.x,l.p2.y-l.p1.y),p1p=new Vector2(p.x-l.p1.x,p.y-l.p1.y);if(Vector2.multi(v,n)<0&&Vector2.multi(t,p1p)>=0&&Vector2.multi(t,p1p)/t.mod()<=t.mod()){var d=Vector2.multi(p1p,n)/n.mod();d<0&&(d>maxD||maxD>0)&&(maxD=d,maxP=p,maxL=l)}}}}if(maxD>0)return;p=maxP,l=maxL,pol1=maxL.polygon,pol2=maxP.lines[0].polygon;var obj1=pol1.obj,obj2=pol2.obj,w1=pol1.angV,w2=pol2.angV;pol1==rect?w1=0:pol2==rect&&(w2=0);var N,T,v1=obj1.v,v2=obj2.v,m1=(pol1.center,pol2.center,obj1.mass),m2=obj2.mass;pol1==rect?(N=maxL.norV,T=maxL.tanV):pol1==poly&&(N=pol1.cw?new Vector2(l.p1.y-l.p2.y,l.p2.x-l.p1.x):new Vector2(l.p2.y-l.p1.y,l.p1.x-l.p2.x),N.multi(1/N.mod()),T=new Vector2(-N.y,N.x));var v0=v1.copy(0);v1.minus(v0),v2.minus(v0);var dv=v2.copy(),vn=Vector2.multi(N,Vector2.multi(N,v2)),vt=Vector2.minus(v2,vn);if(v1_=Vector2.multi(vn,(m2+e*m2)/(m1+m2)),v2_=Vector2.multi(vn,(m2-e*m1)/(m1+m2)),pol1["static"]){var dv=Vector2.minus(v1_,v1);v1_.minus(dv),v2_.minus(dv)}else if(pol2["static"]){var dv=Vector2.minus(v2_,vn);v2_.minus(dv),v1_.minus(dv)}if(v2_.plus(vt),v1_.plus(v0),v2_.plus(v0),obj1.v=v1_,obj2.v=v2_,!pol1.soft||!pol2.soft){var pl=Vector2.fromPoint(l.p1,p),d=Math.abs(Vector2.multi(pl,N));dv=Math.abs(Vector2.multi(dv,N));var t=d/dv;t=t>dt?dt:t,obj1.moveTo(obj1.position.x+obj1.v.x*t,obj1.position.y+obj1.v.y*t),obj2.moveTo(obj2.position.x+obj2.v.x*t,obj2.position.y+obj2.v.y*t)}}else if(target.collider instanceof Polygon){var args=new GameObject.CollideEventArgs;if(args.dff=Math.min(self.collider.dff,target.collider.dff),args.e=Math.min(self.collider.e,target.collider.e),self.onCollide&&(args.target=target,self.onCollide(args),args.ignore))return;if(target.onCollide&&(args.target=self,target.onCollide(args),args.ignore))return;var e=args.e,pol1=(args.dff,self.collider),pol2=target.collider;pol1.obj=self,pol2.obj=target;for(var maxD=1,maxP=null,maxL=null,i=0;i<pol1.V.length;i++){var p=pol1.V[i],t=new Vector2(-(p.y-pol1.center.y),p.x-pol1.center.x),R=t.mod();t.x/=R,t.y/=R;var v=self.v.copy(),vt=Vector2.multi(t,R*pol1.angV);v.plus(vt),v.plus(Vector2.multi(target.v,-1));var r2=Vector2.fromPoint(p,pol2.center),t2=new Vector2(p.y-pol2.center.y,-(p.x-pol2.center.x));t2.multi(1/t2.mod());var vt2=Vector2.multi(t2,r2.mod()*pol2.angV);v.plus(vt2);for(var p0=new Point(p.x-v.x*dt,p.y-v.y*dt),j=(new Line(p0,p),0);j<pol2.E.length;j++){var l=pol2.E[j];if(p.lines[0].isCross(l)||p.lines[1].isCross(l)){var n;n=pol2.cw?new Vector2(l.p1.y-l.p2.y,l.p2.x-l.p1.x):new Vector2(l.p2.y-l.p1.y,l.p1.x-l.p2.x);var t=new Vector2(l.p2.x-l.p1.x,l.p2.y-l.p1.y),p1p=new Vector2(p.x-l.p1.x,p.y-l.p1.y);if(Vector2.multi(n,v)<0&&Vector2.multi(t,p1p)>=0&&Vector2.multi(t,p1p)/t.mod()<=t.mod()){var d=Vector2.multi(p1p,n)/n.mod();d<0&&(d>maxD||maxD>0)&&(maxD=d,maxP=p,maxL=l)}}}}for(var i=0;i<pol2.V.length;i++){var p=pol2.V[i],t=new Vector2(-(p.y-pol2.center.y),p.x-pol2.center.x),R=t.mod();t.x/=R,t.y/=R;var v=target.v.copy(),vt=Vector2.multi(t,R*pol2.angV);v.plus(vt),v.plus(Vector2.multi(self.v,-1));var r1=Vector2.fromPoint(p,pol1.center),t1=new Vector2(p.y-pol1.center.y,-(p.x-pol1.center.x));t1.multi(1/t1.mod());var vt1=Vector2.multi(t1,r1.mod()*pol1.angV);v.plus(vt1);for(var p0=new Point(p.x-v.x*dt,p.y-v.y*dt),j=(new Line(p0,p),0);j<pol1.E.length;j++){var l=pol1.E[j];if(p.lines[0].isCross(l)||p.lines[1].isCross(l)){var n;n=pol1.cw?new Vector2(l.p1.y-l.p2.y,l.p2.x-l.p1.x):new Vector2(l.p2.y-l.p1.y,l.p1.x-l.p2.x);var t=new Vector2(l.p2.x-l.p1.x,l.p2.y-l.p1.y),p1p=new Vector2(p.x-l.p1.x,p.y-l.p1.y);if(Vector2.multi(v,n)<0&&Vector2.multi(t,p1p)>=0&&Vector2.multi(t,p1p)/t.mod()<=t.mod()){var d=Vector2.multi(p1p,n)/n.mod();d<0&&(d>maxD||maxD>0)&&(maxD=d,maxP=p,maxL=l)}}}}if(maxD>0)return;p=maxP,l=maxL,pol1=maxL.polygon,pol2=maxP.lines[0].polygon;var N,obj1=pol1.obj,obj2=pol2.obj,v1=obj1.v,v2=obj2.v,m1=(pol1.center,pol2.center,obj1.mass),m2=obj2.mass;N=pol1.cw?new Vector2(l.p1.y-l.p2.y,l.p2.x-l.p1.x):new Vector2(l.p2.y-l.p1.y,l.p1.x-l.p2.x),N.multi(1/N.mod());var T=new Vector2(-N.y,N.x),v0=v1.copy(0);v1.minus(v0),v2.minus(v0);var dv=v2.copy(),vn=Vector2.multi(N,Vector2.multi(N,v2)),vt=Vector2.minus(v2,vn);if(v1_=Vector2.multi(vn,(m2+e*m2)/(m1+m2)),v2_=Vector2.multi(vn,(m2-e*m1)/(m1+m2)),pol1["static"]){var dv=Vector2.minus(v1_,v1);v1_.minus(dv),v2_.minus(dv)}else if(pol2["static"]){var dv=Vector2.minus(v2_,vn);v2_.minus(dv),v1_.minus(dv)}if(v2_.plus(vt),v1_.plus(v0),v2_.plus(v0),obj1.v=v1_,obj2.v=v2_,!pol1.soft||!pol2.soft){var pl=Vector2.fromPoint(l.p1,p),d=Math.abs(Vector2.multi(pl,N));dv=Math.abs(Vector2.multi(dv,N));var t=d/dv;t=t>dt?dt:t,obj1.moveTo(obj1.position.x+obj1.v.x*t,obj1.position.y+obj1.v.y*t),obj2.moveTo(obj2.position.x+obj2.v.x*t,obj2.position.y+obj2.v.y*t)}}},Colliders.Polygon=Polygon,window.Polygon=Polygon,Rectangle.prototype.copy=function(){var rect=new Rectangle(this.width,this.height);return rect.o=this.o.copy(),rect.position=this.position.copy(),rect.coordinate=this.coordinate,rect.rigidBody=this.rigidBody,rect.e=this.e,rect.dff=this.dff,rect.I=this.I,rect["static"]=this["static"],rect.soft=this.soft,rect.landed=this.landed,this.strokeStyle instanceof Color?rect.strokeStyle=this.strokeStyle.copy():rect.strokeStyle=this.strokeStyle,this.fillStyle instanceof Color?rect.fillStyle=this.fillStyle.copy():rect.fillStyle=this.fillStyle,rect},Rectangle.prototype.setCoordinate=function(coordinate){this.position.setCoordinate(coordinate),this.center.setCoordinate(coordinate),this.coordinate=coordinate},Rectangle.prototype.changeCoordinate=function(coordinate){this.position.changeCoordinate(coordinate),this.center.changeCoordinate(coordinate),this.coordinate=coordinate},Rectangle.prototype.setCenterPoint=function(x,y){var dx=x-this.center.x,dy=y-this.center.x;this.center.x=x,this.center.y=y,this.o.x-=dx,this.o.y-=dy},Rectangle.prototype.setPositionPoint=function(x,y){this.position.x=x,this.position.y=y},Rectangle.prototype.moveTo=function(x,y){for(var dx=x-this.position.x,dy=y-this.position.y,i=0;i<4;i++)this.V[i].x+=dx,this.V[i].y+=dy;this.center.x+=dx,this.center.y+=dy,this.position.x=x,this.position.y=y},Rectangle.prototype.rotate=function(rad,x,y){(isNaN(x)||isNaN(y))&&(x=this.center.x,y=this.center.y),this.position.rotate(x,y),this.center.rotate(x,y)},Rectangle.prototype.drawToCanvas=function(canvas){var ctx=canvas.getContext("2d");ctx.fillStyle=this.fillStyle,ctx.strokeStyle=this.strokeStyle,ctx.fillRect(this.o.x,this.o.y,this.width,this.height),ctx.strokeRect(this.o.x,this.o.y,this.width,this.height)},Rectangle.prototype.render=function(graphic){graphic.fillStyle=this.fillStyle,graphic.strokeStyle=this.strokeStyle;var o=this.center.coordinate.pFrom(this.center.x,this.center.y);o.x+=this.o.x,o.y+=this.o.y,graphic.fillRect(o.x,o.y+this.height,this.width,this.height),graphic.strokeRect(o.x,o.y+this.height,this.width,this.height)},Rectangle.prototype.isCollideWith=function(obj,v1,v2,dt){if(obj instanceof Ground){var o=new Point(this.o.x+this.center.x,this.o.y+this.center.y);return!(o.x>obj.xR||o.x+this.width<obj.xL)&&o.y>=obj.y&&obj.y>=o.y-this.height}if(obj instanceof Wall){var o=new Point(this.o.x+this.center.x,this.o.y+this.center.y);return!(o.y-this.height>obj.yH||o.y<obj.yL)&&o.x<=obj.x&&obj.x<=o.x+this.width}if(obj instanceof Rectangle){var o=new Point(this.o.x+this.center.x,this.o.y+this.center.y),oTarget=new Point(obj.o.x+obj.center.x,obj.o.y+obj.center.y);return o.x-obj.width<=oTarget.x&&oTarget.x<=o.x+this.width&&o.y-obj.height<=oTarget.y&&oTarget.y<=o.y+this.height}else{if(obj instanceof Point){var o=new Point(this.o.x+this.center.x,this.o.y+this.center.y);return o.x<=obj.x&&obj.x<=o.x+this.width&&o.y<=obj.y&&obj.y<=o.y+this.height}if(obj instanceof Circle)return obj.isCollideWith(this);if(obj instanceof Polygon)return obj.isCollideWith(this);if(obj instanceof Particle)return obj.isCollideWith(this,v2,v1,dt)}},Rectangle.prototype.collide=function(self,target,dt){if(self.collider.rigidBody&&target.collider.rigidBody&&(!self.collider["static"]||!target.collider["static"]))if(target.collider instanceof Rectangle){var args=new GameObject.CollideEventArgs;if(args.dff=Math.min(self.collider.dff,target.collider.dff),args.e=Math.min(self.collider.e,target.collider.e),self.onCollide&&(args.target=target,self.onCollide(args),args.ignore))return;if(target.onCollide&&(args.target=self,target.onCollide(args),args.ignore))return;var e=(args.dff,args.e),dx=-1,dy=-1,v0=self.v,v1=new Vector2(0,0),v2=new Vector2(target.v.x-v0.x,target.v.y-v0.y),rect1=self.collider,rect2=target.collider,m1=self.mass,m2=target.mass,o1=new Point(rect1.center.x+rect1.o.x,rect1.center.y+rect1.o.y),o2=new Point(rect2.center.x+rect2.o.x,rect2.center.y+rect2.o.y);if(target.v.x-self.v.x<0?dx=Math.abs(o1.x+rect1.width-o2.x):target.v.x-self.v.x>0?dx=Math.abs(o2.x+rect2.width-o1.x):target.v.x-self.v.x==0&&(dx=Math.min(Math.abs(o1.x+rect1.width-o2.x),Math.abs(o2.x+rect2.width-o1.x))),target.v.y-self.v.y<0?dy=Math.abs(o1.y+rect1.height-o2.y):target.v.y-self.v.y>0?dy=Math.abs(o2.y+rect2.height-o1.y):target.v.y-self.v.y==0&&(dy=Math.min(Math.abs(o1.y+rect1.height-o2.y),Math.abs(o2.y+rect2.height-o1.y))),dx>=0&&dx<=dy||dy<0){var v1x=v2.x*((m2+e*m2)/(m1+m2)),v2x=v2.x*((m2-e*m1)/(m1+m2));if(rect1["static"]){var dv=v1x-v1.x;v1x-=dv,v2x-=dv}else if(rect2["static"]){var dv=v2x-v2.x;v1x-=dv,v2x-=dv}var dv=v2.x;if(v1.x=v1x,v2.x=v2x,v2.plus(v0),v1.plus(v0),self.v=v1,target.v=v2,!rect1.soft||!rect2.soft){var d=Math.abs(dx),t=Math.abs(d/dv);t=t>dt?dt:t,self.moveTo(self.position.x+self.v.x*t,self.position.y+self.v.y*t),target.moveTo(target.position.x+target.v.x*t,target.position.y+target.v.y*t)}}else if(dy>=0&&dy<=dx||dx<0){var v1y=v2.y*((m2+e*m2)/(m1+m2)),v2y=v2.y*((m2-e*m1)/(m1+m2));if(rect1["static"]){var dv=v1y-v1.y;v1y-=dv,v2y-=dv}else if(rect2["static"]){var dv=v2y-v2.y;v1y-=dv,v2y-=dv}var dv=v2.y;v1.y=v1y,v2.y=v2y,v2.plus(v0),v1.plus(v0);var t=dy/Math.abs(self.v.y-target.v.y);if(t=isNaN(t)?0:t,self.v=v1,target.v=v2,!rect1.soft||!rect2.soft){var d=dy,t=Math.abs(d/dv);t=t>dt?dt:t,self.moveTo(self.position.x+self.v.x*t,self.position.y+self.v.y*t),target.moveTo(target.position.x+target.v.x*t,target.position.y+target.v.y*t)}}}else if(target.collider instanceof Ground){if(self.collider.o.y-self.collider.height<=target.collider.y){var t=(self.collider.o.y-self.collider.height-target.collider.y)/self.v.y;t=isNaN(t)?0:t,self.moveTo(self.position.x,self.position.y-self.v.y*t),self.v.y=-self.v.y*self.collider.bounce,self.gravity&&(self.collider.landed=!0)}}else if(target.collider instanceof Wall);else{if(target.collider instanceof Circle)return target.collider.collide(target,self,dt);if(target.collider instanceof Polygon)return target.collider.collide(target,self,dt)}},Colliders.Rectangle=Rectangle,window.Rectangle=Rectangle,Ground.prototype.copy=function(){var g=new Ground(this.y,this.xL,this.xR);return g.rigidBody=this.rigidBody,g["static"]=this["static"],g.position=this.position.copy(),g},Ground.prototype.moveTo=function(x,y){this.y=y,this.position.x=x,this.position.y=y},Ground.prototype.setCenter=function(x,y,align){this.y=y,this.xL=x-align(this.xR-this.xL).x,this.xR=this.xL+this.width},Ground.prototype.drawToCanvas=function(canvas){return},Ground.prototype.render=function(){},Ground.prototype.toGameObject=function(){var obj=new GameObject;return obj.collider=this,obj.graphic=this,obj.mass=1,obj.gravity=!1,obj},Ground.prototype.isCollideWith=function(col){return col instanceof Rectangle?col.isCollideWith(this):col instanceof Circle?col.isCollideWith(this):void 0},Ground.prototype.collide=function(ground,obj,dt){if(obj.collider instanceof Rectangle)return obj.collider.collide(obj,ground,dt)},Colliders.Ground=Ground,window.Ground=Ground,Wall.prototype.copy=function(){var w=new Wall(this.x,this.yL,this.yH);w.rigidBody=this.rigidBody,w["static"]=this["static"],w.position=this.position.copy()},Wall.prototype.toGameObject=function(){var obj=new GameObject;return obj.collider=this,obj.graphic=this,obj.mass=1,obj.gravity=!1,obj},Wall.prototype.setCenter=function(x,y,align){this.x=x,this.yH=y+align(this.height),this.yL=this.yH-this.height,this.position.x=x,this.position.y=y},Wall.prototype.moveTo=function(x,y){this.x+=x-this.position.x,this.yH+=y-this.position.y,this.yL+=y-this.position.y,this.position.x=x,this.position.y=y},Wall.prototype.isCollideWith=function(col){if(col instanceof Rectangle)return col.isCollideWith(this)},Colliders.Wall=Wall,window.Wall=Wall,Engine.Colliders=Colliders,window.Colliders=Colliders,LinkList.version=1,LinkList.Node=function(obj,last,next){this.object=obj,last?this.last=last:this.last=null,next?this.next=next:this.next=null},LinkList.prototype.add=function(obj){if(this.count<=0)return this.head=new LinkList.Node(obj,null,null),this.head.parent=this,this.tail=this.head,this.count=1,this.head;var node=new LinkList.Node(obj,this.tail,null);return node.parent=this,this.tail.next=node,this.tail=node,this.count++,node},LinkList.prototype.remove=function(node){if(node.parent!=this)throw new Error("The node doesn't belong to this link list");null==node.last?this.head=node.next:node.last.next=node.next,null==node.next?this.tail=node.last:node.next.last=node.last,this.count--},LinkList.prototype.foreach=function(callback){if(!callback)throw new Error("A callback function is require.");for(var p=this.head,p=this.head;p;p=p.next){var br=callback(p.object,p);if(br)return}},(!window.LinkList||!window.LinkList.version||window.LinkList.version<LinkList.version)&&(window.LinkList=LinkList),int=parseInt,Color.version=2,Color.random=function(){return new Color(255*Math.random(),255*Math.random(),255*Math.random(),1)},Color.fromString=function(str){str=str.replace(new RegExp(/\s/g),"");var reg=new RegExp("#[0-9a-fA-F]{6}");if(reg.test(str)){str=str.replace("#","");var strR=str.charAt(0)+str.charAt(1),strG=str.charAt(2)+str.charAt(3),strB=str.charAt(4)+str.charAt(5),r=parseInt(strR,16),g=parseInt(strG,16),b=parseInt(strB,16);return new Color(r,g,b,1)}if(reg=new RegExp("rgb\\(([0-9]+(\\.[0-9]+){0,1}),([0-9]+(\\.[0-9]+){0,1}),([0-9]+(\\.[0-9]+){0,1})\\)"),reg.test(str)){var colorArray=str.replace("rgb(","").replace(")","").split(","),r=parseInt(colorArray[0]),g=parseInt(colorArray[1]),b=parseInt(colorArray[2]),a=1;return new Color(r,g,b,a)}if(reg=new RegExp("rgba\\(([0-9]+(\\.[0-9]+){0,1}),([0-9]+(\\.[0-9]+){0,1}),([0-9]+(\\.[0-9]+){0,1}),([0-9]+(\\.[0-9]+){0,1})\\)"),reg.test(str)){var colorArray=str.replace("rgba(","").replace(")","").split(","),r=parseInt(colorArray[0]),g=parseInt(colorArray[1]),b=parseInt(colorArray[2]),a=parseFloat(colorArray[3]);return new Color(r,g,b,a)}switch(str){case"transparent":return new Color(255,255,255,0);case"aliceblue":return new Color(240,248,255,1);case"antiquewhite":return new Color(250,235,215,1);case"aqua":return new Color(0,255,255,1);case"aquamarine":return new Color(127,255,212,1);case"azure":return new Color(240,255,255,1);case"beige":return new Color(245,245,220,1);case"bisque":return new Color(255,228,196,1);case"black":return new Color(0,0,0,1);case"blanchedalmond":return new Color(255,235,205,1);case"blue":return new Color(0,0,255,1);case"blueviolet":return new Color(138,43,226,1);case"brown":return new Color(165,42,42,1);case"burlywood":return new Color(222,184,135,1);case"cadetblue":return new Color(95,158,160,1);case"chartreuse":return new Color(127,255,0,1);case"chocolate":return new Color(210,105,30,1);case"coral":return new Color(255,127,80,1);case"cornflowerblue":return new Color(100,149,237,1);case"cornsilk":return new Color(255,248,220,1);case"crimson":return new Color(220,20,60,1);case"cyan":return new Color(0,255,255,1);case"darkblue":return new Color(0,0,139,1);case"darkcyan":return new Color(0,139,139,1);case"darkgoldenrod":return new Color(184,134,11,1);case"darkgray":return new Color(169,169,169,1);case"darkgreen":return new Color(0,100,0,1);case"darkgrey":return new Color(169,169,169,1);case"darkkhaki":return new Color(189,183,107,1);case"darkmagenta":return new Color(139,0,139,1);case"darkolivegreen":return new Color(85,107,47,1);case"darkorange":return new Color(255,140,0,1);case"darkorchid":return new Color(153,50,204,1);case"darkred":return new Color(139,0,0,1);case"darksalmon":return new Color(233,150,122,1);case"darkseagreen":return new Color(143,188,143,1);case"darkslateblue":return new Color(72,61,139,1);case"darkslategray":return new Color(47,79,79,1);case"darkslategrey":return new Color(47,79,79,1);case"darkturquoise":return new Color(0,206,209,1);case"darkviolet":return new Color(148,0,211,1);case"deeppink":return new Color(255,20,147,1);case"deepskyblue":return new Color(0,191,255,1);case"dimgray":return new Color(105,105,105,1);case"dimgrey":return new Color(105,105,105,1);case"dodgerblue":return new Color(30,144,255,1);case"firebrick":return new Color(178,34,34,1);case"floralwhite":return new Color(255,250,240,1);case"forestgreen":return new Color(34,139,34,1);case"fuchsia":return new Color(255,0,255,1);case"gainsboro":return new Color(220,220,220,1);case"ghostwhite":return new Color(248,248,255,1);case"gold":return new Color(255,215,0,1);case"goldenrod":return new Color(218,165,32,1);case"gray":return new Color(128,128,128,1);case"green":return new Color(0,128,0,1);case"greenyellow":return new Color(173,255,47,1);case"grey":return new Color(128,128,128,1);case"honeydew":return new Color(240,255,240,1);case"hotpink":return new Color(255,105,180,1);case"indianred":return new Color(205,92,92,1);case"indigo":return new Color(75,0,130,1);case"ivory":return new Color(255,255,240,1);case"khaki":return new Color(240,230,140,1);case"lavender":return new Color(230,230,250,1);case"lavenderblush":return new Color(255,240,245,1);case"lawngreen":return new Color(124,252,0,1);case"lemonchiffon":return new Color(255,250,205,1);case"lightblue":return new Color(173,216,230,1);case"lightcoral":return new Color(240,128,128,1);case"lightcyan":return new Color(224,255,255,1);case"lightgoldenrodyellow":return new Color(250,250,210,1);case"lightgray":return new Color(211,211,211,1);case"lightgreen":return new Color(144,238,144,1);case"lightgrey":return new Color(211,211,211,1);case"lightpink":return new Color(255,182,193,1);case"lightsalmon":return new Color(255,160,122,1);case"lightseagreen":return new Color(32,178,170,1);case"lightskyblue":return new Color(135,206,250,1);case"lightslategray":return new Color(119,136,153,1);case"lightslategrey":return new Color(119,136,153,1);case"lightsteelblue":return new Color(176,196,222,1);case"lightyellow":return new Color(255,255,224,1);case"lime":return new Color(0,255,0,1);case"limegreen":return new Color(50,205,50,1);case"linen":return new Color(250,240,230,1);case"magenta":return new Color(255,0,255,1);case"maroon":return new Color(128,0,0,1);case"mediumaquamarine":return new Color(102,205,170,1);case"mediumblue":return new Color(0,0,205,1);case"mediumorchid":return new Color(186,85,211,1);case"mediumpurple":return new Color(147,112,219,1);case"mediumseagreen":return new Color(60,179,113,1);case"mediumslateblue":return new Color(123,104,238,1);case"mediumspringgreen":return new Color(0,250,154,1);case"mediumturquoise":return new Color(72,209,204,1);case"mediumvioletred":return new Color(199,21,133,1);case"midnightblue":return new Color(25,25,112,1);case"mintcream":return new Color(245,255,250,1);case"mistyrose":return new Color(255,228,225,1);case"moccasin":return new Color(255,228,181,1);case"navajowhite":return new Color(255,222,173,1);case"navy":return new Color(0,0,128,1);case"oldlace":return new Color(253,245,230,1);case"olive":return new Color(128,128,0,1);case"olivedrab":return new Color(107,142,35,1);case"orange":return new Color(255,165,0,1);case"orangered":return new Color(255,69,0,1);case"orchid":return new Color(218,112,214,1);case"palegoldenrod":return new Color(238,232,170,1);case"palegreen":return new Color(152,251,152,1);case"paleturquoise":return new Color(175,238,238,1);case"palevioletred":return new Color(219,112,147,1);case"papayawhip":return new Color(255,239,213,1);case"peachpuff":return new Color(255,218,185,1);case"peru":return new Color(205,133,63,1);case"pink":return new Color(255,192,203,1);case"plum":return new Color(221,160,221,1);case"powderblue":return new Color(176,224,230,1);case"purple":return new Color(128,0,128,1);case"red":return new Color(255,0,0,1);case"rosybrown":return new Color(188,143,143,1);case"royalblue":return new Color(65,105,225,1);case"saddlebrown":return new Color(139,69,19,1);case"salmon":return new Color(250,128,114,1);case"sandybrown":return new Color(244,164,96,1);case"seagreen":return new Color(46,139,87,1);case"seashell":return new Color(255,245,238,1);case"sienna":return new Color(160,82,45,1);case"silver":return new Color(192,192,192,1);case"skyblue":return new Color(135,206,235,1);case"slateblue":return new Color(106,90,205,1);case"slategray":return new Color(112,128,144,1);case"slategrey":return new Color(112,128,144,1);case"snow":return new Color(255,250,250,1);case"springgreen":return new Color(0,255,127,1);case"steelblue":return new Color(70,130,180,1);case"tan":return new Color(210,180,140,1);case"teal":return new Color(0,128,128,1);case"thistle":return new Color(216,191,216,1);case"tomato":return new Color(255,99,71,1);case"turquoise":return new Color(64,224,208,1);case"violet":return new Color(238,130,238,1);case"wheat":return new Color(245,222,179,1);case"white":return new Color(255,255,255,1);case"whitesmoke":
return new Color(245,245,245,1);case"yellow":return new Color(255,255,0,1);case"yellowgreen":return new Color(154,205,50,1);default:return new Color(0,0,0,1)}},Color.prototype.copy=function(){return new Color(this.red,this.green,this.blue,this.alpha)},Color.prototype.toString=function(){return this.red=this.red>255?255:this.red,this.green=this.green>255?255:this.green,this.blue=this.blue>255?255:this.blue,this.alpha=this.realphad>1?1:this.alpha,this.red=this.red<0?0:this.red,this.green=this.green<0?0:this.green,this.blue=this.blue<0?0:this.blue,this.alpha=this.alpha<0?0:this.alpha,"rgba("+parseInt(this.red).toString()+","+parseInt(this.green).toString()+","+parseInt(this.blue).toString()+","+this.alpha.toString()+")"},Color.prototype.equal=function(color){return!(!color instanceof Color)&&(color.red==this.red&&color.green==this.green&&color.blue==this.blue&&color.alpha==this.alpha)},window.Color&&window.Color.version&&window.Color.version>2||(window.Color=Color),Thickness.prototype.copy=function(){return new Thickness(this.top,this.bottom,this.left,this.right)},window.Thickness=Thickness;var VerAlign={};VerAlign.Top=1,VerAlign.Bottom=2,VerAlign.Center=0,VerAlign.Stretch=3,window.VerAlign=VerAlign;var HorAlign={};return HorAlign.Left=1,HorAlign.Right=2,HorAlign.Center=0,HorAlign.Stretch=3,window.HorAlign=HorAlign,GUI.prototype.copy=function(){var gui=new GUI;gui.controls=this.controls,gui.ctrlList=this.ctrlList,gui.width=this.width,gui.height=this.height,gui.textCalcu=this.textCalcu,this.onRender=this.onRender,this.onMouseDown=this.onMouseDown,this.onMouseUp=this.onMouseUp,this.onMouseMove=this.onMouseMove,this.onClick=this.onClick,this.onDoubleClick=this.onDoubleClick,this.onTouchStart=this.onTouchStart,this.onTouchEnd=this.onTouchEnd,this.onTouchMove=this.onTouchMove},GUI.prototype.addControl=function(obj){this.children.add(obj),obj.parent=this},GUI.prototype.render=function(graphics){this.width=graphics.canvas.width,this.height=graphics.canvas.height;this.onRender&&this.onRender(),this.children.foreach(function(obj){obj.render&&obj.render(graphics)})},GUI.prototype.mouseMoveCallback=function(e){this.children.foreach(function(child){if(child.mouseMoveCallback&&child.isPointIn&&child.isPointIn(e.x,e.y)&&(child.mouseMoveCallback(e),e.handled))return!0}),e.handled||this.onMouseMove&&this.onMouseMove(e)},GUI.prototype.mouseDownCallback=function(e){this.children.foreach(function(child){if(child.mouseDownCallback&&child.isPointIn&&child.isPointIn(e.x,e.y)&&(child.mouseDownCallback(e),e.handled))return!0}),e.handled||this.onMouseDown&&this.onMouseDown(e)},GUI.prototype.mouseUpCallback=function(e){this.children.foreach(function(child){if(child.mouseUpCallback&&(child.mouseUpCallback(e),e.handled))return!0}),e.handled||this.onMouseUp&&this.onMouseUp(e)},GUI.prototype.clickCallback=function(e){this.children.foreach(function(child){if(child.clickCallback&&child.isPointIn&&child.isPointIn(e.x,e.y)&&(child.clickCallback(e),e.handled))return!0}),e.handled||this.onClick&&this.onClick(e)},GUI.prototype.doubleClickCallback=function(e){this.children.foreach(function(child){if(child.doubleClickCallback&&child.isPointIn&&child.isPointIn(e.x,e.y)&&(child.doubleClickCallback(e),e.handled))return!0}),e.handled||this.onDoubleClick&&this.onDoubleClick(e)},GUI.prototype.touchStartCallback=function(e){this.children.foreach(function(child){if(child.touchStartCallback&&child.isPointIn&&child.isPointIn(e.x,e.y)&&(child.touchStartCallback(e),e.handled))return!0}),e.handled||this.onTouchStart&&this.onTouchStart(e)},GUI.prototype.touchEndCallback=function(e){this.children.foreach(function(child){for(var i=0;i<e.touches.length;i++)if(child.isPointIn&&child.isPointIn(e.touches[i].x,e.touches[i].y))return;if(child.touchEndCallback&&(child.touchEndCallback(e),e.handled))return!0}),e.handled||this.onTouchEnd&&this.onTouchEnd(e)},GUI.prototype.touchMoveCallback=function(e){this.children.foreach(function(child){if(child.touchMoveCallback&&(child.touchMoveCallback(e),e.handled))return!0}),e.handled||this.onTouchMove&&this.onTouchMove(e)},Engine.GUI=GUI,window.GUI=GUI,Block.prototype.render=function(graphics){this.bgColor&&this.bgColor.alpha>0||this.color&&this.color.alpha>0&&this.border>0,this.children.foreach(function(child){child.render&&child.render(graphics)})},Button.prototype.copy=function(){var button=new Button(this.content);return button.parent=this.parent,button.width=this.width,button.width=this.width,button.widthAuto=this.widthAuto,button.height=this.height,button.heightAuto=this.heightAuto,button.x=this.x,button.y=this.y,button.margin=this.margin.copy(),button.padding=this.padding.copy(),button.horAlign=this.horAlign,button.verAlign=this.verAlign,button.color=this.color.copy(),button.bgColor=this.bgColor.copy(),this.border instanceof Thickness?button.border=this.border.copy():button.border=this.border,button.radius=this.radius,button.font=this.font,this.collider&&this.collider.copy?button.collider=this.collider.copy():button.collider=this.collider,button.onClick=this.onClick,button.onMouseDown=this.onMouseDown,button.onMouseUp=this.onMouseUp,button.onMouseMove=this.onMouseMove,button.onTouchStart=this.onTouchStart,button.onTouchEnd=this.onTouchEnd,button.onTouchMove=this.onTouchMove,button},Button.prototype.render=function(graphics){this.onRender&&this.onRender(),graphics.font=this.font;var h=1.15*parseInt(this.font.fontSize),w=graphics.measureText(this.content).width,x=0,y=0,wx=0,wy=0,mW=this.parent.width,mH=this.parent.height;switch(this.widthAuto&&(this.horAlign==HorAlign.Stretch?(this.width=mW-this.margin.left-this.margin.right,this.width=this.width<0?0:this.width):(this.width=this.padding.left+w+this.padding.right,this.margin.left+this.width+this.margin.right>mW&&(this.width=mW-this.margin.left-this.margin.right),this.width=this.width<0?0:this.width)),w=this.width-this.padding.left-this.padding.right,w=w<0?0:w,this.horAlign){case HorAlign.Left:x=this.margin.left;break;case HorAlign.Right:x=mW-this.margin.right-this.width;break;case HorAlign.Stretch:x=(mW-this.margin.left-this.margin.right)/2-this.width/2+this.margin.left;break;case HorAlign.Center:x=(mW-this.width)/2+this.margin.left-this.margin.right}switch(this.heightAuto&&(this.verAlign==VerAlign.Stretch?(this.height=mH-this.margin.top-this.margin.bottom,this.height=this.height<0?0:this.height):(this.height=this.padding.top+h+this.padding.bottom,this.margin.top+this.height+this.margin.bottom>mH&&(this.height=mH-this.margin.top-this.margin.bottom),this.height=this.height<0?0:this.height)),h=this.height-this.padding.top-this.padding.bottom,h=h<0?0:h,this.verAlign){case VerAlign.Top:y=this.margin.top;break;case VerAlign.Bottom:y=mH-this.margin.bottom-this.height;break;case VerAlign.Stretch:y=this.margin.top;break;case VerAlign.Center:y=(mH-this.height)/2+this.margin.top+this.margin.bottom}x+=this.parent.x,y+=this.parent.y,this.x=x,this.y=y,wx=x+w/2+this.padding.left,wy=y+h/2+this.padding.right,graphics.textAlign=TextAlign.Center,graphics.textAlign="center",graphics.textBaseline="middle",this.isPressed?(graphics.fillStyle=this.color.toString(),graphics.fillRoundRect(x,-y,this.width,this.height,this.radius),graphics.strokeStyle=this.color.toString(),graphics.strokeRoundRect(x,-y,this.width,this.height,this.radius),graphics.globalCompositeOperation=Graphics.CompositeOperation.Xor,graphics.fillStyle=this.color.toString(),graphics.fillText(this.content,wx,-wy),graphics.globalCompositeOperation=Graphics.CompositeOperation.SourceOver,graphics.fillStyle=this.bgColor.toString(),graphics.fillText(this.content,wx,-wy)):(graphics.fillStyle=this.bgColor.toString(),graphics.fillRoundRect(x,-y,this.width,this.height,this.radius),graphics.strokeStyle=this.color.toString(),graphics.strokeRoundRect(x,-y,this.width,this.height,this.radius),graphics.fillStyle=this.color.toString(),graphics.fillText(this.content,wx,-wy))},Button.prototype.isPointIn=function(x,y){return this.x<=x&&x<=this.x+this.width&&this.y<=y&&y<=this.y+this.height},Button.prototype.mouseMoveCallback=function(e){this.onMouseMove&&this.onMouseMove(e)},Button.prototype.mouseDownCallback=function(e){this.isPressed=!0,this.onMouseDown&&this.onMouseDown(e)},Button.prototype.mouseUpCallback=function(e){var t=this.isPressed;this.isPressed=!1,t&&this.onMouseUp&&this.onMouseUp(e)},Button.prototype.clickCallback=function(e){this.onClick&&this.onClick(e)},Button.prototype.doubleClickCallback=function(e){this.onClick&&this.onClick(e)},Button.prototype.touchStartCallback=function(e){this.isPressed=!0,this.onTouchStart&&this.onTouchStart(e)},Button.prototype.touchEndCallback=function(e){var t=this.isPressed;this.isPressed=!1,t&&this.onTouchEnd&&this.onTouchEnd(e)},Button.prototype.touchMoveCallback=function(){this.onTouchMove&&this.onTouchMove()},GUI.Button=Button,TextBlock.prototype.copy=function(){var textBlock=new Button(this.text);return textBlock.parent=this.parent,textBlock.width=this.width,textBlock.width=this.width,textBlock.widthAuto=this.widthAuto,textBlock.height=this.height,textBlock.heightAuto=this.heightAuto,textBlock.x=this.x,textBlock.y=this.y,textBlock.margin=this.margin.copy(),textBlock.padding=this.padding.copy(),textBlock.horAlign=this.horAlign,textBlock.verAlign=this.verAlign,textBlock.color=this.color.copy(),textBlock.borderColor=this.borderColor.copy(),textBlock.bgColor=this.bgColor.copy(),textBlock.font=this.font,this.border instanceof Thickness?textBlock.border=this.border.copy():textBlock.border=this.border,this.collider&&this.collider.copy?textBlock.collider=this.collider.copy():textBlock.collider=this.collider,textBlock.onClick=this.onClick,textBlock.onMouseDown=this.onMouseDown,textBlock.onMouseUp=this.onMouseUp,textBlock.onMouseMove=this.onMouseMove,textBlock.onTouchStartthis.onTouchStart,textBlock.onTouchEnd=this.onTouchEnd,textBlock.onTouchMove=this.onTouchMove,textBlock},TextBlock.prototype.render=function(graphics){graphics.font=this.font;var h=1.15*parseInt(this.font.fontSize),w=graphics.measureText(this.text).width,x=0,y=0,wx=0,wy=0,mW=this.parent.width,mH=this.parent.height;switch(this.widthAuto&&(this.horAlign==HorAlign.Stretch?(this.width=mW-this.margin.left-this.margin.right,this.width=this.width<0?0:this.width):(this.width=this.padding.left+w+this.padding.right,this.margin.left+this.width+this.margin.right>mW&&(this.width=mW-this.margin.left-this.margin.right),this.width=this.width<0?0:this.width)),w=this.width-this.padding.left-this.padding.right,w=w<0?0:w,this.horAlign){case HorAlign.Left:x=this.margin.left;break;case HorAlign.Right:x=mW-this.margin.right-this.width;break;case HorAlign.Stretch:x=(mW-this.margin.left-this.margin.right)/2-this.width/2+this.margin.left;break;case HorAlign.Center:x=(mW-this.width)/2+this.margin.left-this.margin.right}switch(this.heightAuto&&(this.verAlign==VerAlign.Stretch?(this.height=mH-this.margin.top-this.margin.bottom,this.height=this.height<0?0:this.height):(this.height=this.padding.top+h+this.padding.bottom,this.margin.top+this.height+this.margin.bottom>mH&&(this.height=mH-this.margin.top-this.margin.bottom),this.height=this.height<0?0:this.height)),h=this.height-this.padding.top-this.padding.bottom,h=h<0?0:h,this.verAlign){case VerAlign.Top:y=this.margin.top;break;case VerAlign.Bottom:y=mH-this.margin.bottom-this.height;break;case VerAlign.Stretch:y=this.margin.top;break;case VerAlign.Center:y=(mH-this.height)/2+this.margin.top+this.margin.bottom}if(x+=this.parent.x,y+=this.parent.y,this.x=x,this.y=y,wx=x+w/2+this.padding.left,wy=y+h/2+this.padding.right,this.onRender){var args={target:this,x:x,y:y,width:w,height:h,cancle:!1};if(this.onRender(args),args.cancle)return;w=args.width,h=args.height,wx=args.x,wy=args.y}graphics.textAlign=TextAlign.Center,graphics.font=this.font,graphics.fillStyle=this.bgColor.toString(),graphics.strokeStyle=this.borderColor.toString(),graphics.lineCap=Graphics.LineCap.Butt,this.border.top>0&&(graphics.lineWidth=this.border.top,graphics.drawLine(x,-y,x+this.width,-y)),this.border.right>0&&(graphics.lineWidth=this.border.right,graphics.drawLine(x+this.width,-y,x+this.width,-(y+this.height))),this.border.bottom>0&&(graphics.lineWidth=this.border.bottom,graphics.drawLine(x+this.width,-(y+this.height),x,-(y+this.height))),this.border.left>0&&(graphics.lineWidth=this.border.left,graphics.drawLine(x,-(y+this.height),x,-y)),graphics.fillStyle=this.color.toString(),graphics.textAlign="center",graphics.textBaseline="middle",graphics.fillText(this.text,wx,wy)},TextBlock.prototype.isPointIn=function(x,y){return this.x<=x&&x<=this.x+this.width&&this.y<=y&&y<=this.y+this.height},TextBlock.prototype.mouseDownCallback=function(){},TextBlock.prototype.mouseUpCallback=function(){},TextBlock.prototype.clickCallback=function(){},TextBlock.prototype.touchStartCallback=function(){},TextBlock.prototype.touchEndCallback=function(){},TextBlock.prototype.touchMoveCallback=function(){},GUI.TextBlock=TextBlock,GUI.Joystick=Joystick,Engine}(window.SarEngine);